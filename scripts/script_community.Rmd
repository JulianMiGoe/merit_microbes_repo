---
title: "Community Analysis of MERIT Microbes - RNA Data"
author: "Julian Mittmann-Goetsch"
date: "2025-01-31"
output: pdf_document
---

## Version 2.1: Removed robustlmm analysis, updated version log - 17.07.2025 | JM
## Version 2.0: Unified script structure, English comments, hierarchical naming - 06.06.2025 | JM
## Version 1.7: DESeq2 Analysis of RNA data - 18.01.2025 | JM
## Version 1.6: Compositional analysis via clr transformation - 19.11.2024 | JM
## Version 1.5: Tax4Fun2 included, changes to script style - 25.07.2024 | JM
## Version 1.4: NMDS plots, stacked bar charts - 14.02.2024 | JM
## Version 1.3: RNA data analysis - 01.02.2024 | JM
## Version 1.2: Included cDNA concentrations and decision plot for re-extraction - 14.12.2023 | JM
## Version 1.1: Include jpg. images of Gels and TapeStation - 27.11.2023 | JM
## Version 1.0: Display DNA and RNA concentrations - 24.11.2023 | JM


# Step 1: Prepare session and load data
## Step 1a: Install necessary packages
```{r, message=FALSE, warning=FALSE}
#### Install packages ####
#install.packages("DT")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("ggpmisc")
#install.packages("ggpubr")
#install.packages("lme4")
#install.packages("performance")
#install.packages("phyloseq")
#install.packages("RColorBrewer")
#install.packages("tidyverse")
#install.packages("vegan")
#install.packages("microViz")
```

## Step 1b: Load necessary packages
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(emmeans)
library(ggplot2)
library(ggpmisc)
library(ggpubr)
library(lme4)
library(microViz)
library(performance)
library(phyloseq)
library(RColorBrewer)
library(tidyverse)
library(vegan)
```

## Step 1c: Load sequencing data
This dataset is based on soil samples from the MERIT whole-ecosystem warming experiment located in a Wadden Sea salt marsh (Hamburger Hallig, Schleswig Holstein).
```{r,  message=FALSE, warning=FALSE}
# Set working directory
setwd("C:/Users/Bat1638/Documents/repositories/merit_microbes_repo")

# Load metadata
df_metadata_0_raw <- read.csv("./data/metadata.csv", dec = ",", sep= ";")

# Load RNA sequencing data (raw and filtered)
df_asv_0_raw <- read.csv("./data/rna/table_ASV_filtered.csv", dec = ",", sep = ";")
df_tab_0_raw <- read.delim("./data/rna/table_ASV_filtered_taxMerge.txt", dec = ".", sep= "\t")
df_seq_0_raw <- read.csv("./data/rna/table_sequences_asvNames_filtered.csv", dec=",", sep=";")

# Load rarefied sequencing data
df_tab_rare_0_raw <- read.csv("./data/rna/table_ASV_filtered_rarefied_5000.csv", dec = ",", sep = ";")

# Load family level counts
df_tab_fam_0_raw <- read.csv("./data/rna/taxa_sum_Family.csv", dec = ".", sep = ";")

# Load elevation data
df_elevation_0_raw <- read.delim("./data/elevation/df_iris_elevation.txt", dec = ".", sep= "\t")

# Load IRIS reduction index data
df_iris_0_summary <- read.csv("./data/iris/df_iris_summary.csv", dec = ".", sep = ",")

# Load external warming data (generated with script_warming_data_2022.Rmd)
df_warming_monthly_0_raw <- read.csv("./scripts/df_warming_all_2022_monthly.csv", dec = ".", sep = ",")
df_warming_weekly_0_raw <- read.csv("./scripts/df_warming_all_2022_weekly.csv", dec = ".", sep = ",")
df_warming_yearly_0_raw <- read.csv("./scripts/df_warming_all_2022_yearly.csv", dec = ".", sep = ",")
```
\pagebreak

## Step 1d: Define plot theme
```{r message=FALSE, warning=FALSE}
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

# Step 2: Data preprocessing
## Step 2a: Create phyloseq objects
```{r}
# Prepare metadata with hierarchical naming
df_metadata_1_processed <- df_metadata_0_raw %>%
  mutate_at(c(3:12), as.factor)

df_samp_1_processed <- sample_data(df_metadata_1_processed) 
sample_ids <- df_metadata_1_processed[, 1]
rownames(df_samp_1_processed) <- sample_ids

# Create phyloseq object with raw data (used for clr transformation)
ps_raw_1_processed <- phyloseq(
    otu_table(as.matrix(df_tab_0_raw[,1:(ncol(df_tab_0_raw)-6)]), taxa_are_rows=T),
    tax_table(as.matrix(df_tab_0_raw[,(ncol(df_tab_0_raw)-5):ncol(df_tab_0_raw)])),
    sample_data(df_samp_1_processed)
   )

# Remove MOCK samples and negative controls
samples_to_remove <- c("X136", "X137", "X138", "X139")
ps_raw_2_filtered <- subset_samples(ps_raw_1_processed, !(sample_names(ps_raw_1_processed) %in% samples_to_remove))

# Add layer column based on depth
sample_data_df <- as(sample_data(ps_raw_2_filtered), "data.frame")
sample_data_df <- sample_data_df %>%
  mutate(Layer = case_when(
    Depth %in% c("0-5 cm", "5-10 cm", "20-30 cm") ~ "Topsoil (0-30 cm)",
    Depth %in% c("40-50 cm", "80-100 cm") ~ "Subsoil (40-100 cm)",
    TRUE ~ NA_character_
  ))

# Update sample data in phyloseq object
sample_data(ps_raw_2_filtered) <- sample_data(sample_data_df)

# Reorder factors for consistent plotting
ps_raw_2_filtered@sam_data[["Zone"]] <- dplyr::recode(ps_raw_2_filtered@sam_data[["Zone"]],
  "PZ" = "Pioneer zone", "LM" = "Low marsh", "HM" = "High marsh"
)
ps_raw_2_filtered@sam_data[["Zone"]] <- factor(ps_raw_2_filtered@sam_data[["Zone"]], 
                                              levels = c("Pioneer zone","Low marsh","High marsh"))
ps_raw_2_filtered@sam_data[["Treatment"]] <- recode_factor(ps_raw_2_filtered@sam_data[["Treatment"]], 
                                                          "0" = "ambient", "1.5" = "+1.5°C", "3" = "+3.0°C")
ps_raw_2_filtered@sam_data[["Depth"]] <- factor(ps_raw_2_filtered@sam_data[["Depth"]],
                                                levels=c("0-5 cm", "5-10 cm", "20-30 cm", "40-50 cm", "80-100 cm"))
ps_raw_2_filtered@sam_data[["Layer"]] <- factor(ps_raw_2_filtered@sam_data[["Layer"]],
                                                levels=c("Topsoil (0-30 cm)","Subsoil (40-100 cm)"))

# Create phyloseq object with rarefied data (used for NMDS plots)
ps_rare_1_processed <- phyloseq(
    otu_table(as.matrix(df_tab_rare_0_raw[,2:(ncol(df_tab_rare_0_raw)-6)]), taxa_are_rows=T),
    tax_table(as.matrix(df_tab_rare_0_raw[,(ncol(df_tab_rare_0_raw)-5):ncol(df_tab_rare_0_raw)])),
    sample_data(df_samp_1_processed)
   )

# Remove MOCK samples and negative controls
ps_rare_2_filtered <- subset_samples(ps_rare_1_processed, !(sample_names(ps_rare_1_processed) %in% samples_to_remove))

# Add layer column for rarefied data
sample_data_rare <- as(sample_data(ps_rare_2_filtered), "data.frame")
sample_data_rare <- sample_data_rare %>%
  mutate(Layer = case_when(
    Depth %in% c("0-5 cm", "5-10 cm", "20-30 cm") ~ "Topsoil (0-30 cm)",
    Depth %in% c("40-50 cm", "80-100 cm") ~ "Subsoil (40-100 cm)",
    TRUE ~ NA_character_
  ))

# Update sample data for rarefied phyloseq object
sample_data(ps_rare_2_filtered) <- sample_data(sample_data_rare)

# Reorder factors for rarefied data
ps_rare_2_filtered@sam_data[["Zone"]] <- dplyr::recode(ps_rare_2_filtered@sam_data[["Zone"]],
  "PZ" = "Pioneer zone", "LM" = "Low marsh", "HM" = "High marsh"
)
ps_rare_2_filtered@sam_data[["Zone"]] <- factor(ps_rare_2_filtered@sam_data[["Zone"]], 
                                               levels = c("Pioneer zone","Low marsh","High marsh"))
ps_rare_2_filtered@sam_data[["Treatment"]] <- recode_factor(ps_rare_2_filtered@sam_data[["Treatment"]], 
                                                           "0" = "ambient", "1.5" = "+1.5°C", "3" = "+3.0°C")
ps_rare_2_filtered@sam_data[["Depth"]] <- factor(ps_rare_2_filtered@sam_data[["Depth"]],
                                                 levels=c("0-5 cm", "5-10 cm", "20-30 cm", "40-50 cm", "80-100 cm"))
ps_rare_2_filtered@sam_data[["Layer"]] <- factor(ps_rare_2_filtered@sam_data[["Layer"]],
                                                 levels=c("Topsoil (0-30 cm)","Subsoil (40-100 cm)"))
```

## Step 2b: NMDS ordination plots
```{r}
# Create layer labels for faceting
layer.labs <- c(
  "Topsoil (0-30 cm)" = "Topsoil\n(0-30 cm)",
  "Subsoil (40-100 cm)" = "Subsoil\n(40-100 cm)"
)

# Generate NMDS plot for all treatments and layers
plot_nmds_all_treatment_layer <- ps_rare_2_filtered %>%
  tax_transform(rank = "unique", trans = "identity") %>%
  dist_calc(dist = "bray") %>%
  ord_calc(method = "NMDS") %>% 
  ord_plot(
    axes = c(1, 2),
    colour = "Treatment", fill = "Treatment",
    shape = "Zone", alpha = 0.5, size = 2
  ) + 
  scale_shape_girafe_filled() +
  stat_chull(
    ggplot2::aes(group = Treatment, fill = Treatment, colour = Treatment),
    geom = "polygon", alpha = 0.7
  ) +
  scale_colour_manual(
    values = c("#4575B4", "#FDAE61", "#D73027"), 
    name = "Warming treatment:"
  ) +
  scale_fill_manual(
    values = c("#4575B4", "#FDAE61", "#D73027"), 
    name = "Warming treatment:"
  ) +
  facet_grid(rows = vars(Layer), cols = vars(Zone), labeller = labeller(Layer = layer.labs)) +
  theme_JM +
  theme(strip.text.y.left = element_text(angle = 0, hjust = 0.5, vjust = 0.5, size = 12),
        strip.placement = "outside") +
  labs(subtitle = NULL, caption = NULL)

plot_nmds_all_treatment_layer
```

# Step 3: Community statistics
## Step 3a: PERMANOVA analysis using Bray-Curtis dissimilarity
```{r}
# Convert phyloseq object to distance matrix
dist_matrix_1_processed <- phyloseq::distance(ps_rare_2_filtered, method = "bray")

# Extract sample data
df_sample_data_1_processed <- data.frame(sample_data(ps_rare_2_filtered))

# Perform main PERMANOVA
stat_permanova_bray_1_main <- adonis2(dist_matrix_1_processed ~ Zone * Layer * Treatment, 
                                     data = df_sample_data_1_processed, by = "terms")

# Perform pairwise comparisons for main factors
#stat_pairwise_bray_zone_1_main <- pairwise.adonis2(dist_matrix_1_processed ~ Zone, 
#                                                   data = df_sample_data_1_processed, p.adjust.m = "holm")
#stat_pairwise_bray_layer_1_main <- pairwise.adonis2(dist_matrix_1_processed ~ Layer, 
#                                                    data = df_sample_data_1_processed, p.adjust.m = "holm")
#stat_pairwise_bray_treatment_1_main <- pairwise.adonis2(dist_matrix_1_processed ~ Treatment, 
#                                                       data = df_sample_data_1_processed, p.adjust.m = "holm")
```

# Step 4: Taxonomic composition analysis
## Step 4a: Create relative abundance plots at phylum level
```{r}
# Create phyloseq object with relative abundances at phylum level
ps_phylum_rel_1_processed <- ps_rare_2_filtered %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) x / sum(x))

# Get top 9 phyla names
top_phyla <- tax_table(ps_phylum_rel_1_processed)[names(sort(taxa_sums(ps_phylum_rel_1_processed), 
                                                            decreasing = TRUE)[1:9]), "Phylum"]

# Create abundance data for topsoil samples
df_abundance_topsoil_1_processed <- ps_phylum_rel_1_processed %>%
  psmelt() %>%
  mutate(Phylum = tax_table(ps_phylum_rel_1_processed)[OTU, "Phylum"]) %>%
  mutate(Phylum = case_when(
    Phylum %in% top_phyla ~ as.character(Phylum),
    TRUE ~ "Others"
  )) %>%
  filter(Layer == "Topsoil (0-30 cm)") %>%
  group_by(Zone, Treatment, Phylum) %>%
  summarise(Abundance = mean(Abundance), .groups = "drop") %>%  
  group_by(Zone, Treatment) %>%
  mutate(Abundance = Abundance / sum(Abundance)) %>%
  ungroup()

# Create abundance data for subsoil samples
df_abundance_subsoil_1_processed <- ps_phylum_rel_1_processed %>%
  psmelt() %>%
  mutate(Phylum = tax_table(ps_phylum_rel_1_processed)[OTU, "Phylum"]) %>%
  mutate(Phylum = case_when(
    Phylum %in% top_phyla ~ as.character(Phylum),
    TRUE ~ "Others"
  )) %>%
  filter(Layer == "Subsoil (40-100 cm)") %>%
  group_by(Zone, Treatment, Phylum) %>%
  summarise(Abundance = mean(Abundance), .groups = "drop") %>%  
  group_by(Zone, Treatment) %>%
  mutate(Abundance = Abundance / sum(Abundance)) %>%
  ungroup()

# Set factor levels for consistent ordering
phylum_levels <- c("Gemmatimonadota", "Myxococcota", "Actinobacteriota", 
                   "Planctomycetota", "Acidobacteriota", "Desulfobacterota", 
                   "Firmicutes", "Chloroflexi", "Proteobacteria", "Others")

df_abundance_topsoil_1_processed$Phylum <- factor(df_abundance_topsoil_1_processed$Phylum, 
                                                 levels = phylum_levels)
df_abundance_subsoil_1_processed$Phylum <- factor(df_abundance_subsoil_1_processed$Phylum, 
                                                 levels = phylum_levels)

# Create color palette
color_palette <- c("#D73027", "#FDAE61", "#ffff99", "#b2df8a", "#33a02c", 
                  "#cab2d6", "#1f78b4", "#a6cee3", "black", "grey")

# Generate stacked bar plots
plot_stacked_bar_topsoil_2_final <- ggplot(df_abundance_topsoil_1_processed, 
                                           aes(x = Treatment, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = color_palette) +
  theme_JM +
  labs(y = "Relative Abundance [%]") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.25), 
                   labels = seq(0, 100, by = 25)) +
  facet_wrap(~ Zone) +
  theme(legend.position = "none")

plot_stacked_bar_subsoil_2_final <- ggplot(df_abundance_subsoil_1_processed, 
                                          aes(x = Treatment, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = color_palette) +
  theme_JM +
  labs(y = "Relative Abundance [%]") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.25), 
                   labels = seq(0, 100, by = 25)) +
  facet_wrap(~ Zone) +
  theme(legend.position = "none")

# Combine plots
plot_barplot_combined_2_final <- ggarrange(plot_stacked_bar_topsoil_2_final, 
                                          plot_stacked_bar_subsoil_2_final,
                                          labels = c("A", "B"), 
                                          ncol = 1,
                                          common.legend = TRUE,
                                          legend = "top")

# Add layer labels
plot_barplot_combined_2_final <- annotate_figure(plot_barplot_combined_2_final,
                                                right = textGrob(c("Topsoil (0-30 cm)", 
                                                                  "Subsoil (40-100 cm)"), 
                                                                x = c(0.5, 0.5),
                                                                y = c(0.7, 0.25),  
                                                                rot = 270,
                                                                gp = gpar(fontsize = 12, fontface = "bold")))

plot_barplot_combined_2_final

# Export high-resolution figures for publication
# Create output directory if it doesn't exist
if (!dir.exists(here("output"))) {
  dir.create(here("output"), recursive = TRUE)
}

# Export high-resolution TIFF file for publication
  tiff(here("output", "plot_barplot_combined_2_final.tiff"), 
       width = 12, height = 10, units = "in", res = 600, compression = "lzw")
  print(plot_barplot_combined_2_final)
  dev.off()
  
  tiff(here("output", "Featured_image_Mittmann-Goetsch.tiff"), 
       width = 12, height = 6.7, units = "in", res = 600, compression = "lzw")
  print(plot_barplot_combined_2_final)
  dev.off()
  
# Also save as EPS for vector graphics option
postscript(here("output", "plot_barplot_combined_2_final.eps"), 
           width = 12, height = 10, horizontal = FALSE)
print(plot_barplot_combined_2_final)
dev.off()

cat("High-resolution figures saved:\n")
cat("- plot_barplot_combined_2_final.tiff (600 DPI)\n")
cat("- plot_barplot_combined_2_final.eps (vector)\n")
```

# Step 5: Alpha diversity analysis
## Step 5a: Calculate alpha diversity metrics
```{r}
# Calculate Shannon diversity index
df_alpha_div_1_processed <- estimate_richness(ps_rare_2_filtered, measures = c("Shannon"))

# Add metadata to alpha diversity data
df_alpha_div_1_processed <- df_alpha_div_1_processed %>% 
  rownames_to_column(var = "sample_name")

df_alpha_div_2_merged <- df_alpha_div_1_processed %>%
  left_join(df_metadata_0_raw, by = "sample_name")

# Transform to long format for analysis
df_alpha_div_3_long <- df_alpha_div_2_merged %>%
  pivot_longer(cols = c("Shannon"), names_to = "Metric", values_to = "Value") %>%
  mutate(Layer = case_when(
    Depth %in% c("0-5 cm", "5-10 cm", "20-30 cm") ~ "Topsoil\n(0-30 cm)",
    Depth %in% c("40-50 cm", "80-100 cm") ~ "Subsoil\n(40-100 cm)",
    TRUE ~ NA_character_
  ))

# Recode treatment and zone factors
df_alpha_div_3_long$Treatment <- recode_factor(df_alpha_div_3_long$Treatment, 
                                              "0" = "ambient", "1.5" = "+1.5°C", "3" = "+3.0°C")
df_alpha_div_3_long$Zone <- dplyr::recode(df_alpha_div_3_long$Zone,
  "PZ" = "Pioneer zone", "LM" = "Low marsh", "HM" = "High marsh")
df_alpha_div_3_long$Zone <- factor(df_alpha_div_3_long$Zone, 
                                  levels = c("Pioneer zone", "Low marsh", "High marsh"))
df_alpha_div_3_long$Layer <- factor(df_alpha_div_3_long$Layer, 
                                   levels = c("Topsoil\n(0-30 cm)", "Subsoil\n(40-100 cm)"))

# Create alpha diversity plot
plot_alpha_div_zone_treatment_layer_2_final <- ggplot(df_alpha_div_3_long, 
                                                      aes(x = Zone, y = Value, fill = Treatment)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, position = position_dodge(width = 0.8), width = 0.6) +  
  geom_jitter(position = position_jitterdodge(jitter.width = 0.3, dodge.width = 0.8), 
              alpha = 0.7, aes(colour = Treatment), size = 2) +  
  scale_colour_manual(values = c("#4575B4", "#FDAE61", "#D73027"), name = "Warming treatment:") +
  scale_fill_manual(values = c("#4575B4", "#FDAE61", "#D73027"), name = "Warming treatment:") +
  theme_JM +
  theme(legend.position = "bottom") +
  labs(x = "Zone", y = "Alpha Diversity (Shannon Index)") +
  facet_grid(rows = vars(Layer)) 

# Combine alpha diversity plot with NMDS plot
plot_alpha_nmds_2_final <- ggarrange(
  ggarrange(
    plot_alpha_div_zone_treatment_layer_2_final + theme(legend.position = "top"),
    plot_nmds_all_treatment_layer + theme(legend.position = "none"), 
    ncol = 2,
    labels = c("A", "B")),
    nrow = 1,
    heights = c(1.5, 2)
)

plot_alpha_nmds_2_final

# Export high-resolution figures for publication
# Create output directory if it doesn't exist
if (!dir.exists(here("output"))) {
  dir.create(here("output"), recursive = TRUE)
}

# Export high-resolution TIFF file for publication
tiff(here("output", "plot_alpha_nmds_2_final.tiff"), 
     width = 14, height = 8, units = "in", res = 600, compression = "lzw")
print(plot_alpha_nmds_2_final)
dev.off()

# Also save as EPS for vector graphics option
postscript(here("output", "plot_alpha_nmds_2_final.eps"), 
           width = 14, height = 8, horizontal = FALSE)
print(plot_alpha_nmds_2_final)
dev.off()

cat("High-resolution figures saved:\n")
cat("- plot_alpha_nmds_2_final.tiff (600 DPI)\n")
cat("- plot_alpha_nmds_2_final.eps (vector)\n")
```

## Step 5b: Alpha diversity statistical analysis
```{r}
# Fit linear mixed-effects model with Plot as random effect
stat_model_alpha_1_main <- lmer(Value ~ Treatment * Zone * Layer + (1|Plot), 
                               data = df_alpha_div_3_long)

# Model diagnostics
check_model(stat_model_alpha_1_main)

# Test for normality of residuals
stat_shapiro_alpha_1_main <- shapiro.test(resid(stat_model_alpha_1_main))

# ANOVA results
stat_anova_alpha_1_main <- anova(stat_model_alpha_1_main)

# Pairwise comparisons using emmeans
stat_alpha_zone_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Zone)
stat_alpha_zone_pairs_1_main <- pairs(stat_alpha_zone_emm_1_main)

stat_alpha_treatment_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Treatment)
stat_alpha_treatment_pairs_1_main <- pairs(stat_alpha_treatment_emm_1_main)

stat_alpha_layer_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Layer)
stat_alpha_layer_pairs_1_main <- pairs(stat_alpha_layer_emm_1_main)

# Interaction comparisons
stat_alpha_zone_treatment_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Zone * Treatment)
stat_alpha_zone_treatment_pairs_1_main <- pairs(stat_alpha_zone_treatment_emm_1_main)

stat_alpha_zone_layer_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Zone * Layer)
stat_alpha_zone_layer_pairs_1_main <- pairs(stat_alpha_zone_layer_emm_1_main)

stat_alpha_treatment_layer_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Treatment * Layer)
stat_alpha_treatment_layer_pairs_1_main <- pairs(stat_alpha_treatment_layer_emm_1_main)

stat_alpha_treatment_layer_zone_emm_1_main <- emmeans(stat_model_alpha_1_main, ~ Treatment * Layer * Zone)
stat_alpha_treatment_layer_zone_pairs_1_main <- pairs(stat_alpha_treatment_layer_zone_emm_1_main)
```


# Step 6: Environmental dissimilarity analysis
## Step 6a: Calculate community dissimilarities by layer
```{r}
# Filter phyloseq objects by soil layer
ps_topsoil_1_processed <- subset_samples(ps_rare_2_filtered, Layer == "Topsoil (0-30 cm)")
ps_subsoil_1_processed <- subset_samples(ps_rare_2_filtered, Layer == "Subsoil (40-100 cm)")

# Calculate Bray-Curtis distances for each layer
stat_bray_curtis_topsoil_1_processed <- phyloseq::distance(ps_topsoil_1_processed, method = "bray")
stat_bray_curtis_subsoil_1_processed <- phyloseq::distance(ps_subsoil_1_processed, method = "bray")

# Convert distance matrices to data frames
df_bray_curtis_topsoil_1_processed <- as.data.frame(as.matrix(stat_bray_curtis_topsoil_1_processed)) %>%
  rownames_to_column(var = "sample_name") %>%
  pivot_longer(cols = -sample_name, names_to = "comparison", values_to = "BrayCurtisDissimilarity")

df_bray_curtis_subsoil_1_processed <- as.data.frame(as.matrix(stat_bray_curtis_subsoil_1_processed)) %>%
  rownames_to_column(var = "sample_name") %>%
  pivot_longer(cols = -sample_name, names_to = "comparison", values_to = "BrayCurtisDissimilarity")

# Merge with metadata for topsoil
df_bray_curtis_topsoil_2_merged <- df_bray_curtis_topsoil_1_processed %>%
  left_join(df_metadata_0_raw, by = "sample_name") %>%
  dplyr::rename(plotid1 = Plot, depth1 = Depth, zone1 = Zone) %>%
  left_join(df_metadata_0_raw, by = c("comparison" = "sample_name")) %>%
  dplyr::rename(plotid2 = Plot, depth2 = Depth, zone2 = Zone) %>%
  filter(depth1 == depth2) %>%
  dplyr::select(sample_name, comparison, depth1, depth2, plotid1, plotid2, zone1, zone2, BrayCurtisDissimilarity)

# Merge with metadata for subsoil
df_bray_curtis_subsoil_2_merged <- df_bray_curtis_subsoil_1_processed %>%
  left_join(df_metadata_0_raw, by = "sample_name") %>%
  dplyr::rename(plotid1 = Plot, depth1 = Depth, zone1 = Zone) %>%
  left_join(df_metadata_0_raw, by = c("comparison" = "sample_name")) %>%
  dplyr::rename(plotid2 = Plot, depth2 = Depth, zone2 = Zone) %>%
  filter(depth1 == depth2) %>%
  dplyr::select(sample_name, comparison, depth1, depth2, plotid1, plotid2, zone1, zone2, BrayCurtisDissimilarity)
```


## Step 6b: Calculate temperature deltas between plots
```{r}
# Create pairwise temperature deltas from monthly warming data
df_plot_pairs_1_processed <- expand.grid(
  plotid1 = unique(df_warming_monthly_0_raw$plotid),
  plotid2 = unique(df_warming_monthly_0_raw$plotid)
) %>%
  filter(plotid1 != plotid2)

df_warming_delta_1_processed <- df_plot_pairs_1_processed %>%
  left_join(df_warming_monthly_0_raw, by = c("plotid1" = "plotid")) %>%
  dplyr::rename(surfaceTemp1 = surfaceTemp_mean, pinTemp1 = pinTemp_mean, deepTemp1 = deepTemp_mean) %>%
  left_join(df_warming_monthly_0_raw, by = c("plotid2" = "plotid")) %>%
  dplyr::rename(surfaceTemp2 = surfaceTemp_mean, pinTemp2 = pinTemp_mean, deepTemp2 = deepTemp_mean) %>%
  mutate(
    delta_surfaceTemp = abs(surfaceTemp1 - surfaceTemp2),
    delta_pinTemp = abs(pinTemp1 - pinTemp2),
    delta_deepTemp = abs(deepTemp1 - deepTemp2)
  ) %>%
  dplyr::select(plotid1, plotid2, delta_surfaceTemp, delta_pinTemp, delta_deepTemp)

df_warming_delta_1_processed$plotid1 <- as.factor(df_warming_delta_1_processed$plotid1)
df_warming_delta_1_processed$plotid2 <- as.factor(df_warming_delta_1_processed$plotid2)
```


## Step 6c: Calculate elevation deltas between plots
```{r}
# Calculate mean elevation per plot
df_elevation_mean_1_processed <- df_elevation_0_raw %>%
  group_by(Plot) %>%
  summarise(elevation_mean = mean(Elevation), .groups = "drop")

# Create pairwise elevation deltas
df_plot_pairs_elevation_1_processed <- expand.grid(
  plotid1 = unique(df_elevation_mean_1_processed$Plot),
  plotid2 = unique(df_elevation_mean_1_processed$Plot)
) %>%
  filter(plotid1 != plotid2)

df_elevation_delta_1_processed <- df_plot_pairs_elevation_1_processed %>%
  left_join(df_elevation_mean_1_processed, by = c("plotid1" = "Plot")) %>%
  dplyr::rename(elevation1 = elevation_mean) %>%
  left_join(df_elevation_mean_1_processed, by = c("plotid2" = "Plot")) %>%
  dplyr::rename(elevation2 = elevation_mean) %>%
  mutate(delta_elevation = abs(elevation1 - elevation2)) %>%
  dplyr::select(plotid1, plotid2, delta_elevation)

df_elevation_delta_1_processed$plotid1 <- as.factor(df_elevation_delta_1_processed$plotid1)
df_elevation_delta_1_processed$plotid2 <- as.factor(df_elevation_delta_1_processed$plotid2)
```

## Step 6d: Calculate reduction index deltas between plots
```{r}
# Calculate mean reduction index per plot and layer
df_ri_mean_1_processed <- df_iris_0_summary %>%
  mutate(Plot = as.character(Plot)) %>%
  dplyr::select(Plot, Layer, ri)
```



## Step 6e: Merge environmental data with community dissimilarities
```{r}
# Merge topsoil dissimilarities with temperature data
df_bray_curtis_topsoil_2_merged$plotid1 <- as.factor(df_bray_curtis_topsoil_2_merged$plotid1)
df_bray_curtis_topsoil_2_merged$plotid2 <- as.factor(df_bray_curtis_topsoil_2_merged$plotid2)

df_bray_curtis_subsoil_2_merged$plotid1 <- as.factor(df_bray_curtis_subsoil_2_merged$plotid1)
df_bray_curtis_subsoil_2_merged$plotid2 <- as.factor(df_bray_curtis_subsoil_2_merged$plotid2)


df_bray_delta_topsoil_1_processed <- df_bray_curtis_topsoil_2_merged %>%
  left_join(df_warming_delta_1_processed, by = c("plotid1", "plotid2")) %>%
  left_join(df_warming_delta_1_processed, by = c("plotid2" = "plotid1", "plotid1" = "plotid2"), 
           suffix = c("", "_rev")) %>%
  mutate(
    delta_surfaceTemp = coalesce(delta_surfaceTemp, delta_surfaceTemp_rev),
    delta_pinTemp = coalesce(delta_pinTemp, delta_pinTemp_rev),
    delta_deepTemp = coalesce(delta_deepTemp, delta_deepTemp_rev)
  ) %>%
  dplyr::select(sample_name, comparison, plotid1, plotid2, BrayCurtisDissimilarity, 
         delta_deepTemp, delta_pinTemp, delta_surfaceTemp, zone1, zone2) %>%
  rowwise() %>%
  mutate(sorted_plotids = paste(sort(c(plotid1, plotid2)), collapse = "_")) %>%
  ungroup() %>%
  distinct(sorted_plotids, BrayCurtisDissimilarity, .keep_all = TRUE) %>%
  dplyr::select(-sorted_plotids)

# Merge subsoil dissimilarities with temperature data
df_bray_delta_subsoil_1_processed <- df_bray_curtis_subsoil_2_merged %>%
  left_join(df_warming_delta_1_processed, by = c("plotid1", "plotid2")) %>%
  left_join(df_warming_delta_1_processed, by = c("plotid2" = "plotid1", "plotid1" = "plotid2"), 
           suffix = c("", "_rev")) %>%
  mutate(
    delta_surfaceTemp = coalesce(delta_surfaceTemp, delta_surfaceTemp_rev),
    delta_pinTemp = coalesce(delta_pinTemp, delta_pinTemp_rev),
    delta_deepTemp = coalesce(delta_deepTemp, delta_deepTemp_rev)
  ) %>%
  dplyr::select(sample_name, comparison, plotid1, plotid2, BrayCurtisDissimilarity, 
         delta_deepTemp, delta_pinTemp, delta_surfaceTemp, zone1, zone2) %>%
  rowwise() %>%
  mutate(sorted_plotids = paste(sort(c(plotid1, plotid2)), collapse = "_")) %>%
  ungroup() %>%
  distinct(sorted_plotids, BrayCurtisDissimilarity, .keep_all = TRUE) %>%
  dplyr::select(-sorted_plotids)

# Merge with elevation data for topsoil
df_bray_delta_topsoil_elevation_1_processed <- df_bray_curtis_topsoil_2_merged %>%
  left_join(df_elevation_delta_1_processed, by = c("plotid1", "plotid2")) %>%
  left_join(df_elevation_delta_1_processed, by = c("plotid2" = "plotid1", "plotid1" = "plotid2"), 
           suffix = c("", "_rev")) %>%
  mutate(delta_elevation = coalesce(delta_elevation, delta_elevation_rev)) %>%
  dplyr::select(sample_name, comparison, plotid1, plotid2, BrayCurtisDissimilarity, delta_elevation, zone1, zone2) %>%
  rowwise() %>%
  mutate(sorted_plotids = paste(sort(c(plotid1, plotid2)), collapse = "_")) %>%
  ungroup() %>%
  distinct(sorted_plotids, BrayCurtisDissimilarity, .keep_all = TRUE) %>%
  dplyr::select(-sorted_plotids)

# Merge with elevation data for subsoil
df_bray_delta_subsoil_elevation_1_processed <- df_bray_curtis_subsoil_2_merged %>%
  left_join(df_elevation_delta_1_processed, by = c("plotid1", "plotid2")) %>%
  left_join(df_elevation_delta_1_processed, by = c("plotid2" = "plotid1", "plotid1" = "plotid2"), 
           suffix = c("", "_rev")) %>%
  mutate(delta_elevation = coalesce(delta_elevation, delta_elevation_rev)) %>%
  dplyr::select(sample_name, comparison, plotid1, plotid2, BrayCurtisDissimilarity, delta_elevation, zone1, zone2) %>%
  rowwise() %>%
  mutate(sorted_plotids = paste(sort(c(plotid1, plotid2)), collapse = "_")) %>%
  ungroup() %>%
  distinct(sorted_plotids, BrayCurtisDissimilarity, .keep_all = TRUE) %>%
  dplyr::select(-sorted_plotids)

```

## Step 6f: Environmental dissimilarity plots and statistics
```{r}
# Temperature dissimilarity plots for topsoil
plot_bray_delta_topsoil_surface_2_final <- df_bray_delta_topsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_surfaceTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta monthly T at 2 cm depth [°C]") +
  ylab("Dissimilarity") +
  ggtitle("Topsoil (0-30 cm)")

plot_bray_delta_topsoil_pin_2_final <- df_bray_delta_topsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_pinTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM + 
  xlab("Delta monthly T at 25 cm depth [°C]") +
  ylab("Dissimilarity")

plot_bray_delta_topsoil_deep_2_final <- df_bray_delta_topsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_deepTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM+
  xlab("Delta monthly T at 75 cm depth [°C]") +
  ylab("Dissimilarity")

# Temperature dissimilarity plots for subsoil
plot_bray_delta_subsoil_surface_2_final <- df_bray_delta_subsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_surfaceTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta monthly T at 2 cm depth [°C]") +
  ylab("Dissimilarity")

plot_bray_delta_subsoil_pin_2_final <- df_bray_delta_subsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_pinTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta monthly T at 25 cm depth [°C]") +
  ylab("Dissimilarity")

plot_bray_delta_subsoil_deep_2_final <- df_bray_delta_subsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_deepTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta monthly T at 75 cm depth [°C]") +
  ylab("Dissimilarity") +
  ggtitle("Subsoil (40-100 cm)")

# Elevation dissimilarity plots
plot_bray_delta_topsoil_elevation_2_final <- df_bray_delta_topsoil_elevation_1_processed %>%
  ggplot(aes(x = delta_elevation, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta elevation [cm]") +
  ylab("Dissimilarity") +
  ggtitle("Topsoil (0-30 cm)")

plot_bray_delta_subsoil_elevation_2_final <- df_bray_delta_subsoil_elevation_1_processed %>%
  ggplot(aes(x = delta_elevation, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta elevation [cm]") +
  ylab("Dissimilarity") +
  ggtitle("Subsoil (40-100 cm)")

# Arrange temperature plots
plot_temperature_combined_2_final <- ggarrange(plot_bray_delta_topsoil_surface_2_final, 
                                              plot_bray_delta_topsoil_pin_2_final, 
                                              plot_bray_delta_topsoil_deep_2_final,
                                              plot_bray_delta_subsoil_surface_2_final, 
                                              plot_bray_delta_subsoil_pin_2_final, 
                                              plot_bray_delta_subsoil_deep_2_final,
                                              ncol = 3, nrow = 2)

# Arrange elevation plots
plot_elevation_combined_2_final <- ggarrange(plot_bray_delta_topsoil_elevation_2_final, 
                                            plot_bray_delta_subsoil_elevation_2_final, 
                                            ncol = 1, nrow = 2)

# Display plots
plot_temperature_combined_2_final
plot_elevation_combined_2_final
```

## Step 6g: Alternative RI analysis with different data structure
```{r}
# Calculate mean ri per plot and layer
# (Assumes df_iris is already loaded with columns: plotid, Layer, ri)
df_ri_mean <- df_iris_0_summary %>%
  group_by(Plot, Layer) %>%
  summarise(ri_mean = mean(ri, na.rm = TRUE), .groups = "drop") %>%
  dplyr::rename(plotid = Plot)

# Calculate all pairwise deltas for ri
ri_pairs <- combn(unique(df_ri_mean$plotid), 2)
df_ri_delta <- tibble(
  plotid1 = ri_pairs[1,],
  plotid2 = ri_pairs[2,]
) %>%
  left_join(df_ri_mean, by = c("plotid1" = "plotid")) %>%
  dplyr::rename(ri1 = ri_mean, Layer1 = Layer) %>%
  left_join(df_ri_mean, by = c("plotid2" = "plotid", "Layer1" = "Layer")) %>%
  dplyr::rename(ri2 = ri_mean, Layer = Layer1) %>%
  mutate(delta_ri = abs(ri1 - ri2)) %>%
  dplyr::select(plotid1, plotid2, Layer, delta_ri)
df_ri_delta$plotid1 <- as.factor(df_ri_delta$plotid1)
df_ri_delta$plotid2 <- as.factor(df_ri_delta$plotid2)

# Merge delta_ri with Bray-Curtis for top-soil
if (exists("df_bray_curtis_topsoil_2_merged")) {
  df_bray_delta_top_ri <- df_bray_curtis_topsoil_2_merged %>%
    left_join(df_ri_delta %>% filter(Layer == "Topsoil\n(0-30 cm)"), by = c("plotid1", "plotid2")) %>%
    left_join(df_ri_delta %>% filter(Layer == "Topsoil\n(0-30 cm)"), by = c("plotid2" = "plotid1", "plotid1" = "plotid2"), suffix = c("", "_rev")) %>%
    mutate(delta_ri = coalesce(delta_ri, delta_ri_rev)) %>%
    dplyr::select(sample_name, comparison, plotid1, plotid2, BrayCurtisDissimilarity, delta_ri, everything(), -ends_with("_rev")) %>%
    rowwise() %>%
    mutate(sorted_plotids = paste(sort(c(plotid1, plotid2)), collapse = "_")) %>%
    ungroup() %>%
    distinct(sorted_plotids, BrayCurtisDissimilarity, .keep_all = TRUE) %>%
    dplyr::select(-sorted_plotids)
} else {
  df_bray_delta_top_ri <- NULL
}

# Merge delta_ri with Bray-Curtis for bottom-soil
if (exists("df_bray_curtis_subsoil_2_merged")) {
  df_bray_delta_bottom_ri <- df_bray_curtis_subsoil_2_merged %>%
    left_join(df_ri_delta %>% filter(Layer == "Subsoil\n(40-100 cm)"), by = c("plotid1", "plotid2")) %>%
    left_join(df_ri_delta %>% filter(Layer == "Subsoil\n(40-100 cm)"), by = c("plotid2" = "plotid1", "plotid1" = "plotid2"), suffix = c("", "_rev")) %>%
    mutate(delta_ri = coalesce(delta_ri, delta_ri_rev)) %>%
    dplyr::select(sample_name, comparison, plotid1, plotid2, BrayCurtisDissimilarity, delta_ri, everything(), -ends_with("_rev")) %>%
    rowwise() %>%
    mutate(sorted_plotids = paste(sort(c(plotid1, plotid2)), collapse = "_")) %>%
    ungroup() %>%
    distinct(sorted_plotids, BrayCurtisDissimilarity, .keep_all = TRUE) %>%
    dplyr::select(-sorted_plotids)
} else {
  df_bray_delta_bottom_ri <- NULL
}

# Plot for top-soil
if (!is.null(df_bray_delta_top_ri)) {
  plot_bray_delta_top_ri <- df_bray_delta_top_ri %>%
    ggplot(aes(x = delta_ri, y = BrayCurtisDissimilarity)) +
    geom_point() +
    geom_smooth(method = "lm") +
    stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
                 label.x = "left", label.y = 0.1,
                 formula = y ~ x, parse = TRUE, coef.digits = 3) +
    theme_JM +
    xlab("Delta reduction index") +
    ylab("Dissimilarity") +
    ggtitle("Top-soil (0-30 cm)")
} else {
  plot_bray_delta_top_ri <- NULL
}

# Plot for bottom-soil (remove regression line - not significant)
if (!is.null(df_bray_delta_bottom_ri)) {
  plot_bray_delta_bottom_ri <- df_bray_delta_bottom_ri %>%
    ggplot(aes(x = delta_ri, y = BrayCurtisDissimilarity)) +
    geom_point() +
    theme_JM +
    xlab("Delta reduction index") +
    ylab("Dissimilarity") +
    ggtitle("Bottom-soil (40-100 cm)")
} else {
  plot_bray_delta_bottom_ri <- NULL
}

# Arrange both panels
if (!is.null(plot_bray_delta_top_ri) & !is.null(plot_bray_delta_bottom_ri)) {
  ggarrange(plot_bray_delta_top_ri, plot_bray_delta_bottom_ri, ncol = 1, nrow = 2)
}
```

## Step 6h: Combined plot with elevation and temperature plots
```{r}
# Plot dissimilarities & elevation + statistics (updated)
plot_bray_delta_top_elevation <- df_bray_delta_topsoil_elevation_1_processed %>%
  ggplot(aes(x = delta_elevation, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta elevation [cm]") +
  ylab("Dissimilarity") +
  ggtitle("Top-soil (0-30 cm)")

plot_bray_delta_bottom_elevation <- df_bray_delta_subsoil_elevation_1_processed %>%
  ggplot(aes(x = delta_elevation, y = BrayCurtisDissimilarity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~")),
               label.x = "left", label.y = 0.1,
               formula = y ~ x, parse = TRUE, coef.digits = 3) +
  theme_JM +
  xlab("Delta elevation [cm]") +
  ylab("Dissimilarity") +
  ggtitle("Bottom-soil (40-100 cm)")

# Get temperature plots (remove regression lines - not significant)
# Create new temperature plots without regression lines
plot_bray_delta_top_pin <- df_bray_delta_topsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_pinTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  theme_JM + 
  xlab("Delta pin temperature [°C]") +
  ylab("Dissimilarity") +
  ggtitle("Top-soil (0-30 cm)")

plot_bray_delta_bottom_deep <- df_bray_delta_subsoil_1_processed %>%
  filter(zone1 == zone2) %>%
  ggplot(aes(x = delta_deepTemp, y = BrayCurtisDissimilarity)) +
  geom_point() +
  theme_JM +
  xlab("Delta deep temperature [°C]") +
  ylab("Dissimilarity") +
  ggtitle("Bottom-soil (40-100 cm)")

# Create the combined plot with 6 panels
if (!is.null(plot_bray_delta_top_ri) & !is.null(plot_bray_delta_bottom_ri)) {
  plot_bray_delta_combined <- ggarrange(
    plot_bray_delta_top_elevation + xlim(0, 80), 
    plot_bray_delta_top_ri + xlim(0, 1),
    plot_bray_delta_top_pin + xlim(0, 3.5), 
    plot_bray_delta_bottom_elevation + xlim(0, 80), 
    plot_bray_delta_bottom_ri + xlim(0, 1),
    plot_bray_delta_bottom_deep + xlim(0, 3.5),
    ncol = 3, 
    nrow = 2,
    labels = c("A", "C", "E", "B", "D", "F"), 
    font.label = list(size = 14, face = "bold"), 
    common.legend = TRUE, 
    legend = "top" 
  )
  
  plot_bray_delta_combined
  
  # Export high-resolution figures for publication
  # Create output directory if it doesn't exist
  if (!dir.exists(here("output"))) {
    dir.create(here("output"), recursive = TRUE)
  }

  # Export high-resolution TIFF file for publication
  tiff(here("output", "plot_bray_delta_combined.tiff"), 
       width = 15, height = 10, units = "in", res = 600, compression = "lzw")
  print(plot_bray_delta_combined)
  dev.off()

  # Also save as EPS for vector graphics option
  postscript(here("output", "plot_bray_delta_combined.eps"), 
             width = 15, height = 10, horizontal = FALSE)
  print(plot_bray_delta_combined)
  dev.off()

  cat("High-resolution figures saved:\n")
  cat("- plot_bray_delta_combined.tiff (600 DPI)\n")
  cat("- plot_bray_delta_combined.eps (vector)\n")
} else {
  cat("Combined plot cannot be created: Missing RI plots\n")
}
```

## Step 6f: Statistical analysis of environmental relationships
```{r}
# Temperature-dissimilarity relationships
stat_lm_topsoil_surface_1_main <- lm(BrayCurtisDissimilarity ~ delta_surfaceTemp, 
                                     data = df_bray_delta_topsoil_1_processed %>% filter(zone1 == zone2))
stat_lm_topsoil_pin_1_main <- lm(BrayCurtisDissimilarity ~ delta_pinTemp, 
                                 data = df_bray_delta_topsoil_1_processed %>% filter(zone1 == zone2))
stat_lm_topsoil_deep_1_main <- lm(BrayCurtisDissimilarity ~ delta_deepTemp, 
                                  data = df_bray_delta_topsoil_1_processed %>% filter(zone1 == zone2))

stat_lm_subsoil_surface_1_main <- lm(BrayCurtisDissimilarity ~ delta_surfaceTemp, 
                                     data = df_bray_delta_subsoil_1_processed %>% filter(zone1 == zone2))
stat_lm_subsoil_pin_1_main <- lm(BrayCurtisDissimilarity ~ delta_pinTemp, 
                                 data = df_bray_delta_subsoil_1_processed %>% filter(zone1 == zone2))
stat_lm_subsoil_deep_1_main <- lm(BrayCurtisDissimilarity ~ delta_deepTemp, 
                                  data = df_bray_delta_subsoil_1_processed %>% filter(zone1 == zone2))

# Combined elevation analysis
df_bray_delta_elevation_combined_1_processed <- df_bray_delta_topsoil_elevation_1_processed %>%
  bind_rows(df_bray_delta_subsoil_elevation_1_processed)

stat_lm_combined_elevation_1_main <- lm(BrayCurtisDissimilarity ~ delta_elevation, 
                                       data = df_bray_delta_elevation_combined_1_processed)
```


```{r}
# Export summarized alpha diversity data for correlation matrix integration
df_alpha_summary_export <- df_alpha_div_3_long %>%
  group_by(Plot, Layer) %>%
  summarise(alpha_diversity = mean(Value, na.rm = TRUE), .groups = "drop") %>%

```



# References
```{r}
# dplyr: Wickham, H., François, R., Henry, L., Müller, K., Vaughan, D., & PBC, P. S. (2024). dplyr: A Grammar of Data Manipulation. R package version 1.1.4. https://CRAN.R-project.org/package=dplyr
# emmeans: Lenth, R. V. (2024). emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version 1.10.2. https://CRAN.R-project.org/package=emmeans
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggpmisc: Aphalo, P. J. (2024). ggpmisc: Miscellaneous Extensions to 'ggplot2'. R package version 0.5.5. https://CRAN.R-project.org/package=ggpmisc
# ggpubr: Kassambara, A. (2024). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0. https://CRAN.R-project.org/package=ggpubr
# gt: Iannone, R. (2024). gt: Easily Create Presentation-Ready Display Tables. R package version 0.10.2. https://CRAN.R-project.org/package=gt
# lme4: Bates, D., Mächler, M., Bolker, B., & Walker, S. (2024). lme4: Linear Mixed-Effects Models using 'Eigen' and S4. R package version 1.1-35. https://CRAN.R-project.org/package=lme4
# microViz: Barnett, D. J. P. (2024). microViz: An R package for microbiome data visualization and statistics. R package version 0.11.6. https://david-barnett.github.io/microViz/
# performance: Lüdecke, D., Ben-Shachar, M. S., Patil, I., Waggoner, P., & Makowski, D. (2024). performance: Assessment of Regression Models Performance. R package version 0.10.8. https://CRAN.R-project.org/package=performance
# phyloseq: McMurdie, P.J. & Holmes, S. (2013). phyloseq: An R package for reproducible interactive analysis and graphics of microbiome census data. PLoS ONE 8(4): e61217. https://CRAN.R-project.org/package=phyloseq
# RColorBrewer: Neuwirth, E. (2014). RColorBrewer: ColorBrewer Palettes. R package version 1.1-3. https://CRAN.R-project.org/package=RColorBrewer
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
# vegan: Oksanen, J. et al. (2024). vegan: Community Ecology Package. R package version 2.6-4. https://CRAN.R-project.org/package=vegan
```

# REVISION - Mantel Tests for Community-Environment Correlations
## Simple Mantel Tests Analogous to Distance Decay Plots

```{r}
# Create Bray-Curtis dissimilarity matrices for both depth layers
bray_dist_topsoil <- vegdist(t(otu_table(ps_topsoil_1_processed)), method = "bray")
bray_dist_subsoil <- vegdist(t(otu_table(ps_subsoil_1_processed)), method = "bray")

# Get sample names from phyloseq objects to ensure matching order
topsoil_samples <- sample_names(ps_topsoil_1_processed)
subsoil_samples <- sample_names(ps_subsoil_1_processed)

# Prepare environmental data for topsoil - match phyloseq sample order
meta_topsoil_env <- df_metadata_0_raw %>%
  filter(sample_name %in% topsoil_samples) %>%
  mutate(Plot = as.character(Plot)) %>%
  # Join environmental data
  left_join(
    df_elevation_0_raw %>%
      group_by(Plot) %>%
      summarise(elevation_mean = mean(Elevation, na.rm = TRUE), .groups = "drop") %>%
      mutate(Plot = as.character(Plot)), 
    by = "Plot"
  ) %>%
  left_join(
    df_warming_monthly_0_raw %>%
      dplyr::select(plotid, pinTemp_mean) %>%
      dplyr::rename(Plot = plotid) %>%
      mutate(Plot = as.character(Plot)), 
    by = "Plot"
  ) %>%
  left_join(
    df_iris_0_summary %>%
      filter(Layer == "Topsoil\n(0-30 cm)") %>%
      dplyr::select(Plot, ri) %>%
      mutate(Plot = as.character(Plot)), 
    by = "Plot"
  ) %>%
  # Ensure same order as phyloseq object
  arrange(match(sample_name, topsoil_samples))

# Prepare environmental data for subsoil - match phyloseq sample order
meta_subsoil_env <- df_metadata_0_raw %>%
  filter(sample_name %in% subsoil_samples) %>%
  mutate(Plot = as.character(Plot)) %>%
  # Join environmental data (using same elevation and temperature data)
  left_join(
    df_elevation_0_raw %>%
      group_by(Plot) %>%
      summarise(elevation_mean = mean(Elevation, na.rm = TRUE), .groups = "drop") %>%
      mutate(Plot = as.character(Plot)), 
    by = "Plot"
  ) %>%
  left_join(
    df_warming_monthly_0_raw %>%
      dplyr::select(plotid, pinTemp_mean) %>%
      dplyr::rename(Plot = plotid) %>%
      mutate(Plot = as.character(Plot)), 
    by = "Plot"
  ) %>%
  left_join(
    df_iris_0_summary %>%
      filter(Layer == "Subsoil\n(40-100 cm)") %>%
      dplyr::select(Plot, ri) %>%
      mutate(Plot = as.character(Plot)), 
    by = "Plot"
  ) %>%
  # Ensure same order as phyloseq object
  arrange(match(sample_name, subsoil_samples))

# Create environmental distance matrices with matching sample order
elev_dist_topsoil <- dist(meta_topsoil_env$elevation_mean, method = "euclidean")
temp_dist_topsoil <- dist(meta_topsoil_env$pinTemp_mean, method = "euclidean")
ri_dist_topsoil <- dist(meta_topsoil_env$ri, method = "euclidean")

elev_dist_subsoil <- dist(meta_subsoil_env$elevation_mean, method = "euclidean")
temp_dist_subsoil <- dist(meta_subsoil_env$pinTemp_mean, method = "euclidean")
ri_dist_subsoil <- dist(meta_subsoil_env$ri, method = "euclidean")

# Perform Mantel tests for TOPSOIL (0-10cm)
mantel_topsoil_temp <- mantel(bray_dist_topsoil, temp_dist_topsoil, 
                              method = "pearson", permutations = 999)
mantel_topsoil_elev <- mantel(bray_dist_topsoil, elev_dist_topsoil, 
                              method = "pearson", permutations = 999)
mantel_topsoil_ri <- mantel(bray_dist_topsoil, ri_dist_topsoil, 
                            method = "pearson", permutations = 999)

# Perform Mantel tests for SUBSOIL (30-40cm)
mantel_subsoil_temp <- mantel(bray_dist_subsoil, temp_dist_subsoil, 
                              method = "pearson", permutations = 999)
mantel_subsoil_elev <- mantel(bray_dist_subsoil, elev_dist_subsoil, 
                              method = "pearson", permutations = 999)
mantel_subsoil_ri <- mantel(bray_dist_subsoil, ri_dist_subsoil, 
                            method = "pearson", permutations = 999)

# Display Mantel test results
cat("=== MANTEL TEST RESULTS ===\n")
cat("Community Bray-Curtis dissimilarity vs. Environmental distance correlations\n")
cat("Method: Pearson correlation with 999 permutations\n\n")

cat("TOPSOIL (0-10 cm):\n")
cat("Temperature:      r =", sprintf("%.3f", mantel_topsoil_temp$statistic), 
    ", p =", sprintf("%.3f", mantel_topsoil_temp$signif), "\n")
cat("Elevation:        r =", sprintf("%.3f", mantel_topsoil_elev$statistic), 
    ", p =", sprintf("%.3f", mantel_topsoil_elev$signif), "\n")
cat("Reduction Index:  r =", sprintf("%.3f", mantel_topsoil_ri$statistic), 
    ", p =", sprintf("%.3f", mantel_topsoil_ri$signif), "\n")

cat("\nSUBSOIL (30-40 cm):\n")
cat("Temperature:      r =", sprintf("%.3f", mantel_subsoil_temp$statistic), 
    ", p =", sprintf("%.3f", mantel_subsoil_temp$signif), "\n")
cat("Elevation:        r =", sprintf("%.3f", mantel_subsoil_elev$statistic), 
    ", p =", sprintf("%.3f", mantel_subsoil_elev$signif), "\n")
cat("Reduction Index:  r =", sprintf("%.3f", mantel_subsoil_ri$statistic), 
    ", p =", sprintf("%.3f", mantel_subsoil_ri$signif), "\n")


# Merge environmental data with subsoil metadata
meta_subsoil_env <- meta_subsoil %>%
  left_join(elevation_topsoil, by = "Plot") %>%  # Same elevation data
  left_join(temp_topsoil, by = "Plot") %>%       # Same temperature data
  left_join(ri_subsoil, by = "Plot") %>%
  arrange(sample_name)

# Create environmental distance matrices for subsoil
elev_dist_subsoil <- dist(meta_subsoil_env$elevation_mean, method = "euclidean")
temp_dist_subsoil <- dist(meta_subsoil_env$pinTemp_mean, method = "euclidean")
ri_dist_subsoil <- dist(meta_subsoil_env$ri, method = "euclidean")

# Perform Mantel tests for TOPSOIL (0-10cm)
mantel_topsoil_temp <- mantel(bray_dist_topsoil, temp_dist_topsoil, 
                              method = "pearson", permutations = 999)
mantel_topsoil_elev <- mantel(bray_dist_topsoil, elev_dist_topsoil, 
                              method = "pearson", permutations = 999)
mantel_topsoil_ri <- mantel(bray_dist_topsoil, ri_dist_topsoil, 
                            method = "pearson", permutations = 999)

# Perform Mantel tests for SUBSOIL (30-40cm)
mantel_subsoil_temp <- mantel(bray_dist_subsoil, temp_dist_subsoil, 
                              method = "pearson", permutations = 999)
mantel_subsoil_elev <- mantel(bray_dist_subsoil, elev_dist_subsoil, 
                              method = "pearson", permutations = 999)
mantel_subsoil_ri <- mantel(bray_dist_subsoil, ri_dist_subsoil, 
                            method = "pearson", permutations = 999)

# Display Mantel test results
cat("=== MANTEL TEST RESULTS ===\n")
cat("Community Bray-Curtis dissimilarity vs. Environmental distance correlations\n")
cat("Method: Pearson correlation with 999 permutations\n\n")

cat("TOPSOIL (0-10 cm):\n")
cat("Temperature:      r =", sprintf("%.3f", mantel_topsoil_temp$statistic), 
    ", p =", sprintf("%.3f", mantel_topsoil_temp$signif), "\n")
cat("Elevation:        r =", sprintf("%.3f", mantel_topsoil_elev$statistic), 
    ", p =", sprintf("%.3f", mantel_topsoil_elev$signif), "\n")
cat("Reduction Index:  r =", sprintf("%.3f", mantel_topsoil_ri$statistic), 
    ", p =", sprintf("%.3f", mantel_topsoil_ri$signif), "\n")

cat("\nSUBSOIL (30-40 cm):\n")
cat("Temperature:      r =", sprintf("%.3f", mantel_subsoil_temp$statistic), 
    ", p =", sprintf("%.3f", mantel_subsoil_temp$signif), "\n")
cat("Elevation:        r =", sprintf("%.3f", mantel_subsoil_elev$statistic), 
    ", p =", sprintf("%.3f", mantel_subsoil_elev$signif), "\n")
cat("Reduction Index:  r =", sprintf("%.3f", mantel_subsoil_ri$statistic), 
    ", p =", sprintf("%.3f", mantel_subsoil_ri$signif), "\n")
```


