---
title: "EEA Analysis"
author: "Julian Mittmann-Goetsch"
date: "2024-08-06"
output: html_document
---

## Version 2.1: EEA analysis routine - removed robustlmm and log-transformed analyses - 17.07.2025 | JM
## Version 2.0: EEA analysis routine - streamlined and cleaned - 11.07.2025 | JM
## Version 1.1: EEA data processing routine - 02.07.2025 | JM  
## Version 1.0: Basic function to load data from raw files - 02.02.2024 | JM
## Purpose: Statistical analysis and visualization of extracellular enzyme activities

# Step 1: Prepare session and load data
## Step 1a: Install necessary packages
```{r, message=FALSE, warning=FALSE}
#install.packages("emmeans")
#install.packages("ggplot2")
#install.packages("ggpmisc")
#install.packages("ggpubr")
#install.packages("here")
#install.packages("lme4")
#install.packages("lmerTest")
#install.packages("performance")
#install.packages("tidyverse")
```

## Step 1b: Load necessary packages
```{r}
library(emmeans)
library(ggplot2)
library(ggpmisc)
library(ggpubr)
library(here)
library(lme4)
library(lmerTest)
library(performance)
library(tidyverse)
```

## Step 1c: Define plot theme
```{r,message=FALSE, warning=FALSE}
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1d: Load preprocessed data
```{r}
# Load preprocessed EEA data (created by script_data_preprocessing_eea.Rmd)
df_eea_0_processed <- read.csv(here("data", "eea", "df_EEA_processed.csv"))
df_eea_0_cn_ratio <- read.csv(here("data", "eea", "df_EEA_CN_ratio.csv"))

# Load elevation data
df_elevation_0_raw <- read.delim(here("data", "elevation", "df_iris_elevation.txt"), dec=".", sep="\t")

# Load IRIS data (created by script_iris.Rmd) - if available
# df_iris_0_summary <- read.csv(here("data", "iris", "df_iris_summary.csv"))

# Load warming data (created by script_warming_data_2022.Rmd) - if available  
# df_warming_0_monthly <- read.csv(here("scripts", "df_warming_all_2022_monthly.csv"))

print("Preprocessed EEA data loaded successfully")
```

# Step 2: Prepare final analysis datasets
## Step 2a: Calculate elevation means and merge environmental data
```{r}
# Calculate mean elevation per plot
df_elevation_1_mean <- df_elevation_0_raw %>%
  group_by(Plot) %>%
  summarise(Elevation_mean = mean(Elevation)) %>%
  mutate(Plot = as.factor(Plot))

# Prepare IRIS reduction index data if available
if(!is.null(df_iris_0_summary)) {
  df_iris_1_mean <- df_iris_0_summary %>%
    group_by(Plot, Layer) %>%
    summarise("ri" = mean(ri, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(Plot = as.factor(Plot), Layer = as.factor(Layer))
  print("IRIS reduction index data prepared")
} else {
  df_iris_1_mean <- NULL
  warning("IRIS data not available - reduction index will be missing")
}

# Prepare warming data if available  
if(!is.null(df_warming_0_monthly)) {
  df_warming_1_monthly <- df_warming_0_monthly %>%
    mutate(Plot = as.factor(plotid))
  print("Warming data prepared")
} else {
  df_warming_1_monthly <- NULL
  warning("Warming data not available - temperature variables will be missing")
}

print("Environmental data preparation completed")
```

## Step 2b: Create EEA summary datasets
```{r}
# Prepare main EEA data
df_eea_1_main <- df_eea_0_processed %>%
  mutate(plotid = substring(ID.y, 1, 3),
         Plot = as.factor(plotid))

# Create EEA summary by plot, zone, treatment, layer, and enzyme
df_eea_2_summary <- df_eea_1_main %>%
  group_by(Zone, Treatment, Layer, Enzyme, Plot) %>%
  summarise(Activity_OM_mean = mean(Activity_OM, na.rm = TRUE),
            .groups = "drop")

# Transform to wide format for C and N activities
df_eea_3_wide <- df_eea_2_summary %>%
  pivot_wider(
    names_from = Enzyme,
    values_from = Activity_OM_mean
  ) %>%
  mutate(
    Activity_C = GLU,
    Activity_N = CHI + LEU,
    CN_ratio = GLU / (CHI + LEU)
  )

print("EEA summary datasets created")
```

## Step 2c: Merge all datasets for final analysis
```{r}
# Start with EEA wide data
df_eea_4_final <- df_eea_3_wide

# Add elevation data
df_eea_4_final <- df_eea_4_final %>%
  left_join(df_elevation_1_mean, by = "Plot")

# Add IRIS data - uncomment when available
# df_eea_4_final <- df_eea_4_final %>%
#   left_join(df_iris_1_mean, by = c("Layer", "Plot"))

# Add warming data - uncomment when available
# df_eea_4_final <- df_eea_4_final %>%
#   left_join(df_warming_1_monthly, by = "Plot")

# Add core_id for statistical models
df_eea_1_main <- df_eea_1_main %>%
  mutate(core_id = substr(ID.y, 1, 7))

print("Final analysis datasets merged successfully")
```

# Step 3: Plots
## Step 3a: EEAs (factorial)
```{r}
# Plot C acquisition
plot_EEA_mean_layer_GLU <- df_eea_1_main %>%
  filter(Enzyme == "GLU") %>%
  ggplot(aes(x = Treatment, y = Activity_OM, fill = Treatment)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9),
                 alpha = 0.9, width = 0.7) +
    stat_summary(fun.data = mean_se, geom = "errorbar",
                 position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Carbon acquisition", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]")), expand = c(0,0)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    coord_cartesian(ylim = c(0, 1500)) +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          panel.spacing = unit(1, "lines"))

# Plot N acquisition
plot_EEA_mean_layer_CHI_LEU <- df_eea_1_main %>%
  filter(!Enzyme == "GLU") %>%
  ggplot(aes(x = Treatment, y = Activity_OM, fill = Treatment)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9),
                 alpha = 0.9, width = 0.7) +
    stat_summary(fun.data = mean_se, geom = "errorbar",
                 position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Nitrogen acquisition", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]")), expand = c(0,0)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    coord_cartesian(ylim = c(0, 1500)) +
    theme(legend.position = "bottom",
          axis.text.x = element_blank(),
          panel.spacing = unit(1, "lines"))

# Combined C and N acquisition plot
plot_CN <- ggarrange(
  plot_EEA_mean_layer_GLU,
  plot_EEA_mean_layer_CHI_LEU,
  ncol = 1,
  heights = c(1, 1.2),
  labels = c("A", "B"),
  font.label = list(size = 16, face = "bold")
)

plot_CN
```

## Step 3b: EEAs (regressions)
```{r}
# Plot C acquisition vs pin temperature (topsoil) - uncomment when warming data available
# plot_EEA_C_warming_pin <- df_eea_4_final %>%
#   filter(grepl("Topsoil", Layer)) %>%
#   ggplot(aes(x = pinTemp_mean, y = Activity_C, color = Zone)) +
#     geom_point() +
#     geom_smooth(method = "lm") +
#     stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~~~")),
#                  formula = y ~ x, 
#                  parse = TRUE, 
#                  label.x.npc = "right",
#                  label.y.npc = 0.9) +
#     scale_color_manual(values = c("Pioneer zone" = "#084081", "Low marsh" = "#4eb3d3", "High marsh" = "#7fcdbb"), name = "Zone:") +
#     scale_y_continuous(
#      name = "Carbon acquisition\n[nmol g OM⁻¹ h⁻¹]",
#       expand = c(0,0),
#       limits = c(0, 3500),
#       breaks = seq(0, 3000, by = 1000)) +
#     theme_JM + 
#     labs(x = "Monthly T at 20 cm depth [°C]") 

# plot_EEA_C_warming_pin

print("Regression plots commented out - uncomment when warming data is available")
```

## Step 3c: EEA-ratio (factorial)
```{r}
# Plot C/N ratio by treatment
plot_EEA_ratio <- df_eea_0_cn_ratio %>%
  filter(!is.na(GLU_CHI_ratio)) %>%
  ggplot(aes(x = Treatment, y = GLU_CHI_ratio, fill = Treatment)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9),
                 alpha = 0.9, width = 0.7) +
    stat_summary(fun.data = mean_se, geom = "errorbar",
                 position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("C-N enzyme ratio")), expand = c(0,0)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    coord_cartesian(ylim = c(0, 1.1)) +
    theme(legend.position = "bottom",
          axis.text.x = element_blank(),
          panel.spacing = unit(1, "lines"))

plot_EEA_ratio
```

## Step 3d: EEA-ratio (regression)
```{r}
# Plot C/N ratio vs pin temperature (topsoil) - uncomment when warming data available
# plot_EEA_CN_warming_pin <- df_eea_4_final %>%
#   filter(grepl("Topsoil", Layer)) %>%
#   ggplot(aes(x = pinTemp_mean, y = CN_ratio, color = Zone)) +
#     geom_point() +
#     geom_smooth(method = "lm") +
#     stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~~~")),
#                  formula = y ~ x, 
#                  parse = TRUE, 
#                  label.x.npc = "right",
#                  label.y.npc = 0.9) +
#     scale_color_manual(values = c("Pioneer zone" = "#084081", "Low marsh" = "#4eb3d3", "High marsh" = "#7fcdbb"), name = "Zone:") +
#     scale_y_continuous(
#       name = expression(paste("C/N-acquisition ratio")), 
#       expand = c(0,0),
#       limits = c(0, 1.5),
#       breaks = seq(0, 1.5, by = 0.5)) +
#     theme_JM + 
#     labs(x = "Monthly T at 20 cm depth [°C]") 

# plot_EEA_CN_warming_pin

print("C/N ratio regression plots commented out - uncomment when warming data is available")
```

# Step 4: Summarise dataframes (preliminary for statistics)
```{r}
# Create summary datasets for statistical analysis and correlation matrix
if(exists("df_alpha_sum")) {
  df_alpha_0_summary <- df_alpha_sum %>% 
    mutate(plotid = as.character(plotid))
  print("Alpha diversity data available for summary")
} else {
  df_alpha_0_summary <- NULL
  warning("Alpha diversity data not available")
}

if(exists("df_qpcr_sum")) {
  df_qpcr_0_summary <- df_qpcr_sum %>% 
    mutate(plotid = as.character(plotid))
  print("qPCR data available for summary")
} else {
  df_qpcr_0_summary <- NULL
  warning("qPCR data not available")
}

# Create comprehensive summary dataset
df_eea_5_summary <- df_eea_4_final %>%
  mutate(plotid = as.character(Plot))

# Add alpha diversity if available
if(!is.null(df_alpha_0_summary)) {
  df_eea_5_summary <- df_eea_5_summary %>%
    left_join(df_alpha_0_summary, by = c("plotid", "Layer"))
}

# Add qPCR data if available
if(!is.null(df_qpcr_0_summary)) {
  df_eea_5_summary <- df_eea_5_summary %>%
    left_join(df_qpcr_0_summary, by = "plotid")
}

# Add soil temperature mean if warming data available
if(!is.null(df_warming_1_monthly)) {
  df_eea_5_summary <- df_eea_5_summary %>%
    mutate("Soil temperature" = rowMeans(select(., contains("Temp_mean")), na.rm = TRUE))
}

print("Summary dataset for correlations created")
```

# Step 5: Statistics
## Step 5a: Normality tests and data preparation
```{r}
# Test normality of EEA activity data
print("=== NORMALITY TESTS FOR EEA ACTIVITIES ===")

# Shapiro-Wilk test for C acquisition (GLU)
eea_c_data <- df_eea_1_main %>% filter(Enzyme == "GLU", !is.na(Activity_OM))
if(nrow(eea_c_data) <= 5000) {
  shapiro_c <- shapiro.test(eea_c_data$Activity_OM)
  print("Carbon acquisition (GLU) normality test:")
  print(shapiro_c)
} else {
  print("Carbon acquisition dataset too large for Shapiro-Wilk test")
}

# Shapiro-Wilk test for N acquisition (CHI + LEU)
eea_n_data <- df_eea_1_main %>% filter(Enzyme %in% c("CHI", "LEU"), !is.na(Activity_OM))
if(nrow(eea_n_data) <= 5000) {
  shapiro_n <- shapiro.test(eea_n_data$Activity_OM)
  print("Nitrogen acquisition (CHI + LEU) normality test:")
  print(shapiro_n)
} else {
  print("Nitrogen acquisition dataset too large for Shapiro-Wilk test")
}

# QQ plots for visual assessment
print("Generating QQ plots for visual normality assessment...")

qqplot_c <- df_eea_1_main %>%
  filter(Enzyme == "GLU") %>%
  ggplot(aes(sample = Activity_OM)) +
    stat_qq() +
    stat_qq_line() +
    labs(title = "QQ Plot - Carbon Acquisition (Original Scale)", 
         x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_JM

qqplot_n <- df_eea_1_main %>%
  filter(Enzyme %in% c("CHI", "LEU")) %>%
  ggplot(aes(sample = Activity_OM)) +
    stat_qq() +
    stat_qq_line() +
    labs(title = "QQ Plot - Nitrogen Acquisition (Original Scale)", 
         x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_JM

qqplot_c
qqplot_n
```

## Step 5b: Mixed-effects models (factorial analysis)
```{r}
# Standard linear mixed-effects models
print("=== STANDARD LINEAR MIXED-EFFECTS MODELS ===")

# Carbon acquisition model
stat_model_C <- lmer(Activity_OM ~ Zone * Treatment * Layer + (1|Plot/core_id), 
                     data = df_eea_1_main %>% filter(Enzyme == "GLU"))

# Nitrogen acquisition model  
stat_model_N <- lmer(Activity_OM ~ Zone * Treatment * Layer + (1|Plot/core_id), 
                     data = df_eea_1_main %>% filter(Enzyme %in% c("LEU", "CHI")))

# Model diagnostics
print("=== MODEL DIAGNOSTICS ===")
print("Carbon acquisition model diagnostics:")
check_model(stat_model_C)

print("Nitrogen acquisition model diagnostics:")
check_model(stat_model_N)

# Test residual normality
shapiro.test(resid(stat_model_C))
shapiro.test(resid(stat_model_N))

# ANOVA results
print("=== ANOVA RESULTS - STANDARD MODELS ===")
print("Carbon acquisition:")
anova(stat_model_C)

print("Nitrogen acquisition:")
anova(stat_model_N)
```

## Step 5c: Pairwise comparisons using emmeans
```{r}
# Choose the standard lmer models for pairwise comparisons
print("=== PAIRWISE COMPARISONS - STANDARD MODELS ===")

# Main effects
print("--- ZONE COMPARISONS ---")
stat_C_zone_emm <- emmeans(stat_model_C, ~ Zone)
print("Carbon acquisition by Zone:")
pairs(stat_C_zone_emm)

stat_N_zone_emm <- emmeans(stat_model_N, ~ Zone)
print("Nitrogen acquisition by Zone:")
pairs(stat_N_zone_emm)

print("--- TREATMENT COMPARISONS ---")
stat_C_treatment_emm <- emmeans(stat_model_C, ~ Treatment)
print("Carbon acquisition by Treatment:")
pairs(stat_C_treatment_emm)

stat_N_treatment_emm <- emmeans(stat_model_N, ~ Treatment)
print("Nitrogen acquisition by Treatment:")
pairs(stat_N_treatment_emm)

print("--- LAYER COMPARISONS ---")
stat_C_layer_emm <- emmeans(stat_model_C, ~ Layer)
print("Carbon acquisition by Layer:")
pairs(stat_C_layer_emm)

stat_N_layer_emm <- emmeans(stat_model_N, ~ Layer)
print("Nitrogen acquisition by Layer:")
pairs(stat_N_layer_emm)

# Interaction effects
print("--- ZONE x TREATMENT INTERACTIONS ---")
stat_C_zone_treatment_emm <- emmeans(stat_model_C, ~ Zone | Treatment)
print("Carbon acquisition Zone x Treatment:")
pairs(stat_C_zone_treatment_emm)

stat_N_zone_treatment_emm <- emmeans(stat_model_N, ~ Zone | Treatment)
print("Nitrogen acquisition Zone x Treatment:")
pairs(stat_N_zone_treatment_emm)

print("--- ZONE x LAYER INTERACTIONS ---")
stat_C_zone_layer_emm <- emmeans(stat_model_C, ~ Zone | Layer)
print("Carbon acquisition Zone x Layer:")
pairs(stat_C_zone_layer_emm)

stat_N_zone_layer_emm <- emmeans(stat_model_N, ~ Zone | Layer)
print("Nitrogen acquisition Zone x Layer:")
pairs(stat_N_zone_layer_emm)

print("--- TREATMENT x LAYER INTERACTIONS ---")
stat_C_treatment_layer_emm <- emmeans(stat_model_C, ~ Treatment | Layer)
print("Carbon acquisition Treatment x Layer:")
pairs(stat_C_treatment_layer_emm)

stat_N_treatment_layer_emm <- emmeans(stat_model_N, ~ Treatment | Layer)
print("Nitrogen acquisition Treatment x Layer:")
pairs(stat_N_treatment_layer_emm)

print("--- THREE-WAY INTERACTIONS ---")
stat_C_treatment_layer_zone_emm <- emmeans(stat_model_C, ~ Treatment | Layer | Zone)
print("Carbon acquisition Treatment x Layer x Zone:")
pairs(stat_C_treatment_layer_zone_emm)

stat_N_treatment_layer_zone_emm <- emmeans(stat_model_N, ~ Treatment | Layer | Zone)
print("Nitrogen acquisition Treatment x Layer x Zone:")
pairs(stat_N_treatment_layer_zone_emm)
```

## Step 5d: Regression analyses with environmental variables
```{r}
# Check if environmental variables are available
if(!is.null(df_warming_1_monthly) && "Elevation_mean" %in% colnames(df_eea_4_final)) {
  
  print("=== ENVIRONMENTAL REGRESSION ANALYSES ===")
  
  # Calculate mean temperature if multiple sensors available
  if(all(c("pinTemp_mean", "deepTemp_mean") %in% colnames(df_eea_4_final))) {
    df_eea_4_final <- df_eea_4_final %>%
      mutate(meanTemp = rowMeans(select(., pinTemp_mean, deepTemp_mean), na.rm = TRUE))
    
    print("--- TEMPERATURE REGRESSIONS ---")
    # Regressions with mean temperature
    temp_c_model <- lm(Activity_C ~ meanTemp, data = df_eea_4_final)
    temp_n_model <- lm(Activity_N ~ meanTemp, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Mean temperature:")
    print(summary(temp_c_model))
    
    print("Nitrogen acquisition ~ Mean temperature:")
    print(summary(temp_n_model))
    
  } else if("pinTemp_mean" %in% colnames(df_eea_4_final)) {
    print("--- PIN TEMPERATURE REGRESSIONS ---")
    # Regressions with pin temperature only
    pin_temp_c_model <- lm(Activity_C ~ pinTemp_mean, data = df_eea_4_final)
    pin_temp_n_model <- lm(Activity_N ~ pinTemp_mean, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Pin temperature:")
    print(summary(pin_temp_c_model))
    
    print("Nitrogen acquisition ~ Pin temperature:")
    print(summary(pin_temp_n_model))
  }
  
  print("--- ELEVATION REGRESSIONS ---")
  # Elevation regressions - overall
  elev_c_model <- lm(Activity_C ~ Elevation_mean, data = df_eea_4_final)
  elev_n_model <- lm(Activity_N ~ Elevation_mean, data = df_eea_4_final)
  
  print("Carbon acquisition ~ Elevation (all layers):")
  print(summary(elev_c_model))
  
  print("Nitrogen acquisition ~ Elevation (all layers):")
  print(summary(elev_n_model))
  
  # Elevation regressions by layer
  if("Layer" %in% colnames(df_eea_4_final)) {
    
    # Topsoil
    topsoil_data <- df_eea_4_final %>% filter(grepl("Topsoil", Layer))
    if(nrow(topsoil_data) > 0) {
      elev_c_top_model <- lm(Activity_C ~ Elevation_mean, data = topsoil_data)
      elev_n_top_model <- lm(Activity_N ~ Elevation_mean, data = topsoil_data)
      
      print("Carbon acquisition ~ Elevation (topsoil only):")
      print(summary(elev_c_top_model))
      
      print("Nitrogen acquisition ~ Elevation (topsoil only):")
      print(summary(elev_n_top_model))
    }
    
    # Subsoil
    subsoil_data <- df_eea_4_final %>% filter(grepl("Subsoil", Layer))
    if(nrow(subsoil_data) > 0) {
      elev_c_sub_model <- lm(Activity_C ~ Elevation_mean, data = subsoil_data)
      elev_n_sub_model <- lm(Activity_N ~ Elevation_mean, data = subsoil_data)
      
      print("Carbon acquisition ~ Elevation (subsoil only):")
      print(summary(elev_c_sub_model))
      
      print("Nitrogen acquisition ~ Elevation (subsoil only):")
      print(summary(elev_n_sub_model))
    }
  }
  
  # Reduction index regressions if available
  if("ri" %in% colnames(df_eea_4_final)) {
    print("--- REDUCTION INDEX REGRESSIONS ---")
    
    ri_c_model <- lm(Activity_C ~ ri, data = df_eea_4_final)
    ri_n_model <- lm(Activity_N ~ ri, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Reduction index:")
    print(summary(ri_c_model))
    
    print("Nitrogen acquisition ~ Reduction index:")
    print(summary(ri_n_model))
  }
  
  # Multi-variable regression if data available
  if(all(c("meanTemp", "Elevation_mean", "ri") %in% colnames(df_eea_4_final))) {
    print("--- MULTIVARIATE REGRESSIONS ---")
    
    multi_c_model <- lm(Activity_C ~ meanTemp + Elevation_mean + ri, data = df_eea_4_final)
    multi_n_model <- lm(Activity_N ~ meanTemp + Elevation_mean + ri, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Temperature + Elevation + Reduction index:")
    print(summary(multi_c_model))
    
    print("Nitrogen acquisition ~ Temperature + Elevation + Reduction index:")
    print(summary(multi_n_model))
  }
  
} else {
  warning("Environmental data not available - skipping regression analyses")
}

# Include alpha diversity in regressions if available
if(!is.null(df_alpha_0_summary) && exists("df_eea_5_summary")) {
  print("=== ALPHA DIVERSITY REGRESSIONS ===")
  
  if("meanTemp" %in% colnames(df_eea_5_summary)) {
    alpha_temp_model <- lm(Alpha_diversity ~ meanTemp, data = df_eea_5_summary)
    print("Alpha diversity ~ Mean temperature:")
    print(summary(alpha_temp_model))
  }
  
  if("Elevation_mean" %in% colnames(df_eea_5_summary)) {
    alpha_elev_model <- lm(Alpha_diversity ~ Elevation_mean, data = df_eea_5_summary)
    print("Alpha diversity ~ Elevation:")
    print(summary(alpha_elev_model))
  }
  
  if("ri" %in% colnames(df_eea_5_summary)) {
    alpha_ri_model <- lm(Alpha_diversity ~ ri, data = df_eea_5_summary)
    print("Alpha diversity ~ Reduction index:")
    print(summary(alpha_ri_model))
  }
}
```

# Step 6: Save final datasets
```{r}
# Save final EEA dataset for use in other scripts
write.csv(df_eea_4_final, here("data", "eea", "df_EEA_final.csv"), row.names = FALSE)

print("Final EEA dataset saved for downstream analysis")
```

# Step 7: Summary of dataframes
```{r}
# Summary of EEA analysis datasets
print("=== EEA ANALYSIS DATASETS SUMMARY ===")

print("=== EEA MAIN DATA (df_eea_1_main) ===")
str(df_eea_1_main)
print("Sample distribution by enzyme:")
table(df_eea_1_main$Enzyme)

print("=== EEA FINAL DATA (df_eea_4_final) ===")
str(df_eea_4_final)
print("Sample distribution by treatment and zone:")
table(df_eea_4_final$Treatment, df_eea_4_final$Zone)

print("=== C/N RATIO DATA (df_eea_0_cn_ratio) ===")
str(df_eea_0_cn_ratio)
summary(df_eea_0_cn_ratio$GLU_CHI_ratio)

print("=== EEA ACTIVITY SUMMARY ===")
summary(df_eea_4_final[c("Activity_C", "Activity_N", "CN_ratio")])
```

# References
```{r}
# emmeans: Lenth, R. V. (2024). emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version 1.10.2. https://CRAN.R-project.org/package=emmeans
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggpmisc: Aphalo, P. J. (2024). ggpmisc: Miscellaneous Extensions to 'ggplot2'. R package version 0.5.5. https://CRAN.R-project.org/package=ggpmisc
# ggpubr: Kassambara, A. (2024). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0. https://CRAN.R-project.org/package=ggpubr
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
# lme4: Bates, D., Mächler, M., Bolker, B., & Walker, S. (2024). lme4: Linear Mixed-Effects Models using 'Eigen' and S4. R package version 1.1-35. https://CRAN.R-project.org/package=lme4
# lmerTest: Kuznetsova, A., Brockhoff, P. B., & Christensen, R. H. B. (2024). lmerTest: Tests in Linear Mixed Effects Models. R package version 3.1-3. https://CRAN.R-project.org/package=lmerTest
# performance: Lüdecke, D., Ben-Shachar, M. S., Patil, I., Waggoner, P., & Makowski, D. (2024). performance: Assessment of Regression Models Performance. R package version 0.10.8. https://CRAN.R-project.org/package=performance
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
```
