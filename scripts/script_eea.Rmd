---
title: "EEA Analysis"
author: "Julian Mittmann-Goetsch"
date: "2024-08-06"
output: html_document
---

## Version 2.2: REVISION - Added deviation plots relative to ambient baseline - 12.09.2025 | JM
## Version 2.1: EEA analysis routine - removed robustlmm and log-transformed analyses - 17.07.2025 | JM
## Version 2.0: EEA analysis routine - streamlined and cleaned - 11.07.2025 | JM
## Version 1.1: EEA data processing routine - 02.07.2025 | JM  
## Version 1.0: Basic function to load data from raw files - 02.02.2024 | JM
## Purpose: Statistical analysis and visualization of extracellular enzyme activities

# Step 1: Prepare session and load data
## Step 1a: Install necessary packages
```{r, message=FALSE, warning=FALSE}
#install.packages("emmeans")
#install.packages("ggplot2")
#install.packages("ggpmisc")
#install.packages("ggpubr")
#install.packages("here")
#install.packages("lme4")
#install.packages("lmerTest")
#install.packages("performance")
#install.packages("tidyverse")
```

## Step 1b: Load necessary packages
```{r}
library(emmeans)
library(ggplot2)
library(ggpmisc)
library(ggpubr)
library(here)
library(lme4)
library(lmerTest)
library(performance)
library(tidyverse)
```

## Step 1c: Define plot theme
```{r,message=FALSE, warning=FALSE}
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1d: Load preprocessed data
```{r}
# Load preprocessed EEA data (created by script_data_preprocessing_eea.Rmd)
df_eea_0_processed <- read.csv(here("data", "eea", "df_EEA_processed.csv"))
df_eea_0_cn_ratio <- read.csv(here("data", "eea", "df_EEA_CN_ratio.csv"))

# Load elevation data
df_elevation_0_raw <- read.delim(here("data", "elevation", "df_iris_elevation.txt"), dec=".", sep="\t")

# Load IRIS data (created by script_iris.Rmd) - if available
# df_iris_0_summary <- read.csv(here("data", "iris", "df_iris_summary.csv"))

# Load warming data (created by script_warming_data_2022.Rmd) - if available  
# df_warming_0_monthly <- read.csv(here("scripts", "df_warming_all_2022_monthly.csv"))

print("Preprocessed EEA data loaded successfully")
```

# Step 2: Prepare final analysis datasets
## Step 2a: Calculate elevation means and merge environmental data
```{r}
# Calculate mean elevation per plot
df_elevation_1_mean <- df_elevation_0_raw %>%
  group_by(Plot) %>%
  summarise(Elevation_mean = mean(Elevation)) %>%
  mutate(Plot = as.factor(Plot))

# Prepare IRIS reduction index data if available
if(!is.null(df_iris_0_summary)) {
  df_iris_1_mean <- df_iris_0_summary %>%
    group_by(Plot, Layer) %>%
    summarise("ri" = mean(ri, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(Plot = as.factor(Plot), Layer = as.factor(Layer))
  print("IRIS reduction index data prepared")
} else {
  df_iris_1_mean <- NULL
  warning("IRIS data not available - reduction index will be missing")
}

# Prepare warming data if available  
if(!is.null(df_warming_0_monthly)) {
  df_warming_1_monthly <- df_warming_0_monthly %>%
    mutate(Plot = as.factor(plotid))
  print("Warming data prepared")
} else {
  df_warming_1_monthly <- NULL
  warning("Warming data not available - temperature variables will be missing")
}

print("Environmental data preparation completed")
```

## Step 2b: Create EEA summary datasets
```{r}
# Prepare main EEA data
df_eea_1_main <- df_eea_0_processed %>%
  mutate(plotid = substring(ID.y, 1, 3),
         Plot = as.factor(plotid))

# Create EEA summary by plot, zone, treatment, layer, and enzyme
df_eea_2_summary <- df_eea_1_main %>%
  group_by(Zone, Treatment, Layer, Enzyme, Plot) %>%
  summarise(Activity_OM_mean = mean(Activity_OM, na.rm = TRUE),
            .groups = "drop")

# Transform to wide format for C and N activities
df_eea_3_wide <- df_eea_2_summary %>%
  pivot_wider(
    names_from = Enzyme,
    values_from = Activity_OM_mean
  ) %>%
  mutate(
    Activity_C = GLU,
    Activity_N = CHI + LEU,
    CN_ratio = GLU / (CHI + LEU)
  )

print("EEA summary datasets created")
```

## Step 2c: Merge all datasets for final analysis
```{r}
# Start with EEA wide data
df_eea_4_final <- df_eea_3_wide

# Add elevation data
df_eea_4_final <- df_eea_4_final %>%
  left_join(df_elevation_1_mean, by = "Plot")

# Add IRIS data - uncomment when available
# df_eea_4_final <- df_eea_4_final %>%
#   left_join(df_iris_1_mean, by = c("Layer", "Plot"))

# Add warming data - uncomment when available
# df_eea_4_final <- df_eea_4_final %>%
#   left_join(df_warming_1_monthly, by = "Plot")

# Add core_id for statistical models
df_eea_1_main <- df_eea_1_main %>%
  mutate(core_id = substr(ID.y, 1, 7))

print("Final analysis datasets merged successfully")
```

# Step 3: Plots
## Step 3a: EEAs (factorial)
```{r}
# Plot C acquisition
plot_EEA_mean_layer_GLU <- df_eea_1_main %>%
  filter(Enzyme == "GLU") %>%
  ggplot(aes(x = Treatment, y = Activity_OM, fill = Treatment)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9),
                 alpha = 0.9, width = 0.7) +
    stat_summary(fun.data = mean_se, geom = "errorbar",
                 position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Carbon acquisition", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]")), expand = c(0,0)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    coord_cartesian(ylim = c(0, 1500)) +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          panel.spacing = unit(1, "lines"))

# Plot N acquisition
plot_EEA_mean_layer_CHI_LEU <- df_eea_1_main %>%
  filter(!Enzyme == "GLU") %>%
  ggplot(aes(x = Treatment, y = Activity_OM, fill = Treatment)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9),
                 alpha = 0.9, width = 0.7) +
    stat_summary(fun.data = mean_se, geom = "errorbar",
                 position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Nitrogen acquisition", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]")), expand = c(0,0)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    coord_cartesian(ylim = c(0, 1500)) +
    theme(legend.position = "bottom",
          axis.text.x = element_blank(),
          panel.spacing = unit(1, "lines"))

# Combined C and N acquisition plot
plot_CN <- ggarrange(
  plot_EEA_mean_layer_GLU,
  plot_EEA_mean_layer_CHI_LEU,
  ncol = 1,
  heights = c(1, 1.2),
  labels = c("A", "B"),
  font.label = list(size = 16, face = "bold")
)

plot_CN
```

## Step 3b: EEAs (regressions)
```{r}
# Plot C acquisition vs pin temperature (topsoil) - uncomment when warming data available
# plot_EEA_C_warming_pin <- df_eea_4_final %>%
#   filter(grepl("Topsoil", Layer)) %>%
#   ggplot(aes(x = pinTemp_mean, y = Activity_C, color = Zone)) +
#     geom_point() +
#     geom_smooth(method = "lm") +
#     stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~~~")),
#                  formula = y ~ x, 
#                  parse = TRUE, 
#                  label.x.npc = "right",
#                  label.y.npc = 0.9) +
#     scale_color_manual(values = c("Pioneer zone" = "#084081", "Low marsh" = "#4eb3d3", "High marsh" = "#7fcdbb"), name = "Zone:") +
#     scale_y_continuous(
#      name = "Carbon acquisition\n[nmol g OM⁻¹ h⁻¹]",
#       expand = c(0,0),
#       limits = c(0, 3500),
#       breaks = seq(0, 3000, by = 1000)) +
#     theme_JM + 
#     labs(x = "Monthly T at 20 cm depth [°C]") 

# plot_EEA_C_warming_pin

print("Regression plots commented out - uncomment when warming data is available")
```

## Step 3c: EEA-ratio (factorial)
```{r}
# Plot C/N ratio by treatment
plot_EEA_ratio <- df_eea_0_cn_ratio %>%
  filter(!is.na(GLU_CHI_ratio)) %>%
  ggplot(aes(x = Treatment, y = GLU_CHI_ratio, fill = Treatment)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9),
                 alpha = 0.9, width = 0.7) +
    stat_summary(fun.data = mean_se, geom = "errorbar",
                 position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("C-N enzyme ratio")), expand = c(0,0)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    coord_cartesian(ylim = c(0, 1.1)) +
    theme(legend.position = "bottom",
          axis.text.x = element_blank(),
          panel.spacing = unit(1, "lines"))

plot_EEA_ratio
```

## Step 3d: EEA-ratio (regression)
```{r}
# Plot C/N ratio vs pin temperature (topsoil) - uncomment when warming data available
# plot_EEA_CN_warming_pin <- df_eea_4_final %>%
#   filter(grepl("Topsoil", Layer)) %>%
#   ggplot(aes(x = pinTemp_mean, y = CN_ratio, color = Zone)) +
#     geom_point() +
#     geom_smooth(method = "lm") +
#     stat_poly_eq(aes(label = paste(..rr.label.., ..p.value.label.., sep = "~~~")),
#                  formula = y ~ x, 
#                  parse = TRUE, 
#                  label.x.npc = "right",
#                  label.y.npc = 0.9) +
#     scale_color_manual(values = c("Pioneer zone" = "#084081", "Low marsh" = "#4eb3d3", "High marsh" = "#7fcdbb"), name = "Zone:") +
#     scale_y_continuous(
#       name = expression(paste("C/N-acquisition ratio")), 
#       expand = c(0,0),
#       limits = c(0, 1.5),
#       breaks = seq(0, 1.5, by = 0.5)) +
#     theme_JM + 
#     labs(x = "Monthly T at 20 cm depth [°C]") 

# plot_EEA_CN_warming_pin

print("C/N ratio regression plots commented out - uncomment when warming data is available")
```

# Step 4: Summarise dataframes (preliminary for statistics)
```{r}
# Create summary datasets for statistical analysis and correlation matrix
if(exists("df_alpha_sum")) {
  df_alpha_0_summary <- df_alpha_sum %>% 
    mutate(plotid = as.character(plotid))
  print("Alpha diversity data available for summary")
} else {
  df_alpha_0_summary <- NULL
  warning("Alpha diversity data not available")
}

if(exists("df_qpcr_sum")) {
  df_qpcr_0_summary <- df_qpcr_sum %>% 
    mutate(plotid = as.character(plotid))
  print("qPCR data available for summary")
} else {
  df_qpcr_0_summary <- NULL
  warning("qPCR data not available")
}

# Create comprehensive summary dataset
df_eea_5_summary <- df_eea_4_final %>%
  mutate(plotid = as.character(Plot))

# Add alpha diversity if available
if(!is.null(df_alpha_0_summary)) {
  df_eea_5_summary <- df_eea_5_summary %>%
    left_join(df_alpha_0_summary, by = c("plotid", "Layer"))
}

# Add qPCR data if available
if(!is.null(df_qpcr_0_summary)) {
  df_eea_5_summary <- df_eea_5_summary %>%
    left_join(df_qpcr_0_summary, by = "plotid")
}

# Add soil temperature mean if warming data available
if(!is.null(df_warming_1_monthly)) {
  # Find temperature columns first
  temp_cols <- df_eea_5_summary %>% select(contains("Temp_mean")) %>% names()
  
  if(length(temp_cols) > 0) {
    df_eea_5_summary <- df_eea_5_summary %>%
      mutate("Soil temperature" = rowMeans(select(., all_of(temp_cols)), na.rm = TRUE))
  } else {
    # If no temperature columns found, add individual temperature variables if available
    if("pinTemp_mean" %in% colnames(df_eea_5_summary) & "deepTemp_mean" %in% colnames(df_eea_5_summary)) {
      df_eea_5_summary <- df_eea_5_summary %>%
        mutate("Soil temperature" = rowMeans(cbind(pinTemp_mean, deepTemp_mean), na.rm = TRUE))
    } else if("pinTemp_mean" %in% colnames(df_eea_5_summary)) {
      df_eea_5_summary <- df_eea_5_summary %>%
        mutate("Soil temperature" = pinTemp_mean)
    }
  }
}

print("Summary dataset for correlations created")
```

# Step 5: Statistics
## Step 5a: Normality tests and data preparation
```{r}
# Test normality of EEA activity data
print("=== NORMALITY TESTS FOR EEA ACTIVITIES ===")

# Shapiro-Wilk test for C acquisition (GLU)
eea_c_data <- df_eea_1_main %>% filter(Enzyme == "GLU", !is.na(Activity_OM))
if(nrow(eea_c_data) <= 5000) {
  shapiro_c <- shapiro.test(eea_c_data$Activity_OM)
  print("Carbon acquisition (GLU) normality test:")
  print(shapiro_c)
} else {
  print("Carbon acquisition dataset too large for Shapiro-Wilk test")
}

# Shapiro-Wilk test for N acquisition (CHI + LEU)
eea_n_data <- df_eea_1_main %>% filter(Enzyme %in% c("CHI", "LEU"), !is.na(Activity_OM))
if(nrow(eea_n_data) <= 5000) {
  shapiro_n <- shapiro.test(eea_n_data$Activity_OM)
  print("Nitrogen acquisition (CHI + LEU) normality test:")
  print(shapiro_n)
} else {
  print("Nitrogen acquisition dataset too large for Shapiro-Wilk test")
}

# QQ plots for visual assessment
print("Generating QQ plots for visual normality assessment...")

qqplot_c <- df_eea_1_main %>%
  filter(Enzyme == "GLU") %>%
  ggplot(aes(sample = Activity_OM)) +
    stat_qq() +
    stat_qq_line() +
    labs(title = "QQ Plot - Carbon Acquisition (Original Scale)", 
         x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_JM

qqplot_n <- df_eea_1_main %>%
  filter(Enzyme %in% c("CHI", "LEU")) %>%
  ggplot(aes(sample = Activity_OM)) +
    stat_qq() +
    stat_qq_line() +
    labs(title = "QQ Plot - Nitrogen Acquisition (Original Scale)", 
         x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_JM

qqplot_c
qqplot_n
```

## Step 5b: Mixed-effects models (factorial analysis)
```{r}
# Standard linear mixed-effects models
print("=== STANDARD LINEAR MIXED-EFFECTS MODELS ===")

# Carbon acquisition model
stat_model_C <- lmer(Activity_OM ~ Zone * Treatment * Layer + (1|Plot/core_id), 
                     data = df_eea_1_main %>% filter(Enzyme == "GLU"))

# Nitrogen acquisition model  
stat_model_N <- lmer(Activity_OM ~ Zone * Treatment * Layer + (1|Plot/core_id), 
                     data = df_eea_1_main %>% filter(Enzyme %in% c("LEU", "CHI")))

# Model diagnostics
print("=== MODEL DIAGNOSTICS ===")
print("Carbon acquisition model diagnostics:")
check_model(stat_model_C)

print("Nitrogen acquisition model diagnostics:")
check_model(stat_model_N)

# Test residual normality
shapiro.test(resid(stat_model_C))
shapiro.test(resid(stat_model_N))

# ANOVA results
print("=== ANOVA RESULTS - STANDARD MODELS ===")
print("Carbon acquisition:")
anova(stat_model_C)

print("Nitrogen acquisition:")
anova(stat_model_N)
```

## Step 5c: Pairwise comparisons using emmeans
```{r}
# Choose the standard lmer models for pairwise comparisons
print("=== PAIRWISE COMPARISONS - STANDARD MODELS ===")

# Main effects
print("--- ZONE COMPARISONS ---")
stat_C_zone_emm <- emmeans(stat_model_C, ~ Zone)
print("Carbon acquisition by Zone:")
pairs(stat_C_zone_emm)

stat_N_zone_emm <- emmeans(stat_model_N, ~ Zone)
print("Nitrogen acquisition by Zone:")
pairs(stat_N_zone_emm)

print("--- TREATMENT COMPARISONS ---")
stat_C_treatment_emm <- emmeans(stat_model_C, ~ Treatment)
print("Carbon acquisition by Treatment:")
pairs(stat_C_treatment_emm)

stat_N_treatment_emm <- emmeans(stat_model_N, ~ Treatment)
print("Nitrogen acquisition by Treatment:")
pairs(stat_N_treatment_emm)

print("--- LAYER COMPARISONS ---")
stat_C_layer_emm <- emmeans(stat_model_C, ~ Layer)
print("Carbon acquisition by Layer:")
pairs(stat_C_layer_emm)

stat_N_layer_emm <- emmeans(stat_model_N, ~ Layer)
print("Nitrogen acquisition by Layer:")
pairs(stat_N_layer_emm)

# Interaction effects
print("--- ZONE x TREATMENT INTERACTIONS ---")
stat_C_zone_treatment_emm <- emmeans(stat_model_C, ~ Zone * Treatment)
print("Carbon acquisition Zone x Treatment:")
pairs(stat_C_zone_treatment_emm)

stat_N_zone_treatment_emm <- emmeans(stat_model_N, ~ Zone * Treatment)
print("Nitrogen acquisition Zone x Treatment:")
pairs(stat_N_zone_treatment_emm)

print("--- ZONE x LAYER INTERACTIONS ---")
stat_C_zone_layer_emm <- emmeans(stat_model_C, ~ Zone * Layer)
print("Carbon acquisition Zone x Layer:")
pairs(stat_C_zone_layer_emm)

stat_N_zone_layer_emm <- emmeans(stat_model_N, ~ Zone * Layer)
print("Nitrogen acquisition Zone x Layer:")
pairs(stat_N_zone_layer_emm)

print("--- TREATMENT x LAYER INTERACTIONS ---")
stat_C_treatment_layer_emm <- emmeans(stat_model_C, ~ Treatment * Layer)
print("Carbon acquisition Treatment x Layer:")
pairs(stat_C_treatment_layer_emm)

stat_N_treatment_layer_emm <- emmeans(stat_model_N, ~ Treatment * Layer)
print("Nitrogen acquisition Treatment x Layer:")
pairs(stat_N_treatment_layer_emm)

print("--- THREE-WAY INTERACTIONS ---")
stat_C_treatment_layer_zone_emm <- emmeans(stat_model_C, ~ Treatment * Layer * Zone)
print("Carbon acquisition Treatment x Layer x Zone:")
pairs(stat_C_treatment_layer_zone_emm)

stat_N_treatment_layer_zone_emm <- emmeans(stat_model_N, ~ Treatment * Layer * Zone)
print("Nitrogen acquisition Treatment x Layer x Zone:")
pairs(stat_N_treatment_layer_zone_emm)
```

## Step 5d: Regression analyses with environmental variables
```{r}
# Check if environmental variables are available
if(!is.null(df_warming_1_monthly) && "Elevation_mean" %in% colnames(df_eea_4_final)) {
  
  print("=== ENVIRONMENTAL REGRESSION ANALYSES ===")
  
  # Calculate mean temperature if multiple sensors available
  if(all(c("pinTemp_mean", "deepTemp_mean") %in% colnames(df_eea_4_final))) {
    df_eea_4_final <- df_eea_4_final %>%
      mutate(meanTemp = rowMeans(select(., pinTemp_mean, deepTemp_mean), na.rm = TRUE))
    
    print("--- TEMPERATURE REGRESSIONS ---")
    # Regressions with mean temperature
    temp_c_model <- lm(Activity_C ~ meanTemp, data = df_eea_4_final)
    temp_n_model <- lm(Activity_N ~ meanTemp, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Mean temperature:")
    print(summary(temp_c_model))
    
    print("Nitrogen acquisition ~ Mean temperature:")
    print(summary(temp_n_model))
    
  } else if("pinTemp_mean" %in% colnames(df_eea_4_final)) {
    print("--- PIN TEMPERATURE REGRESSIONS ---")
    # Regressions with pin temperature only
    pin_temp_c_model <- lm(Activity_C ~ pinTemp_mean, data = df_eea_4_final)
    pin_temp_n_model <- lm(Activity_N ~ pinTemp_mean, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Pin temperature:")
    print(summary(pin_temp_c_model))
    
    print("Nitrogen acquisition ~ Pin temperature:")
    print(summary(pin_temp_n_model))
  }
  
  print("--- ELEVATION REGRESSIONS ---")
  # Elevation regressions - overall
  elev_c_model <- lm(Activity_C ~ Elevation_mean, data = df_eea_4_final)
  elev_n_model <- lm(Activity_N ~ Elevation_mean, data = df_eea_4_final)
  
  print("Carbon acquisition ~ Elevation (all layers):")
  print(summary(elev_c_model))
  
  print("Nitrogen acquisition ~ Elevation (all layers):")
  print(summary(elev_n_model))
  
  # Elevation regressions by layer
  if("Layer" %in% colnames(df_eea_4_final)) {
    
    # Topsoil
    topsoil_data <- df_eea_4_final %>% filter(grepl("Topsoil", Layer))
    if(nrow(topsoil_data) > 0) {
      elev_c_top_model <- lm(Activity_C ~ Elevation_mean, data = topsoil_data)
      elev_n_top_model <- lm(Activity_N ~ Elevation_mean, data = topsoil_data)
      
      print("Carbon acquisition ~ Elevation (topsoil only):")
      print(summary(elev_c_top_model))
      
      print("Nitrogen acquisition ~ Elevation (topsoil only):")
      print(summary(elev_n_top_model))
    }
    
    # Subsoil
    subsoil_data <- df_eea_4_final %>% filter(grepl("Subsoil", Layer))
    if(nrow(subsoil_data) > 0) {
      elev_c_sub_model <- lm(Activity_C ~ Elevation_mean, data = subsoil_data)
      elev_n_sub_model <- lm(Activity_N ~ Elevation_mean, data = subsoil_data)
      
      print("Carbon acquisition ~ Elevation (subsoil only):")
      print(summary(elev_c_sub_model))
      
      print("Nitrogen acquisition ~ Elevation (subsoil only):")
      print(summary(elev_n_sub_model))
    }
  }
  
  # Reduction index regressions if available
  if("ri" %in% colnames(df_eea_4_final)) {
    print("--- REDUCTION INDEX REGRESSIONS ---")
    
    ri_c_model <- lm(Activity_C ~ ri, data = df_eea_4_final)
    ri_n_model <- lm(Activity_N ~ ri, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Reduction index:")
    print(summary(ri_c_model))
    
    print("Nitrogen acquisition ~ Reduction index:")
    print(summary(ri_n_model))
  }
  
  # Multi-variable regression if data available
  if(all(c("meanTemp", "Elevation_mean", "ri") %in% colnames(df_eea_4_final))) {
    print("--- MULTIVARIATE REGRESSIONS ---")
    
    multi_c_model <- lm(Activity_C ~ meanTemp + Elevation_mean + ri, data = df_eea_4_final)
    multi_n_model <- lm(Activity_N ~ meanTemp + Elevation_mean + ri, data = df_eea_4_final)
    
    print("Carbon acquisition ~ Temperature + Elevation + Reduction index:")
    print(summary(multi_c_model))
    
    print("Nitrogen acquisition ~ Temperature + Elevation + Reduction index:")
    print(summary(multi_n_model))
  }
  
} else {
  warning("Environmental data not available - skipping regression analyses")
}

# Include alpha diversity in regressions if available
if(!is.null(df_alpha_0_summary) && exists("df_eea_5_summary")) {
  print("=== ALPHA DIVERSITY REGRESSIONS ===")
  
  if("meanTemp" %in% colnames(df_eea_5_summary)) {
    alpha_temp_model <- lm(Alpha_diversity ~ meanTemp, data = df_eea_5_summary)
    print("Alpha diversity ~ Mean temperature:")
    print(summary(alpha_temp_model))
  }
  
  if("Elevation_mean" %in% colnames(df_eea_5_summary)) {
    alpha_elev_model <- lm(Alpha_diversity ~ Elevation_mean, data = df_eea_5_summary)
    print("Alpha diversity ~ Elevation:")
    print(summary(alpha_elev_model))
  }
  
  if("ri" %in% colnames(df_eea_5_summary)) {
    alpha_ri_model <- lm(Alpha_diversity ~ ri, data = df_eea_5_summary)
    print("Alpha diversity ~ Reduction index:")
    print(summary(alpha_ri_model))
  }
}
```

# Step 6: Save final datasets
```{r}
# Save final EEA dataset for use in other scripts
write.csv(df_eea_4_final, here("data", "eea", "df_EEA_final.csv"), row.names = FALSE)

print("Final EEA dataset saved for downstream analysis")
```

# Step 7: Summary of dataframes
```{r}
# Summary of EEA analysis datasets
print("=== EEA ANALYSIS DATASETS SUMMARY ===")

print("=== EEA MAIN DATA (df_eea_1_main) ===")
str(df_eea_1_main)
print("Sample distribution by enzyme:")
table(df_eea_1_main$Enzyme)

print("=== EEA FINAL DATA (df_eea_4_final) ===")
str(df_eea_4_final)
print("Sample distribution by treatment and zone:")
table(df_eea_4_final$Treatment, df_eea_4_final$Zone)

print("=== C/N RATIO DATA (df_eea_0_cn_ratio) ===")
str(df_eea_0_cn_ratio)
summary(df_eea_0_cn_ratio$GLU_CHI_ratio)

print("=== EEA ACTIVITY SUMMARY ===")
summary(df_eea_4_final[c("Activity_C", "Activity_N", "CN_ratio")])
```

# Step 8: REVISION - Deviation plots relative to ambient baseline
## Step 8a: Calculate deviations from ambient baseline
```{r}
# Calculate deviations at plot level for proper standard error calculation
print("=== CALCULATING DEVIATIONS FROM AMBIENT BASELINE - PLOT MEANS APPROACH ===")

# Check unique layer and treatment values in raw data
print("Unique layer values in raw data:")
print(unique(df_eea_1_main$Layer))
print("Unique treatment values in raw data:")
print(unique(df_eea_1_main$Treatment))

# Clean and standardize layer and treatment names in raw data
df_eea_1_main_clean <- df_eea_1_main %>%
  mutate(
    Layer_clean = case_when(
      grepl("Topsoil|0-30", Layer, ignore.case = TRUE) ~ "Topsoil (0-30 cm)",
      grepl("Subsoil|40-100", Layer, ignore.case = TRUE) ~ "Subsoil (40-100 cm)",
      TRUE ~ as.character(Layer)
    ),
    Treatment_clean = case_when(
      grepl("1\\.5|Low", Treatment, ignore.case = TRUE) ~ "+1.5°C",
      grepl("3\\.0|Medium", Treatment, ignore.case = TRUE) ~ "+3.0°C", 
      grepl("High", Treatment, ignore.case = TRUE) ~ "+3.0°C",
      grepl("ambient", Treatment, ignore.case = TRUE) ~ "ambient",
      TRUE ~ as.character(Treatment)
    ),
    Plot = substr(ID.y, 1, 3)  # Extract plot ID
  )

# Debug: Check cleaned values
print("Cleaned layer values:")
print(unique(df_eea_1_main_clean$Layer_clean))
print("Cleaned treatment values:")
print(unique(df_eea_1_main_clean$Treatment_clean))

# Step 1: Calculate plot means (average across subplots within each plot)
df_eea_plot_means <- df_eea_1_main_clean %>%
  # Remove original columns to avoid naming conflicts
  select(-Layer, -Treatment) %>%
  rename(Layer = Layer_clean, Treatment = Treatment_clean) %>%
  group_by(Zone, Layer, Treatment, Enzyme, Plot) %>%
  summarise(
    Activity_plot_mean = mean(Activity_OM, na.rm = TRUE),
    n_subplots = n(),
    .groups = "drop"
  ) %>%
  # Apply proper factor levels
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("ambient", "+1.5°C", "+3.0°C"))
  )

print("=== PLOT MEANS CALCULATED ===")
print(paste("Number of plot means:", nrow(df_eea_plot_means)))
print("Sample of plot means:")
print(head(df_eea_plot_means))

# Step 2: Calculate ambient baseline means for each Zone/Layer/Enzyme combination
df_eea_baseline_means <- df_eea_plot_means %>%
  filter(Treatment == "ambient") %>%
  group_by(Zone, Layer, Enzyme) %>%
  summarise(Activity_ambient_mean = mean(Activity_plot_mean, na.rm = TRUE),
            n_ambient_plots = n(),
            .groups = "drop")

print("=== AMBIENT BASELINE MEANS ===")
print(df_eea_baseline_means)

# Step 3: Calculate deviations for each plot (warming plots only)
df_eea_plot_deviations <- df_eea_plot_means %>%
  filter(Treatment != "ambient") %>%  # Remove ambient (it becomes the baseline)
  # Join with baseline means
  left_join(df_eea_baseline_means, by = c("Zone", "Layer", "Enzyme")) %>%
  # Calculate deviation for each plot mean
  mutate(
    Activity_deviation = Activity_plot_mean - Activity_ambient_mean,
    Activity_percent_change = ((Activity_plot_mean - Activity_ambient_mean) / Activity_ambient_mean) * 100
  ) %>%
  # Update factor levels (remove ambient)
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

print("=== PLOT-LEVEL DEVIATIONS CALCULATED ===")
print(paste("Number of plot deviations:", nrow(df_eea_plot_deviations)))
print("Sample of plot deviations:")
print(head(df_eea_plot_deviations[, c("Zone", "Layer", "Treatment", "Enzyme", "Plot", "Activity_plot_mean", "Activity_ambient_mean", "Activity_deviation")]))

# Step 4: Calculate summary statistics (means and standard errors) from plot deviations
df_eea_deviations_summary <- df_eea_plot_deviations %>%
  group_by(Zone, Layer, Treatment, Enzyme) %>%
  summarise(
    n_plots = n(),
    Activity_deviation_mean = mean(Activity_deviation, na.rm = TRUE),
    Activity_deviation_se = sd(Activity_deviation, na.rm = TRUE) / sqrt(n()),
    Activity_deviation_sd = sd(Activity_deviation, na.rm = TRUE),
    Activity_percent_change_mean = mean(Activity_percent_change, na.rm = TRUE),
    Activity_percent_change_se = sd(Activity_percent_change, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  # Ensure factors are maintained
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

print("=== SUMMARY STATISTICS FROM PLOT DEVIATIONS ===")
print("Summary statistics table:")
print(df_eea_deviations_summary)

# Check for any remaining NA values
print("NA check:")
print(paste("Zone NAs:", sum(is.na(df_eea_deviations_summary$Zone))))
print(paste("Layer NAs:", sum(is.na(df_eea_deviations_summary$Layer))))
print(paste("Treatment NAs:", sum(is.na(df_eea_deviations_summary$Treatment))))
print(paste("Deviation SE NAs:", sum(is.na(df_eea_deviations_summary$Activity_deviation_se))))

# Keep the plot deviations for statistical tests
df_eea_deviations <- df_eea_plot_deviations

# Keep the summary for plotting
df_eea_deviations_se <- df_eea_deviations_summary

print("=== DEVIATION CALCULATION COMPLETED ===")
print("Plot-level deviations available in: df_eea_deviations")
print("Summary with proper SE available in: df_eea_deviations_se")
print("Standard errors calculated from plot-level deviations (proper replication)")
```

## Step 8b: Create deviation plots for enzyme activities
```{r}
# Create deviation plots using properly calculated standard errors from individual measurements
print("=== CREATING DEVIATION PLOTS WITH PROPER STANDARD ERRORS ===")

# Debug: Check input data structure
print("Summary data structure:")
print(paste("Rows in df_eea_deviations_se:", nrow(df_eea_deviations_se)))
print("Columns:", paste(colnames(df_eea_deviations_se), collapse = ", "))
print("Sample data:")
print(head(df_eea_deviations_se))

# Check factor levels
print("Factor levels check:")
print(paste("Zone levels:", paste(levels(df_eea_deviations_se$Zone), collapse = ", ")))
print(paste("Layer levels:", paste(levels(df_eea_deviations_se$Layer), collapse = ", ")))
print(paste("Treatment levels:", paste(levels(df_eea_deviations_se$Treatment), collapse = ", ")))

# Deviation plot for carbon acquisition (GLU) - using proper SE from individual measurements
plot_EEA_deviation_C <- df_eea_deviations_se %>%
  filter(Enzyme == "GLU") %>%
  ggplot(aes(x = Treatment, y = Activity_deviation_mean, fill = Treatment)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9),
             alpha = 0.9, width = 0.7) +
    geom_errorbar(aes(ymin = Activity_deviation_mean - Activity_deviation_se,
                      ymax = Activity_deviation_mean + Activity_deviation_se),
                  position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Carbon acquisition deviation", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]"))) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.spacing = unit(1, "lines"))

# Deviation plot for nitrogen acquisition (CHI + LEU combined)
# Need to calculate combined deviations from plot-level data
df_eea_deviations_N_plot <- df_eea_plot_deviations %>%
  filter(Enzyme %in% c("CHI", "LEU")) %>%
  # Sum CHI and LEU deviations for each plot
  group_by(Zone, Layer, Treatment, Plot) %>%
  summarise(Activity_deviation_combined = sum(Activity_deviation, na.rm = TRUE),
            Activity_percent_change_combined = sum(Activity_percent_change, na.rm = TRUE),
            .groups = "drop") %>%
  # Ensure factors are maintained
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

# Calculate summary statistics for combined nitrogen deviations at plot level
df_eea_deviations_N_combined <- df_eea_deviations_N_plot %>%
  group_by(Zone, Layer, Treatment) %>%
  summarise(
    n_plots = n(),
    Activity_deviation_mean = mean(Activity_deviation_combined, na.rm = TRUE),
    Activity_deviation_se = sd(Activity_deviation_combined, na.rm = TRUE) / sqrt(n()),
    Activity_deviation_sd = sd(Activity_deviation_combined, na.rm = TRUE),
    Activity_percent_change_mean = mean(Activity_percent_change_combined, na.rm = TRUE),
    Activity_percent_change_se = sd(Activity_percent_change_combined, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  # Ensure factors are maintained
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

# Debug nitrogen data
print("Nitrogen combined data check:")
print(paste("Rows in nitrogen combined data:", nrow(df_eea_deviations_N_combined)))
print("Sample nitrogen data:")
print(head(df_eea_deviations_N_combined))
print("Layer levels in nitrogen data:")
print(levels(df_eea_deviations_N_combined$Layer))

plot_EEA_deviation_N <- df_eea_deviations_N_combined %>%
  ggplot(aes(x = Treatment, y = Activity_deviation_mean, fill = Treatment)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9),
             alpha = 0.9, width = 0.7) +
    geom_errorbar(aes(ymin = Activity_deviation_mean - Activity_deviation_se,
                      ymax = Activity_deviation_mean + Activity_deviation_se),
                  position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Nitrogen acquisition deviation", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]"))) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.spacing = unit(1, "lines"))

# Combined deviation plot
plot_CN_deviations <- ggarrange(
  plot_EEA_deviation_C,
  plot_EEA_deviation_N,
  ncol = 1,
  heights = c(1, 1.2),
  labels = c("A", "B"),
  font.label = list(size = 16, face = "bold")
)

plot_CN_deviations

print("=== DEVIATION PLOTS WITH PROPER STANDARD ERRORS COMPLETED ===")
print("Standard errors calculated from individual subplot measurements")
```

## Step 8c: Create percent change plots
```{r}
# Percent change plot for carbon acquisition
plot_EEA_percent_C <- df_eea_deviations_se %>%
  filter(Enzyme == "GLU") %>%
  ggplot(aes(x = Treatment, y = Activity_percent_change_mean, fill = Treatment)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9),
             alpha = 0.9, width = 0.7) +
    geom_errorbar(aes(ymin = Activity_percent_change_mean - Activity_percent_change_se,
                      ymax = Activity_percent_change_mean + Activity_percent_change_se),
                  position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = "Carbon acquisition % change from ambient") +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.spacing = unit(1, "lines"))

# Percent change plot for nitrogen acquisition
plot_EEA_percent_N <- df_eea_deviations_N_combined %>%
  ggplot(aes(x = Treatment, y = Activity_percent_change_mean, fill = Treatment)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9),
             alpha = 0.9, width = 0.7) +
    geom_errorbar(aes(ymin = Activity_percent_change_mean - Activity_percent_change_se,
                      ymax = Activity_percent_change_mean + Activity_percent_change_se),
                  position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    scale_fill_manual(values = c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = "Nitrogen acquisition % change from ambient") +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.spacing = unit(1, "lines"))

# Combined percent change plot
plot_CN_percent <- ggarrange(
  plot_EEA_percent_C,
  plot_EEA_percent_N,
  ncol = 1,
  heights = c(1, 1.2),
  labels = c("A", "B"),
  font.label = list(size = 16, face = "bold")
)

plot_CN_percent
```

## Step 8e: Statistical tests for deviations from baseline
```{r}
# Test if warming treatments significantly differ from zero (ambient baseline)
print("=== STATISTICAL TESTS: WARMING TREATMENTS vs AMBIENT BASELINE ===")

# Ensure factors are properly ordered before statistical tests
df_eea_deviations_stats <- df_eea_deviations %>%
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

# One-sample t-tests against zero (ambient baseline) for each combination
# Carbon acquisition tests
print("--- CARBON ACQUISITION DEVIATION TESTS ---")
carbon_test_results <- df_eea_deviations_stats %>%
  filter(Enzyme == "GLU") %>%
  group_by(Zone, Layer, Treatment) %>%
  summarise(
    n_samples = n(),
    mean_deviation = mean(Activity_deviation, na.rm = TRUE),
    se_deviation = sd(Activity_deviation, na.rm = TRUE) / sqrt(n()),
    t_test_p = if(n() > 1) t.test(Activity_deviation, mu = 0)$p.value else NA,
    t_statistic = if(n() > 1) t.test(Activity_deviation, mu = 0)$statistic else NA,
    significant = if(!is.na(t_test_p)) t_test_p < 0.05 else FALSE,
    .groups = "drop"
  ) %>%
  # Maintain factor ordering
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

print("Carbon acquisition deviation test results:")
print(carbon_test_results)

# Nitrogen acquisition tests (combined CHI + LEU)
print("--- NITROGEN ACQUISITION DEVIATION TESTS ---")
# Use the plot-level nitrogen deviation data instead of aggregated stats
nitrogen_test_results <- df_eea_deviations_N_plot %>%
  group_by(Zone, Layer, Treatment) %>%
  summarise(
    n_samples = n(),
    mean_deviation = mean(Activity_deviation_combined, na.rm = TRUE),
    se_deviation = sd(Activity_deviation_combined, na.rm = TRUE) / sqrt(n()),
    t_test_p = if(n() > 1) t.test(Activity_deviation_combined, mu = 0)$p.value else NA,
    t_statistic = if(n() > 1) t.test(Activity_deviation_combined, mu = 0)$statistic else NA,
    significant = if(!is.na(t_test_p)) t_test_p < 0.05 else FALSE,
    .groups = "drop"
  ) %>%
  # Maintain factor ordering
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

print("Nitrogen acquisition deviation test results:")
print(nitrogen_test_results)

# Combine all test results for export
all_test_results <- bind_rows(
  carbon_test_results %>% mutate(Enzyme_group = "Carbon"),
  nitrogen_test_results %>% mutate(Enzyme_group = "Nitrogen")
)

# Create summary of significant effects
significant_effects <- all_test_results %>%
  filter(significant == TRUE) %>%
  mutate(effect_direction = ifelse(mean_deviation > 0, "Positive", "Negative"))

print("=== SUMMARY OF SIGNIFICANT WARMING EFFECTS ===")
print(significant_effects)

# Export statistical test results
write.csv(all_test_results, here("data", "eea", "df_EEA_deviation_tests.csv"), row.names = FALSE)
```

## Step 8f: Enhanced plots with significance indicators
```{r}
print("=== CREATING ENHANCED DEVIATION PLOTS WITH SIGNIFICANCE ===")

# Prepare carbon plot data with proper factor levels
df_eea_plot_data_C <- df_eea_deviations_se %>%
  filter(Enzyme == "GLU") %>%
  # Ensure proper factor ordering
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  ) %>%
  left_join(carbon_test_results %>% select(Zone, Layer, Treatment, significant), 
            by = c("Zone", "Layer", "Treatment")) %>%
  mutate(
    significance_label = ifelse(significant, "*", ""),
    y_position = 400  # Fixed position at y = 400 as requested
  ) %>%
  # Re-apply factor levels after join
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

# Debug: Check factor levels
print("=== CARBON PLOT DATA FACTOR LEVELS ===")
print(paste("Zone levels:", paste(levels(df_eea_plot_data_C$Zone), collapse = ", ")))
print(paste("Layer levels:", paste(levels(df_eea_plot_data_C$Layer), collapse = ", ")))
print(paste("Treatment levels:", paste(levels(df_eea_plot_data_C$Treatment), collapse = ", ")))

# Enhanced carbon acquisition deviation plot with significance
plot_EEA_deviation_C_sig <- df_eea_plot_data_C %>%
  ggplot(aes(x = Treatment, y = Activity_deviation_mean, fill = Treatment)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9),
             alpha = 0.9, width = 0.7) +
    geom_errorbar(aes(ymin = Activity_deviation_mean - Activity_deviation_se,
                      ymax = Activity_deviation_mean + Activity_deviation_se),
                  position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    geom_text(aes(y = y_position, label = significance_label), 
              size = 8, position = position_dodge(width = 0.9)) +
    scale_fill_manual(values = c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Carbon acquisition deviation", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]")),
                      limits = c(-500, 500)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing = unit(1, "lines")
    )

# Prepare nitrogen data with significance and proper factor levels
df_eea_plot_data_N <- df_eea_deviations_N_combined %>%
  # Ensure proper factor ordering
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  ) %>%
  left_join(nitrogen_test_results %>% select(Zone, Layer, Treatment, significant), 
            by = c("Zone", "Layer", "Treatment")) %>%
  mutate(
    significance_label = ifelse(significant, "*", ""),
    y_position = 400  # Fixed position at y = 400 as requested
  ) %>%
  # Re-apply factor levels after join
  mutate(
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-100 cm)")),
    Treatment = factor(Treatment, levels = c("+1.5°C", "+3.0°C"))
  )

# Debug: Check nitrogen factor levels
print("=== NITROGEN PLOT DATA FACTOR LEVELS ===")
print(paste("Zone levels:", paste(levels(df_eea_plot_data_N$Zone), collapse = ", ")))
print(paste("Layer levels:", paste(levels(df_eea_plot_data_N$Layer), collapse = ", ")))
print(paste("Treatment levels:", paste(levels(df_eea_plot_data_N$Treatment), collapse = ", ")))

# Enhanced nitrogen acquisition deviation plot with significance
plot_EEA_deviation_N_sig <- df_eea_plot_data_N %>%
  ggplot(aes(x = Treatment, y = Activity_deviation_mean, fill = Treatment)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.9),
             alpha = 0.9, width = 0.7) +
    geom_errorbar(aes(ymin = Activity_deviation_mean - Activity_deviation_se,
                      ymax = Activity_deviation_mean + Activity_deviation_se),
                  position = position_dodge(width = 0.9), width = 0.25, color = "black") +
    geom_text(aes(y = y_position, label = significance_label), 
              size = 8, position = position_dodge(width = 0.9)) +
    scale_fill_manual(values = c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Nitrogen acquisition deviation", " ", " [", "nmol", "*", "g", " ", "OM"^-1, "*", "h"^-1, "]")),
                      limits = c(-500, 500)) +
    facet_grid(Layer ~ Zone) +
    theme_JM +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing = unit(1, "lines")
    )

# Combined deviation plot with significance indicators
plot_CN_deviations_sig <- ggarrange(
  plot_EEA_deviation_C_sig,
  plot_EEA_deviation_N_sig,
  ncol = 1,
  heights = c(1, 1.2),
  labels = c("A", "B"),
  font.label = list(size = 16, face = "bold")
)

plot_CN_deviations_sig

print("REVISION: Enhanced deviation plots with statistical significance indicators completed")
```

---

## REVISION DOCUMENTATION - September 2025

### Changes Made During Revision:
1. **Added Step 8: Deviation Analysis**
   - Implemented deviation calculations from ambient baseline for all enzyme activities
   - Created deviation bar plots showing warming effects relative to control (ambient = 0)
   - Added statistical significance testing with one-sample t-tests
   - Enhanced visualization with significance indicators (*) positioned at y = 400

2. **Plot Modifications:**
   - Fixed y-axis scaling to -500 to +500 for all panels for consistency
   - Positioned significance stars at y = 400 across all panels for uniform visibility
   - Increased star size to 8 for better readability
   - Maintained consistent color scheme: #FDAE61 for +1.5°C, #D73027 for +3.0°C

3. **Statistical Framework:**
   - Plot-level deviation calculations for proper standard error estimation
   - One-sample t-tests comparing warming treatments against zero (no deviation)
   - Significance threshold: p < 0.05 indicated with asterisks

4. **Output Files Generated:**
   - `df_EEA_deviations.csv`: Complete deviation dataset
   - `df_EEA_deviation_summary.csv`: Summary statistics
   - `df_EEA_deviation_statistical_tests.csv`: Statistical test results

**Rationale**: Enhanced visualization of warming effects relative to ambient baseline with proper statistical framework and consistent presentation standards.

*Last modified: September 15, 2025 | JM*
print("Zone ordering: Pioneer zone → Low marsh → High marsh")  
print("Layer ordering: Topsoil (0-30 cm) → Subsoil (40-100 cm)")
print("* indicates p < 0.05 for one-sample t-test against zero (ambient baseline)")


## Step 8d: Export deviation data for further analysis
```{r}
# Save deviation data for downstream analysis and correlation matrix
write.csv(df_eea_deviations, here("data", "eea", "df_EEA_deviations.csv"), row.names = FALSE)

# Create summary of deviation patterns by zone
df_eea_deviation_summary <- df_eea_deviations %>%
  group_by(Zone, Treatment, Enzyme) %>%
  summarise(
    mean_deviation = mean(Activity_deviation, na.rm = TRUE),
    se_deviation = sd(Activity_deviation, na.rm = TRUE)/sqrt(n()),
    mean_percent_change = mean(Activity_percent_change, na.rm = TRUE),
    se_percent_change = sd(Activity_percent_change, na.rm = TRUE)/sqrt(n()),
    .groups = "drop"
  )

print("=== DEVIATION SUMMARY BY ZONE ===")
print(df_eea_deviation_summary)

# Save deviation summary and statistical test results
write.csv(df_eea_deviation_summary, here("data", "eea", "df_EEA_deviation_summary.csv"), row.names = FALSE)
write.csv(all_test_results, here("data", "eea", "df_EEA_deviation_statistical_tests.csv"), row.names = FALSE)

print("REVISION: Deviation analysis completed and data exported")
print("Files saved:")
print("- df_EEA_deviations.csv: Complete deviation dataset")  
print("- df_EEA_deviation_summary.csv: Summary statistics")
print("- df_EEA_deviation_statistical_tests.csv: Statistical test results")
```

# References
```{r}
# emmeans: Lenth, R. V. (2024). emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version 1.10.2. https://CRAN.R-project.org/package=emmeans
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggpmisc: Aphalo, P. J. (2024). ggpmisc: Miscellaneous Extensions to 'ggplot2'. R package version 0.5.5. https://CRAN.R-project.org/package=ggpmisc
# ggpubr: Kassambara, A. (2024). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0. https://CRAN.R-project.org/package=ggpubr
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
# lme4: Bates, D., Mächler, M., Bolker, B., & Walker, S. (2024). lme4: Linear Mixed-Effects Models using 'Eigen' and S4. R package version 1.1-35. https://CRAN.R-project.org/package=lme4
# lmerTest: Kuznetsova, A., Brockhoff, P. B., & Christensen, R. H. B. (2024). lmerTest: Tests in Linear Mixed Effects Models. R package version 3.1-3. https://CRAN.R-project.org/package=lmerTest
# performance: Lüdecke, D., Ben-Shachar, M. S., Patil, I., Waggoner, P., & Makowski, D. (2024). performance: Assessment of Regression Models Performance. R package version 0.10.8. https://CRAN.R-project.org/package=performance
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
```
