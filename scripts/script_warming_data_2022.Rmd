---
title: "script_warming_data_2022"
author: "Julian Mittmann-Goetsch"
date: "2025-02-11"
output: html_document
---
---
title: "script_warming_data"
author: "Julian Mittmann-Goetsch"
date: "2025-02-05"
output: html_document
---
# Versionlog
## Version 1.0: Basic script with data loading - 11.02.2025 | JM
## Version 1.1: Adapted script to match pre-filtered data from SERC - 10.04.2025 | JM

# Step 1: Prepare R Session
## Step 1a: Install all necessary packages
Here we load all encessary c
```{r message=FALSE, warning=FALSE}
# Troubleshooting with LOCK file
#options("install.lock"=FALSE)  
# Install all necessary packages
  #install.packages("ggplot2")   # plot package
  #install.packages("dplyr")     # quick summarize functions
  #install.packages("lubridate") # convert time formats
  #install.packages("ggpubr")    # further plots options (visual)
  #install.packages("tidyverse") # data preperation tools
  #install.packages("plotly")    # interactive plots for regular checks
  #install.packages("mgcv")      # GAM model
  #install.packages("rpart")     # regression trees
  #install.packages("rpart.plot")# improve regression tree plots
  #install.packages("car)        # ANOVA function for regression trees
```

## Step 1b: Load all necessary packages
```{r}
# Load all necessary packages  
library(ggplot2)
library(dplyr)
library(lubridate)
library(ggpubr)
library(tidyverse)
library(here)
```

## Step 1c: Set global plot theme
```{r}
# Creates a theme for all plots in this study 
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1d: Load warming data
```{r}
# Load cleaned warming data (cleaning protocol from SERC - Roy Rich)
df_warming_2022_0_raw <- read.csv(here("data", "warming", "MERIT_2022_daily_cleaned.csv"))
```

## Step 1e: Filter warming data
```{r}
# We select only the relevatn coloumns from the raw data
df_warming_2022_1_filtered <- df_warming_2022_0_raw %>%
   select(date, yday, plotid, treatment, zone, aboveTemp, airTemp, deepTemp, lagTemp, pinTemp, surfaceTemp, rh_avg, vp_avg, wind_speed_avg,)
```

# Step 2: Plots
## Step 2a: Yearly plot
```{r}
plot_warming_2022 <- df_warming_2022_1_filtered %>%
  ggplot(aes(x = date, y = surfaceTemp, color = treatment)) +
  geom_line() +
  scale_color_manual(values = c("amb" = "#4575B4", "1.5" = "#FDAE61", "3" = "#D73027"), name = "Warming treatment:") +
  theme_JM +
  facet_grid(~ zone)

# All Plots
plot_warming_2022
```

# Step 3: Summarise 
## Step 3a: Summarise warming data
```{r}
df_warming_2022_1_filtered$zone <- recode_factor(df_warming_2022_1_filtered$zone,"PIO" = "PZ", "LM" = "LM", "HM" = "HM")
df_warming_2022_1_filtered$treatment <- recode_factor(df_warming_2022_1_filtered$treatment,"amb" = "ambient", "1.5" = "+1.5°C", "3" = "+3.0°C")

# Filter data for the month of August
df_warming_all_2022_monthly <- df_warming_2022_1_filtered %>%
  filter(between(date(date), as.Date("2022-08-11"), as.Date("2022-09-11"))) %>%
  group_by(zone, treatment, plotid) %>%
  summarise(across(c(pinTemp, aboveTemp, airTemp, lagTemp, deepTemp, surfaceTemp, rh_avg, vp_avg, wind_speed_avg), 
                   list(mean = ~mean(., na.rm = TRUE),
                        se = ~sd(., na.rm = TRUE) / sqrt(sum(!is.na(.))))),
            .groups = "drop")

# Creating a dataframe with temperature 2 weeks before sampling
df_warming_all_2022_weekly <- df_warming_2022_1_filtered %>%
  filter(between(date(date), as.Date("2022-09-01"), as.Date("2022-09-11"))) %>%
  group_by(zone, treatment, plotid) %>%
  summarise(across(c(pinTemp, aboveTemp, airTemp, lagTemp, deepTemp, surfaceTemp, rh_avg, vp_avg, wind_speed_avg), 
                   list(mean = ~mean(., na.rm = TRUE),
                        se = ~sd(., na.rm = TRUE) / sqrt(sum(!is.na(.))))),
            .groups = "drop")

# Creating a dataframe with warming data until the sampling date (yearly)
df_warming_all_2022_yearly <- df_warming_2022_1_filtered %>%
  filter(year(date) == 2022, date(date) <= as.Date("2022-09-11") )%>%
  group_by(zone, treatment, plotid) %>%
  summarise(across(c(pinTemp, aboveTemp, airTemp, lagTemp, deepTemp, surfaceTemp, rh_avg, vp_avg, wind_speed_avg), 
                   list(mean = ~mean(., na.rm = TRUE),
                        se = ~sd(., na.rm = TRUE) / sqrt(sum(!is.na(.))))),
            .groups = "drop")

write.csv(df_warming_all_2022_monthly, "./df_warming_all_2022_monthly.csv")
write.csv(df_warming_all_2022_weekly, "./df_warming_all_2022_weekly.csv")
write.csv(df_warming_all_2022_yearly, "./df_warming_all_2022_yearly.csv")
```

# References
```{r}
# dplyr
# Wickham, H., François, R., Henry, L., Müller, K., Vaughan, D., & PBC, P. S. (2023). dplyr: A Grammar of Data Manipulation. R Package Version 1.1.4 Computer Software. https://doi.org/10.32614/CRAN.package.dplyr

# here
#Müller, K., & Bryan, J. (2020). here: A Simpler Way to Find Your Files. R Package Version 1.0.1 Computer Software. https://doi.org/10.32614/CRAN.package.here

# lubridate
# Spinu, V., Grolemund, G., Wickham, H., Vaughan, D., Lyttle, I., Costigan, I., Law, J., Mitarotonda, D., Larmarange, J., Bosier, J., & Lee, C. H. (2024). lubridate: Make Dealing with Dates a Little Easier. R Package Version 1.9.3 Computer Software, https://cran.r-project.org/web/packages/lubridate/.

```

