---
title: "script_ancombc"
author: "Julian Mittmann-Goetsch"
date: "2025-01-29"
output: html_document
---

# Versionlog
## Version 1.0: Basic outline of the script (29.01.2025)

# Step 1: Prepare session and load data
## Step 1a: Install necessary packages
```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("ANCOMBC")
install.packages("DT")
BiocManager::install("microbiome", force = TRUE)
```


## Step 1b: Load necessary packages
```{r}
options("install.lock"=FALSE)
library(ANCOMBC)
library(tidyverse)
library(DT)
options(DT.options = list(
  initComplete = JS("function(settings, json) {",
  "$(this.api().table().header()).css({'background-color': 
  '#000', 'color': '#fff'});","}")))
library(microbiome)
library(phyloseq)
```

## Step 1c: Load sequencing data
```{r}
# We can use the data from script_community
#df_tab_rare <- read.csv("./table_ASV_filtered_rarefied_5000.csv", dec = ",", sep = ";")
#df_metadata <-  read.delim("./metadata.txt", dec = ".", sep= "\t")
```

## Step 1d: Modify seq data
```{r}
# We can use the data from script_community
# Make ASVs the rownames and remove specified columns
#df_tab_rare <- df_tab_rare %>%
#  column_to_rownames(var = names(df_tab_rare)[1]) %>%
#  select(-c(X136, X137, X138, X139)) 

#df_metadata <- df_metadata %>%
#  rename(Sample_ID = sample_name) %>%
#  mutate(Layer = case_when(
#    Depth %in% c("0-5 cm", "5-10 cm", "20-30 cm") ~ "Top-soil (0-30 cm)",
#    Depth %in% c("40-50 cm", "80-100 cm") ~ "Bottom-soil (40-100 cm)",
#    TRUE ~ NA_character_  # For unexpected values
#  ))

#df_metadata <- df_metadata %>%
#  mutate_at(c(5:9), as.factor)

#df_samp = sample_data(df_metadata) 
#sample_ids <- df_metadata[, 1]
#rownames(df_samp) <- sample_ids
```


## Step 1e: Phyloseq object
```{r}
# We can use the data from script_community
# Phyloseq object with raw data (used for clr transformation)
#ps = phyloseq(
#    otu_table(as.matrix(df_tab_rare[,1:(ncol(df_tab_rare)-6)]), taxa_are_rows=T),
#    tax_table(as.matrix(df_tab_rare[,(ncol(df_tab_rare)-5):ncol(df_tab_rare)])),
#    sample_data(df_samp)
#   )

#ps@sam_data$Treatment <- factor(ps@sam_data$Treatment, 
#                                      levels = c("ambient", "1.5", "3"),
#                                      labels = c("0", "1", "2"))

ps_PZ <- ps_rare %>%
  subset_samples(Zone == "PZ")

ps_LM <- ps_rare %>%
  subset_samples(Zone  == "LM")

ps_HM <- ps_rare %>%
  subset_samples(Zone == "HM")
```



# Step 2: ANCOM-BC Analysis
 Following https://www.bioconductor.org/packages/release/bioc/vignettes/ANCOMBC/inst/doc/ANCOMBC.html 
## Step 2a: Run ancombc function
```{r}
set.seed(123)
output_HM = ancombc2(
  data = ps_HM, 
  tax_level = "Phylum",        # Update to your taxonomic level of interest
  fix_formula = "Treatment",  # Single fixed effect
  rand_formula = NULL,
  p_adj_method = "BH",
  pseudo_sens = TRUE,
  prv_cut = 0.10,
  lib_cut = 1000,
  s0_perc = 0.05,
  group = "Treatment",        # Group for structural zero detection
  struc_zero = TRUE,
  neg_lb = TRUE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = TRUE,             # Set to TRUE if multi-category Treatment
  pairwise = TRUE,           # Set to TRUE for pairwise comparisons
  dunnet = FALSE,             # Set to TRUE for Dunnett-type contrasts
  trend = FALSE,              # Set to TRUE for trend analysis
  iter_control = list(
    tol = 1e-2,
    max_iter = 20,
    verbose = TRUE
  ),
  em_control = list(
    tol = 1e-5,
    max_iter = 100
  ),
  lme_control = lme4::lmerControl(),
  mdfdr_control = list(
    fwer_ctrl_method = "holm",
    B = 100                   # Recommended value for reliability
  )
)

head(output_HM$res) %>%
  #  dplyr::select(starts_with("lfc_age")) %>%
    mutate_if(is.numeric, function(x) round(x, 2)) %>%
    datatable(caption = "Output ANCOM-BC")

res_prim_HM = output_HM$res
```

```{r}
# Select relevant columns for Treatment comparisons
df_treatment = res_prim_HM %>%
  dplyr::select(taxon, contains("ambient"), contains("+1.5°C"), contains("+3.0°C"))

# Create a dataframe for log fold changes and filtering significant taxa
df_fig_treatment1 = df_treatment %>%
  dplyr::filter(`diff_Treatment+1.5°C` == 1 | `diff_Treatment+3.0°C` == 1) %>%  # Compare to ambient
  dplyr::mutate(
    lfc1 = ifelse(`diff_Treatment+1.5°C` == 1, round(`lfc_Treatment+1.5°C`, 2), 0),
    lfc2 = ifelse(`diff_Treatment+3.0°C` == 1, round(`lfc_Treatment+3.0°C`, 2), 0)
  ) %>%
  tidyr::pivot_longer(cols = lfc1:lfc2, names_to = "group", values_to = "value") %>%
  dplyr::arrange(taxon)

# Create a dataframe for coloring based on structural zero checks
df_fig_treatment2 = df_treatment %>%
  dplyr::filter(`diff_Treatment+1.5°C` == 1 | `diff_Treatment+3.0°C` == 1) %>%  # Compare to ambient
  dplyr::mutate(
    lfc1 = ifelse(`passed_ss_Treatment+1.5°C` == 1 & `diff_Treatment+1.5°C` == 1, "aquamarine3", "black"),
    lfc2 = ifelse(`passed_ss_Treatment+3.0°C` == 1 & `diff_Treatment+3.0°C` == 1, "aquamarine3", "black")
  ) %>%
  tidyr::pivot_longer(cols = lfc1:lfc2, names_to = "group", values_to = "color") %>%
  dplyr::arrange(taxon)

# Combine log fold changes and structural zero coloring
df_fig_treatment = df_fig_treatment1 %>%
  dplyr::left_join(df_fig_treatment2, by = c("taxon", "group"))

# Rename and reorder treatment groups for visualization
df_fig_treatment$group = recode(
  df_fig_treatment$group,
  `lfc1` = "+1.5°C - ambient",
  `lfc2` = "+3.0°C - ambient"
)
df_fig_treatment$group = factor(
  df_fig_treatment$group,
  levels = c("+1.5°C - Ambient", "+3.0°C - Ambient")
)

# Set color scale limits and midpoint
lo = floor(min(df_fig_treatment$value))
up = ceiling(max(df_fig_treatment$value))
mid = (lo + up) / 2

# Create the heatmap
fig_treatment = df_fig_treatment %>%
  ggplot(aes(x = group, y = taxon, fill = value)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white",
    na.value = "white", midpoint = mid, limit = c(lo, up),
    name = NULL
  ) +
  geom_text(aes(group, taxon, label = value, color = color), size = 4) +
  scale_color_identity(guide = "none") +
  labs(x = NULL, y = NULL, title = "Log fold changes relative to Ambient conditions") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the heatmap
fig_treatment

```


## Step 2b: Heatmap plot
```{r}
df_Treatment = res_prim_HM %>%
    dplyr::select(taxon, contains("Treatment")) 
df_fig_Treatment1 = df_Treatment %>%
    dplyr::filter("diff_Treatment+3.0°C" == 1 | 
                    "diff_Treatment+1.5°C" == 1) %>%
    dplyr::mutate(lfc1 = ifelse("diff_Treatment+1.5°C" == 1, 
                                round("lfc_Treatment+1.5°C", 2), 0),
                  lfc2 = ifelse("diff_Treatment+3.0°C" == 1, 
                                round("lfc_Treatment+3.0°C", 2), 0)) %>%
    tidyr::pivot_longer(cols = lfc1:lfc2, 
                        names_to = "group", values_to = "value") %>%
    dplyr::arrange(taxon)

df_fig_Treatment2 = df_Treatment %>%
    dplyr::filter("diff_Treatment+3.0°C" == 1 | 
                    "diff_Treatment+1.5°C" == 1) %>%
    dplyr::mutate(lfc1 = ifelse("passed_ss_Treatment+1.5°C" == 1 & "diff_Treatment+1.5°C" == 1, 
                                "aquamarine3", "black"),
                  lfc2 = ifelse("passed_ss_Treatment+3.0°C" == 1 & "diff_Treatment+3.0°C" == 1, 
                                "aquamarine3", "black")) %>%
    tidyr::pivot_longer(cols = lfc1:lfc2, 
                        names_to = "group", values_to = "color") %>%
    dplyr::arrange(taxon)

df_fig_Treatment = df_fig_Treatment1 %>%
    dplyr::left_join(df_fig_Treatment2, by = c("taxon", "group"))

df_fig_Treatment$group = recode(df_fig_Treatment$group, 
                          `lfc1` = "+1.5°C - ambient",
                          `lfc2` = "+3.0°C - ambient")
df_fig_Treatment$group = factor(df_fig_Treatment$group, 
                          levels = c("+1.5°C - ambient",
                                     "+3.0°C - ambient"))
  
lo = floor(min(df_fig_Treatment$value))
up = ceiling(max(df_fig_Treatment$value))
mid = (lo + up)/2

plot_Treatment_HM = df_fig_Treatment %>%
  ggplot(aes(x = group, y = taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, taxon, label = value, color = color), size = 4) +
  scale_color_identity(guide = "none") +
  labs(x = NULL, y = NULL, title = "Log fold changes as compared to ambient plots") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

plot_Treatment_HM
```

## Step 2c: Waterfall plot
```{r}
df_Treatment = res_prim %>%
    dplyr::select(taxon, ends_with("Treatment")) 
df_fig_Treatment = df_Treatment %>%
    dplyr::filter(diff_Treatment == 1) %>% 
    dplyr::arrange(desc(lfc_Treatment)) %>%
    dplyr::mutate(direct = ifelse(lfc_Treatment > 0, "Positive LFC", "Negative LFC"),
                  color = ifelse(passed_ss_Treatment == 1, "aquamarine3", "black"))
df_fig_Treatment$taxon = factor(df_fig_Treatment$taxon, levels = df_fig_Treatment$taxon)
df_fig_Treatment$direct = factor(df_fig_Treatment$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
plot_Treatment = df_fig_Treatment %>%
    ggplot(aes(x = taxon, y = lfc_Treatment, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Treatment - se_Treatment, ymax = lfc_Treatment + se_Treatment), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes as one unit increase of Treatment") + 
    scale_fill_discrete(name = NULL) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1,
                                     color = df_fig_Treatment$color))
plot_Treatment
```




# 5.2 Run ancombc2 function using the phyloseq object
```{r}
set.seed(123)
# It should be noted that we have set the number of bootstrap samples (B) equal 
# to 10 in the 'trend_control' function for computational expediency. 
# However, it is recommended that users utilize the default value of B, 
# which is 100, or larger values for optimal performance.
stat_output = ancombc2(data = ps_rare, tax_level = "Phylum",
                  fix_formula = "Treatment + Zone", rand_formula = NULL,
                  p_adj_method = "holm", pseudo_sens = TRUE,
                  prv_cut = 0.10, lib_cut = 1000, s0_perc = 0.05,
                  group = "Treatment", struc_zero = TRUE, neg_lb = TRUE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = TRUE, pairwise = TRUE, dunnet = TRUE, trend = TRUE,
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2, 1),
                                       solver = "ECOS",
                                       B = 10))
```

```{r}
set.seed(123)
output_interact = ancombc2(data = ps_HM, tax_level = "Phylum",
                          fix_formula = "Treatment", rand_formula = NULL,
                          p_adj_method = "holm", pseudo_sens = TRUE,
                          prv_cut = 0.10, lib_cut = 1000, s0_perc = 0.05,
                          group = "Treatment", struc_zero = TRUE, neg_lb = TRUE,
                          alpha = 0.05, n_cl = 2, verbose = TRUE)

head(output_interact$res) %>%
  #  dplyr::select(starts_with("lfc_age")) %>%
    mutate_if(is.numeric, function(x) round(x, 2)) %>%
    datatable(caption = "Example of including interaction terms")
```
# 5.3 Structural zeros (taxon presence/absence)
```{r}
tab_zero = output$zero_ind
tab_zero %>%
    datatable(caption = "The detection of structural zeros")
```

#s
```{r}
df_Treatment = res_prim %>%
    dplyr::select(taxon, contains("Treatment")) 
df_fig_Treatment1 = df_Treatment %>%
    dplyr::filter(diff_Treatment+3.0°C == 1 | 
                    diff_Treatmentambient == 1) %>%
    dplyr::mutate(lfc1 = ifelse(diff_Treatmentambient == 1, 
                                round(lfc_Treatmentambient, 2), 0),
                  lfc2 = ifelse(diff_Treatment+3.0°C == 1, 
                                round(lfc_Treatment+3.0°C, 2), 0)) %>%
    tidyr::pivot_longer(cols = lfc1:lfc2, 
                        names_to = "group", values_to = "value") %>%
    dplyr::arrange(taxon)

df_fig_Treatment2 = df_Treatment %>%
    dplyr::filter(diff_Treatment+3.0°C == 1 | 
                    diff_Treatmentambient == 1) %>%
    dplyr::mutate(lfc1 = ifelse(passed_ss_Treatmentambient == 1 & diff_Treatmentambient == 1, 
                                "aquamarine3", "black"),
                  lfc2 = ifelse(passed_ss_Treatment+3.0°C == 1 & diff_Treatment+3.0°C == 1, 
                                "aquamarine3", "black")) %>%
    tidyr::pivot_longer(cols = lfc1:lfc2, 
                        names_to = "group", values_to = "color") %>%
    dplyr::arrange(taxon)

df_fig_Treatment = df_fig_Treatment1 %>%
    dplyr::left_join(df_fig_Treatment2, by = c("taxon", "group"))

df_fig_Treatment$group = recode(df_fig_Treatment$group, 
                          `lfc1` = "ambient - +1.5°C",
                          `lfc2` = "+3.0°C - +1.5°C")
df_fig_Treatment$group = factor(df_fig_Treatment$group, 
                          levels = c("ambient - +1.5°C",
                                     "+3.0°C - +1.5°C"))
  
lo = floor(min(df_fig_Treatment$value))
up = ceiling(max(df_fig_Treatment$value))
mid = (lo + up)/2
fig_Treatment = df_fig_Treatment %>%
  ggplot(aes(x = group, y = taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, taxon, label = value, color = color), size = 4) +
  scale_color_identity(guide = "none") +
  labs(x = NULL, y = NULL, title = "Log fold changes as compared to +1.5°C subjects") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
fig_Treatment
```


```{r}
res_global = output$res_global
df_Treatment_global = res_prim %>%
    dplyr::select(taxon, contains("Treatment")) 

df_fig_global = df_Treatment_global %>%
    dplyr::left_join(res_global %>%
                       dplyr::transmute(taxon, 
                                        diff_Treatment = diff_abn, 
                                        passed_ss = passed_ss)) %>%
    dplyr::filter(diff_Treatment == 1) %>%
    dplyr::mutate(lfc_1 = lfc_Treatment1,
                  lfc_2 = lfc_Treatment2,
                  color = ifelse(passed_ss == 1, "aquamarine3", "black")) %>%
    dplyr::transmute(taxon,
                     `1.5 - Ambient` = round(lfc_1, 2),
                     `3.0 - Ambient` = round(lfc_2, 2), 
                     color = color) %>%
    tidyr::pivot_longer(cols = `1.5 - Ambient`:`3.0 - Ambient`, 
                        names_to = "group", values_to = "value") %>%
    dplyr::arrange(taxon)

df_fig_global$group = factor(df_fig_global$group, 
                             levels = c("1.5 - Ambient",
                                        "3.0 - Ambient"))
  
lo = floor(min(df_fig_global$value))
up = ceiling(max(df_fig_global$value))
mid = (lo + up)/2

fig_global = df_fig_global %>%
  ggplot(aes(x = group, y = taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = "Log fold changes for globally significant taxa (vs Ambient)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.y = element_text(color = df_fig_global %>%
                                       dplyr::distinct(taxon, color) %>%
                                       .$color))

fig_global
```

```{r}
# Function to run ANCOMBC2 for a specific Zone
run_ancombc2_for_zone = function(ps_rare, zone) {
    ps_zone = subset_samples(ps_rare, Zone == Zone)
    
    set.seed(123)
    output = ancombc2(data = ps_zone, tax_level = "Phylum",
                      fix_formula = "Treatment", rand_formula = NULL,
                      p_adj_method = "holm", pseudo_sens = TRUE,
                      prv_cut = 0.10, lib_cut = 1000, s0_perc = 0.05,
                      group = "Treatment", struc_zero = TRUE, neg_lb = TRUE,
                      alpha = 0.05, n_cl = 2, verbose = TRUE,
                      global = TRUE, pairwise = TRUE, dunnet = TRUE, trend = TRUE,
                      iter_control = list(tol = 1e-2, max_iter = 20, verbose = TRUE),
                      em_control = list(tol = 1e-5, max_iter = 100),
                      lme_control = lme4::lmerControl(),
                      mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
                      trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                                  nrow = 2, 
                                                                  byrow = TRUE),
                                                           matrix(c(-1, 0, 1, -1),
                                                                  nrow = 2, 
                                                                  byrow = TRUE),
                                                           matrix(c(1, 0, 1, -1),
                                                                  nrow = 2, 
                                                                  byrow = TRUE)),
                                           node = list(2, 2, 1),
                                           solver = "ECOS",
                                           B = 10))
    return(output)
}

# Run ANCOMBC2 for each Zone
output_PZ = run_ancombc2_for_zone(ps, "PZ")
output_LM = run_ancombc2_for_zone(ps, "LM")
output_HM = run_ancombc2_for_zone(ps, "HM")

# Create visualization function
create_zone_plot = function(output, Zone) {
    res_prim = output$res
    df_treatment = res_prim %>% dplyr::select(taxon, contains("Treatment"))

df_fig_treatment = df_treatment %>%
  dplyr::filter(`diff_Treatment+1.5°C` == 1 | `diff_Treatment+3.0°C` == 1) %>%
  dplyr::mutate(
    lfc1 = ifelse(`diff_Treatment+1.5°C` == 1, round(`lfc_Treatment+1.5°C`, 2), 0),
    lfc2 = ifelse(`diff_Treatment+3.0°C` == 1, round(`lfc_Treatment+3.0°C`, 2), 0),
    color1 = ifelse(`passed_ss_Treatment+1.5°C` == 1 & `diff_Treatment+1.5°C` == 1, "aquamarine3", "black"),
    color2 = ifelse(`passed_ss_Treatment+3.0°C` == 1 & `diff_Treatment+3.0°C` == 1, "aquamarine3", "black")
  ) %>%
  tidyr::pivot_longer(
    cols = c(lfc1, lfc2, color1, color2),
    names_to = c(".value", "group"),
    names_pattern = "(\\w+)(\\d+\\.?\\d*)"
  ) %>%
  dplyr::mutate(
    group = recode(group, 
                   `Treatment+1.5°C` = "Treatment+1.5°C - ambient",
                   `Treatment+3.0°C` = "Treatment+3.0°C - ambient"),
    group = factor(group, levels = c("Treatment+1.5°C - Ambient", "Treatment+3.0°C - Ambient"))
  ) %>%
  dplyr::arrange(taxon)
    
    lo = floor(min(df_fig_treatment$lfc))
    up = ceiling(max(df_fig_treatment$lfc))
    mid = (lo + up)/2
    
    ggplot(df_fig_treatment, aes(x = group, y = taxon, fill = lfc)) + 
        geom_tile(color = "black") +
        scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                             na.value = "white", midpoint = mid, limit = c(lo, up),
                             name = NULL) +
        geom_text(aes(label = lfc, color = color), size = 4) +
        scale_color_identity(guide = "none") +
        labs(x = NULL, y = NULL, title = paste("Log fold changes for", zone, "Zone")) +
        theme_minimal() +
        theme(plot.title = element_text(hjust = 0.5))
}

# Generate and display plots for each Zone
plot_PZ = create_zone_plot(output_PZ, "PZ")
plot_LM = create_zone_plot(output_LM, "LM")
plot_HM = create_zone_plot(output_HM, "HM")

plot_PZ
plot_LM
plot_HM
```

