---
title: "Correlation Matrix Analysis"
author: "Julian Mittmann-Goetsch"
date: "2024-08-06"
output: html_document
---

## Version 1.0: Correlation matrix analysis for MERIT variables - 11.02.2025 | JM
## Purpose: Generate correlation matrices for EEA, community, and environmental variables

# Step 1: Prepare session and load data
## Step 1a: Install necessary packages
```{r, message=FALSE, warning=FALSE}
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("here")
```

## Step 1b: Load necessary packages
```{r}
library(ggstatsplot)
library(tidyverse)
library(here)
```

## Step 1c: Load processed datasets
```{r}
# Load EEA final dataset (created in script_eea.Rmd)
# This should contain the summarized EEA data with environmental variables
if(exists("df_EEA_final")) {
  df_eea_0_final <- df_EEA_final
  print("EEA final dataset loaded from environment")
} else {
  # Alternative: Load from saved file if available
  tryCatch({
    df_eea_0_final <- read.csv(here("data", "eea", "df_EEA_final.csv"))
    print("EEA final dataset loaded from file")
  }, error = function(e) {
    stop("EEA final dataset not found. Please run script_eea.Rmd first.")
  })
}

# Load other required datasets
# Community alpha diversity (from script_community.Rmd)
if(exists("df_alpha_sum")) {
  df_alpha_0_summary <- df_alpha_sum
  print("Alpha diversity dataset loaded from environment")
} else {
  tryCatch({
    df_alpha_0_summary <- read.csv(here("data", "rna", "df_alpha_summary.csv"))
    print("Alpha diversity dataset loaded from file")
  }, error = function(e) {
    warning("Alpha diversity dataset not found. Some correlations may be missing.")
    df_alpha_0_summary <- NULL
  })
}

# qPCR data (from script_qpcr_2023.Rmd)
if(exists("df_qpcr_sum")) {
  df_qpcr_0_summary <- df_qpcr_sum
  print("qPCR dataset loaded from environment")
} else {
  tryCatch({
    df_qpcr_0_summary <- read.csv(here("data", "qpcr", "df_qpcr_summary.csv"))
    print("qPCR dataset loaded from file")
  }, error = function(e) {
    warning("qPCR dataset not found. Some correlations may be missing.")
    df_qpcr_0_summary <- NULL
  })
}

# Warming data (from script_warming_data_2022.Rmd)
if(exists("df_warming_all_2022_monthly")) {
  df_warming_0_monthly <- df_warming_all_2022_monthly
  print("Warming dataset loaded from environment")
} else {
  tryCatch({
    df_warming_0_monthly <- read.csv(here("scripts", "df_warming_all_2022_monthly.csv"))
    print("Warming dataset loaded from file")
  }, error = function(e) {
    warning("Warming dataset not found. Some correlations may be missing.")
    df_warming_0_monthly <- NULL
  })
}
```

# Step 2: Prepare correlation datasets
## Step 2a: Create comprehensive summary dataset
```{r}
# Start with EEA final data
df_corr_1_base <- df_eea_0_final %>%
  mutate(plotid = as.character(Plot))

# Add alpha diversity if available
if(!is.null(df_alpha_0_summary)) {
  df_alpha_0_summary <- df_alpha_0_summary %>% 
    mutate(plotid = as.character(plotid))
  
  df_corr_1_base <- df_corr_1_base %>%
    left_join(df_alpha_0_summary, by = c("plotid", "Layer"))
}

# Add qPCR data if available
if(!is.null(df_qpcr_0_summary)) {
  df_qpcr_0_summary <- df_qpcr_0_summary %>% 
    mutate(plotid = as.character(plotid))
  
  df_corr_1_base <- df_corr_1_base %>%
    left_join(df_qpcr_0_summary, by = "plotid")
}

# Add warming data if available
if(!is.null(df_warming_0_monthly)) {
  df_warming_0_monthly <- df_warming_0_monthly %>% 
    mutate(plotid = as.character(plotid))
  
  df_corr_1_base <- df_corr_1_base %>%
    left_join(df_warming_0_monthly, by = "plotid")
}

print("Base correlation dataset created")
print(paste("Dimensions:", nrow(df_corr_1_base), "rows x", ncol(df_corr_1_base), "columns"))
```

## Step 2b: Select and rename variables for correlation analysis
```{r}
# Select key variables and rename for better visualization
df_corr_2_selected <- df_corr_1_base %>%
  select(
    Layer,
    "Carbon acquisition" = Activity_C,
    "Nitrogen acquisition" = Activity_N,
    "Microbial abundance" = Abundance,
    "Alpha diversity" = Alpha_diversity,
    "Soil temperature" = pinTemp_mean,
    "Marsh surface elevation" = Elevation_mean,
    "Reduction index" = ri
  ) %>%
  # Remove rows with all NA values for numeric variables
  filter(!if_all(c("Carbon acquisition":"Reduction index"), is.na))

print("Variables selected for correlation analysis:")
print(colnames(df_corr_2_selected))
print(paste("Final dataset dimensions:", nrow(df_corr_2_selected), "rows x", ncol(df_corr_2_selected), "columns"))
```

# Step 3: Generate correlation matrices
## Step 3a: Overall correlation matrix (all layers combined)
```{r}
# Remove Layer column for overall analysis
df_corr_overall <- df_corr_2_selected %>%
  select(-Layer)

# Generate overall correlation matrix
plot_corr_overall <- ggstatsplot::ggcorrmat(
  data = df_corr_overall,
  matrix.type = "lower",
  type = "parametric", # Use parametric for Pearson correlation
  colors = c("darkred", "white", "steelblue"),
  title = "Overall Correlation Matrix - All Variables",
  subtitle = "Pearson correlation coefficients with significance levels"
)

print("Overall correlation matrix generated")
plot_corr_overall
```

## Step 3b: Layer-specific correlation matrices
```{r}
# Generate grouped correlation matrix by layer
plot_corr_by_layer <- ggstatsplot::grouped_ggcorrmat(
  data = df_corr_2_selected,
  grouping.var = Layer,
  matrix.type = "lower",
  type = "parametric", # Use parametric for Pearson correlation
  colors = c("darkred", "white", "steelblue"),
  title.prefix = "Correlation Matrix",
  subtitle.prefix = "Pearson correlations"
)

print("Layer-specific correlation matrices generated")
plot_corr_by_layer
```

## Step 3c: Zone-specific correlation matrices (if zone data available)
```{r}
# Check if Zone information is available
if("Zone" %in% colnames(df_corr_1_base)) {
  df_corr_by_zone <- df_corr_1_base %>%
    select(
      Zone,
      "Carbon acquisition" = Activity_C,
      "Nitrogen acquisition" = Activity_N,
      "Microbial abundance" = Abundance,
      "Alpha diversity" = Alpha_diversity,
      "Soil temperature" = pinTemp_mean,
      "Marsh surface elevation" = Elevation_mean,
      "Reduction index" = ri
    ) %>%
    filter(!if_all(c("Carbon acquisition":"Reduction index"), is.na))
  
  plot_corr_by_zone <- ggstatsplot::grouped_ggcorrmat(
    data = df_corr_by_zone,
    grouping.var = Zone,
    matrix.type = "lower",
    type = "parametric",
    colors = c("darkred", "white", "steelblue"),
    title.prefix = "Correlation Matrix",
    subtitle.prefix = "Pearson correlations"
  )
  
  print("Zone-specific correlation matrices generated")
  plot_corr_by_zone
} else {
  print("Zone information not available - skipping zone-specific correlations")
}
```

## Step 3d: Treatment-specific correlation matrices (if treatment data available)
```{r}
# Check if Treatment information is available
if("Treatment" %in% colnames(df_corr_1_base)) {
  df_corr_by_treatment <- df_corr_1_base %>%
    select(
      Treatment,
      "Carbon acquisition" = Activity_C,
      "Nitrogen acquisition" = Activity_N,
      "Microbial abundance" = Abundance,
      "Alpha diversity" = Alpha_diversity,
      "Soil temperature" = pinTemp_mean,
      "Marsh surface elevation" = Elevation_mean,
      "Reduction index" = ri
    ) %>%
    filter(!if_all(c("Carbon acquisition":"Reduction index"), is.na))
  
  plot_corr_by_treatment <- ggstatsplot::grouped_ggcorrmat(
    data = df_corr_by_treatment,
    grouping.var = Treatment,
    matrix.type = "lower",
    type = "parametric",
    colors = c("darkred", "white", "steelblue"),
    title.prefix = "Correlation Matrix",
    subtitle.prefix = "Pearson correlations"
  )
  
  print("Treatment-specific correlation matrices generated")
  plot_corr_by_treatment
} else {
  print("Treatment information not available - skipping treatment-specific correlations")
}
```

# Step 4: Export correlation results
## Step 4a: Calculate correlation coefficients and p-values
```{r}
# Function to extract correlation statistics
extract_correlation_stats <- function(data, group_var = NULL) {
  if(!is.null(group_var)) {
    # Grouped correlations
    data %>%
      group_by(!!sym(group_var)) %>%
      summarise(
        cors = list(cor(select(., where(is.numeric)), use = "complete.obs")),
        .groups = "drop"
      )
  } else {
    # Overall correlation
    numeric_data <- data %>% select(where(is.numeric))
    cor_matrix <- cor(numeric_data, use = "complete.obs")
    
    # Extract upper triangle
    cor_matrix[lower.tri(cor_matrix)] <- NA
    
    # Convert to long format
    cor_long <- cor_matrix %>%
      as.data.frame() %>%
      rownames_to_column("Variable1") %>%
      pivot_longer(-Variable1, names_to = "Variable2", values_to = "Correlation") %>%
      filter(!is.na(Correlation), Variable1 != Variable2)
    
    return(cor_long)
  }
}

# Extract overall correlations
correlations_overall <- extract_correlation_stats(df_corr_overall)

# Export correlation table
write.csv(correlations_overall, here("tables", "correlation_matrix_overall.csv"), row.names = FALSE)

print("Correlation statistics exported")
print("Top correlations (absolute value):")
print(correlations_overall %>% 
  arrange(desc(abs(Correlation))) %>% 
  head(10))
```

# Step 5: Statistical summary
```{r}
# Summary of correlation analysis
print("=== CORRELATION ANALYSIS SUMMARY ===")
print(paste("Total variables included:", ncol(df_corr_overall)))
print(paste("Total observations:", nrow(df_corr_2_selected)))

# Summary by layer if available
if("Layer" %in% colnames(df_corr_2_selected)) {
  layer_summary <- df_corr_2_selected %>%
    group_by(Layer) %>%
    summarise(
      n_obs = n(),
      n_complete = sum(complete.cases(select(., where(is.numeric)))),
      .groups = "drop"
    )
  
  print("=== OBSERVATIONS BY LAYER ===")
  print(layer_summary)
}

# Identify strongest correlations
strong_correlations <- correlations_overall %>%
  filter(abs(Correlation) > 0.5) %>%
  arrange(desc(abs(Correlation)))

print("=== STRONG CORRELATIONS (|r| > 0.5) ===")
print(strong_correlations)
```

# References
```{r}
# ggstatsplot: Patil, I. (2021). Visualizations with statistical details: The 'ggstatsplot' approach. Journal of Open Source Software, 6(61), 3167, doi:10.21105/joss.03167
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
```
