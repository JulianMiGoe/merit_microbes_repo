---
title: "IRIS Analysis - Reduction Index Measurements"
author: "Julian Mittmann-Goetsch"
date: "2025-01-31"
output: html_document
---

## Version 2.1: Updated version log format - 17.07.2025 | JM
## Version 2.0: Unified script structure, English comments, hierarchical naming - 08.07.2025 | JM
## Version 1.1: Streamlined script - 02.06.2025 | JM
## Version 1.0: Basic outline of the script - 27.02.2025 | JM

# Step 1: Prepare session and load data
## Step 1a: Load necessary packages
```{r}
library(dplyr)
library(emmeans)
library(ggplot2)
library(ggpubr)
library(here)
library(lme4)
library(performance)
library(tidyverse)
```

## Step 1b: Define plot theme
```{r}
# Global theme for all plots in this analysis
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1c: Load IRIS data
```{r}
# Load raw IRIS data from 2023 campaigns (same months as microbial sampling in 2022)
df_iris_0_raw <- read.delim(here("data", "iris", "df_iris_2023.txt"), dec = ".", sep = "\t")
```
# Step 2: Data preprocessing
## Step 2a: Process and reorder factors
```{r}
# Apply hierarchical naming and factor reordering
df_iris_1_processed <- df_iris_0_raw %>%
  mutate(
    Treatment = factor(Treatment, levels = c("ambient", "+1.5°C", "+3.0°C")),
    Zone = dplyr::recode(Zone,
      "PZ" = "Pioneer zone", "LM" = "Low marsh", "HM" = "High marsh"
    ),
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    Layer = case_when(
      Depth %in% c("0-10 cm", "10-20 cm", "20-30 cm") ~ "Topsoil (0-30 cm)",
      Depth %in% c("40-50 cm", "50-60 cm", "60-70 cm", "70-80 cm") ~ "Subsoil (40-80 cm)",
      TRUE ~ NA_character_
    ),
    Layer = factor(Layer, levels = c("Topsoil (0-30 cm)", "Subsoil (40-80 cm)"))
  )
```

# Step 3: Visualization
## Step 3a: Create reduction index barplot
```{r}
# Generate barplot showing reduction index by zone, treatment, and layer
plot_iris_bar_2_final <- df_iris_1_processed %>%
  filter(!is.na(Layer)) %>%
  ggplot(aes(x = Zone, y = ri, group = Treatment, fill = Treatment)) +
  stat_summary(fun = mean, geom = "bar",
               position = position_dodge(width = 1), show.legend = TRUE) +
  stat_summary(geom = "errorbar", width = 0.5, size = 1, color = "black", 
               position = position_dodge(width = 1)) +
  scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), 
                   name = "Warming treatment:") +
  scale_y_continuous(limits = c(0, 1), expand = c(0,0)) +
  labs(color = NULL, y = "Reduction index", x = "Zone") +
  theme_JM +
  facet_wrap(~ Layer, ncol = 1) +
  theme(legend.position = "top") 

plot_iris_bar_2_final
```

# Step 4: Statistical analysis
## Step 4a: Linear mixed-effects model analysis
```{r}
# Fit linear mixed-effects model with plot-subplot as random effect
stat_model_iris_1_main <- lmer(ri ~ Treatment * Zone * Layer + (1|ID_plot_subplot), 
                              data = df_iris_1_processed)

# Model diagnostics
check_model(stat_model_iris_1_main)

# ANOVA results
stat_anova_iris_1_main <- anova(stat_model_iris_1_main)

# Pairwise comparisons using emmeans
stat_iris_zone_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Zone)
stat_iris_zone_pairs_1_main <- pairs(stat_iris_zone_emm_1_main)

stat_iris_treatment_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Treatment)
stat_iris_treatment_pairs_1_main <- pairs(stat_iris_treatment_emm_1_main)

stat_iris_layer_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Layer)
stat_iris_layer_pairs_1_main <- pairs(stat_iris_layer_emm_1_main)

# Interaction comparisons
stat_iris_zone_treatment_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Zone | Treatment)
stat_iris_zone_treatment_pairs_1_main <- pairs(stat_iris_zone_treatment_emm_1_main)

stat_iris_zone_layer_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Zone | Layer)
stat_iris_zone_layer_pairs_1_main <- pairs(stat_iris_zone_layer_emm_1_main)

stat_iris_treatment_layer_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Treatment | Layer)
stat_iris_treatment_layer_pairs_1_main <- pairs(stat_iris_treatment_layer_emm_1_main)

stat_iris_treatment_layer_zone_emm_1_main <- emmeans(stat_model_iris_1_main, ~ Treatment | Layer | Zone)
stat_iris_treatment_layer_zone_pairs_1_main <- pairs(stat_iris_treatment_layer_zone_emm_1_main)
```

# Step 5: Data summary for further calculations
## Step 5a: Create summarized dataset for integration with other analyses
```{r}
# Create plot-level summary data with consistent layer naming for integration
df_iris_summarized_2_final <- df_iris_1_processed %>%
  mutate(Layer = recode_factor(Layer, 
                              "Subsoil (40-80 cm)" = "Subsoil\n(40-100 cm)",
                              "Topsoil (0-30 cm)" = "Topsoil\n(0-30 cm)")) %>%
  filter(!is.na(Layer)) %>%
  group_by(plotid, Layer) %>%
  summarise(ri = mean(ri, na.rm = TRUE), .groups = "drop") %>%
  mutate(Plot = as.character(plotid))
```

# Export summarized IRIS data for correlation matrix integration
```{r}
# Exportiere df_iris_summarized_2_final als df_iris_summary.csv für die Korrelationsmatrix.
write.csv(df_iris_summarized_2_final, here("data", "iris", "df_iris_summary.csv"), row.names = FALSE)
```

# Summary: Data overview
## Summary of all main dataframes
```{r}
# Raw data summary
cat("Raw IRIS data summary:\n")
summary(df_iris_0_raw)

# Processed data summary
cat("\nProcessed IRIS data summary:\n")
summary(df_iris_1_processed)

# Reduction index summary by factors
cat("\nReduction index summary by treatment:\n")
df_iris_1_processed %>%
  group_by(Treatment) %>%
  summarise(
    mean_ri = mean(ri, na.rm = TRUE),
    sd_ri = sd(ri, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) %>%
  print()

cat("\nReduction index summary by zone:\n")
df_iris_1_processed %>%
  group_by(Zone) %>%
  summarise(
    mean_ri = mean(ri, na.rm = TRUE),
    sd_ri = sd(ri, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) %>%
  print()

cat("\nReduction index summary by layer:\n")
df_iris_1_processed %>%
  group_by(Layer) %>%
  summarise(
    mean_ri = mean(ri, na.rm = TRUE),
    sd_ri = sd(ri, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) %>%
  print()

# Statistical results summary
cat("\nKey statistical results:\n")
cat("ANOVA main results:\n")
print(stat_anova_iris_1_main)

# Summarized data for integration
cat("\nSummarized data for integration:\n")
summary(df_iris_summarized_2_final)
```

# References
```{r}
# dplyr: Wickham, H., François, R., Henry, L., Müller, K., Vaughan, D., & PBC, P. S. (2024). dplyr: A Grammar of Data Manipulation. R package version 1.1.4. https://CRAN.R-project.org/package=dplyr
# emmeans: Lenth, R. V. (2024). emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version 1.10.2. https://CRAN.R-project.org/package=emmeans
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggpubr: Kassambara, A. (2024). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0. https://CRAN.R-project.org/package=ggpubr
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
# lme4: Bates, D., Mächler, M., Bolker, B., & Walker, S. (2024). lme4: Linear Mixed-Effects Models using 'Eigen' and S4. R package version 1.1-35. https://CRAN.R-project.org/package=lme4
# performance: Lüdecke, D., Ben-Shachar, M. S., Patil, I., Waggoner, P., & Makowski, D. (2024). performance: Assessment of Regression Models Performance. R package version 0.10.8. https://CRAN.R-project.org/package=performance
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
```
