---
title: "Functional Analysis using FAPROTAX Database"
author: "Julian Mittmann-Goetsch"
date: "2025-01-31"
output: html_document
---

## Version 2.2: Added deviation analysis from ambient baseline - 12.09.2025 | JM
## Version 2.1: Updated version log format - 17.07.2025 | JM
## Version 2.0: Unified script structure, English comments, hierarchical naming - 31.01.2025 | JM
## Version 1.0: Basic script using FAPROTAX output table - 31.01.2025 | JM

# Step 1: Prepare session and load data
## Step 1a: Install necessary packages
```{r, message=FALSE, warning=FALSE}
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("ggh4x")
#install.packages("here")
#install.packages("tidyverse")
```

## Step 1b: Load necessary packages
```{r}
library(dplyr)
library(ggplot2)
library(ggh4x)
library(here)
library(tidyverse)
library(ggpubr)
library(emmeans)
library(multcomp)
```

## Step 1c: Custom theme
```{r}
# Custom theme for consistent plot styling
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1d: Load functional and metadata data
```{r}
# Load functional database from FAPROTAX
df_functional_0_raw <- read.delim(here::here("data", "faprotax", "df_functional_database.tsv"), 
                                 dec = ".", sep = "\t")

# Load metadata
df_metadata_0_raw <- read.delim(here::here("data", "metadata.txt"), dec = ".", sep= "\t")
```

# Step 2: Data preprocessing
## Step 2a: Process metadata and functional data
```{r}
# Process metadata with hierarchical naming
df_metadata_1_processed <- df_metadata_0_raw %>%
  mutate(Sample_ID = as.factor(sample_name)) %>%
  mutate(Layer = case_when(
    Depth %in% c("0-5 cm", "5-10 cm", "20-30 cm") ~ "Topsoil (0-30 cm)",
    Depth %in% c("40-50 cm", "80-100 cm") ~ "Subsoil (40-100 cm)",
    TRUE ~ NA_character_
  )) %>%
  mutate_at(c(5:9), as.factor)

# Recode zone names for consistency
df_metadata_1_processed$Zone <- dplyr::recode(df_metadata_1_processed$Zone,
  "PZ" = "Pioneer zone", "LM" = "Low marsh", "HM" = "High marsh"
)
df_metadata_1_processed$Zone <- factor(df_metadata_1_processed$Zone, 
                                      levels = c("Pioneer zone", "Low marsh", "High marsh"))

# Transform functional data to long format
df_functional_1_long <- df_functional_0_raw %>%
  pivot_longer(cols = -X.group, names_to = "Sample_ID", values_to = "abundance") %>%
  rename(Functional = X.group)

# Merge functional data with metadata
df_merged_1_processed <- df_functional_1_long %>%
  inner_join(df_metadata_1_processed, by = "Sample_ID")

# Reorder treatment factors
df_merged_2_final <- df_merged_1_processed %>%
  mutate(Treatment = case_when(
    Treatment == "ambient" ~ "Ambient",
    Treatment == "1.5" ~ "+1.5°C",
    Treatment == "3" ~ "+3.0°C",
    TRUE ~ Treatment
  )) %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "+1.5°C", "+3.0°C"))) %>%
  mutate(Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")))
```


# Step 3: Functional analysis and visualization
## Step 3a: Create heatmaps for functional groups
```{r}
# Filter out functional groups containing "human"
df_merged_filtered_1_processed <- df_merged_2_final %>%
  filter(!str_detect(Functional, regex("human", ignore_case = TRUE)))

# Define functional groups for degradation processes
functional_groups_degradation <- c(
  "cellulolysis", "chitinolysis", "ligninolysis", "hydrocarbon_degradation",
  "fermentation", "aliphatic_non_methane_hydrocarbon_degradation",
  "aromatic_hydrocarbon_degradation", "aromatic_compound_degradation"
)

# Define broader functional groups
functional_groups_all <- c(
  "aerobic_chemoheterotrophy", "photoautotrophy", "nitrite_respiration",
  "nitrate_reduction", "aerobic_nitrite_oxidation", "hydrocarbon_degradation",
  "fermentation", "sulfate_respiration", "xylanolysis", "chitinolysis",
  "cellulolysis", "methanotrophy", "aerobic_ammonia_oxidation",
  "anoxygenic_photoautotrophy", "nitrate_denitrification", "dark_hydrogen_oxidation",
  "urelolysis", "dark_sulfite_oxidation", "dark_sulfur_oxidation",
  "dark_oxidation_of_sulfur_compounds", "dark_sulfide_oxidation",
  "animal_parasites_or_symbionts", "nitrate_respiration", "methanol_oxidation",
  "methylotrophy", "methanogenesis", "methanogenesis_by_CO2_reduction_with_H2",
  "methanogenesis_by_reduction_of_methyl_compounds_with_H2",
  "hydrogenotrophic_methanogenesis", "dark_iron_oxidation", "iron_respiration"
)

# Filter data for degradation processes
df_filtered_degradation_1_processed <- df_merged_filtered_1_processed %>%
  filter(Functional %in% functional_groups_degradation)

# Filter data for all functional groups
df_filtered_all_1_processed <- df_merged_filtered_1_processed %>%
  filter(Functional %in% functional_groups_all)

# Calculate mean abundance for degradation heatmap
df_heatmap_degradation_1_processed <- df_filtered_degradation_1_processed %>%
  group_by(Functional, Zone, Treatment) %>%
  summarise(mean_abundance = mean(abundance, na.rm = TRUE), .groups = "drop")

# Calculate mean abundance with layer separation
df_heatmap_degradation_layer_1_processed <- df_filtered_degradation_1_processed %>%
  filter(!Functional %in% c("aliphatic_non_methane_hydrocarbon_degradation")) %>%
  group_by(Functional, Zone, Treatment, Layer) %>%
  summarise(mean_abundance = mean(abundance, na.rm = TRUE), .groups = "drop")

# Calculate mean abundance for all functional groups
df_heatmap_all_1_processed <- df_filtered_all_1_processed %>%
  group_by(Functional, Zone, Treatment) %>%
  summarise(mean_abundance = mean(abundance, na.rm = TRUE), .groups = "drop")

# Define color palettes
custom_palette_1 <- c("#d0d1e6", "#a6bddb", "#023858")
custom_palette_2 <- c("#e0ecf4", "#8c96c6", "#810f7c")

# Create degradation heatmap
plot_heatmap_degradation_2_final <- ggplot(df_heatmap_degradation_1_processed, 
                                          aes(x = Treatment, y = Functional, fill = mean_abundance)) +
  geom_tile() +
  facet_grid(. ~ Zone, scales = "free_x", space = "free_x") +
  scale_fill_gradientn(
    name = "Mean Abundance",
    colors = custom_palette_1,
    values = scales::rescale(c(min(df_heatmap_degradation_1_processed$mean_abundance),
                               median(df_heatmap_degradation_1_processed$mean_abundance),
                               max(df_heatmap_degradation_1_processed$mean_abundance))),
    breaks = pretty(df_heatmap_degradation_1_processed$mean_abundance, n = 5),
    guide = guide_colorbar(barwidth = 12, barheight = 1.2, title.position = "top", title.hjust = 0.5)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10),
    strip.background = element_rect(fill = "lightgrey"),
    strip.text = element_text(face = "bold"),
    legend.position = "bottom",
    panel.spacing = unit(0.1, "lines"),
    axis.title.y = element_text(margin = margin(r = 10))
  ) +
  labs(x = "Treatment", y = "Functional Group") +
  scale_y_discrete(labels = function(x) stringr::str_to_sentence(gsub("_", " ", x)))

# Create degradation heatmap with layers
plot_heatmap_degradation_layer_2_final <- ggplot(df_heatmap_degradation_layer_1_processed, 
                                                 aes(x = Treatment, y = Functional, fill = mean_abundance)) +
  geom_tile() +
  facet_grid(fct_rev(Layer) ~ Zone, scales = "free_x", space = "free_x") +
  scale_fill_gradientn(
    name = "Mean Abundance",
    colors = custom_palette_1,
    values = scales::rescale(c(min(df_heatmap_degradation_1_processed$mean_abundance),
                               median(df_heatmap_degradation_1_processed$mean_abundance),
                               max(df_heatmap_degradation_1_processed$mean_abundance))),
    breaks = pretty(df_heatmap_degradation_1_processed$mean_abundance, n = 3),
    guide = guide_colorbar(
      barwidth = 12, 
      barheight = 1.2, 
      title.position = "top", 
      title.hjust = 0.5,
      label.theme = element_text(size = 8, angle = 0),
      title.theme = element_text(size = 10)
    )
  ) +
  theme_bw() +
  theme_JM +
  theme(
    legend.position = "bottom"
  ) +
  labs(x = "Treatment", y = "Functional Group") +
  scale_y_discrete(labels = function(x) stringr::str_to_sentence(gsub("_", " ", x)))

# Create heatmap for all functional groups
plot_heatmap_all_2_final <- ggplot(df_heatmap_all_1_processed, 
                                  aes(x = Treatment, y = Functional, fill = mean_abundance)) +
  geom_tile() +
  facet_grid(. ~ Zone, scales = "free_x", space = "free_x") +
  scale_fill_gradientn(
    name = "Mean Abundance",
    colors = custom_palette_1,
    values = scales::rescale(c(min(df_heatmap_all_1_processed$mean_abundance),
                               median(df_heatmap_all_1_processed$mean_abundance),
                               max(df_heatmap_all_1_processed$mean_abundance))),
    breaks = pretty(df_heatmap_all_1_processed$mean_abundance, n = 5),
    guide = guide_colorbar(barwidth = 12, barheight = 1.2, title.position = "top", title.hjust = 0.5)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10),
    strip.background = element_rect(fill = "lightgrey"),
    strip.text = element_text(face = "bold"),
    panel.spacing = unit(0.1, "lines"),
    axis.title.y = element_text(margin = margin(r = 10))
  ) +
  labs(x = "Treatment", y = "Functional Group") +
  scale_y_discrete(labels = function(x) stringr::str_to_sentence(gsub("_", " ", x)))

# Display plots
plot_heatmap_degradation_2_final
plot_heatmap_all_2_final
plot_heatmap_degradation_layer_2_final


# Create output directory if it doesn't exist
if (!dir.exists(here("output"))) {
  dir.create(here("output"), recursive = TRUE)
}

# Export high-resolution TIFF file for publication
tiff(here("output", "plot_heatmap_all_2_final.tiff"), 
     width = 12, height = 10, units = "in", res = 600, compression = "lzw")
print(plot_heatmap_all_2_final)
dev.off()

# Also save as EPS for vector graphics option
postscript(here("output", "plot_heatmap_all_2_final.eps"), 
           width = 12, height = 10, horizontal = FALSE)
print(plot_heatmap_all_2_final)
dev.off()
```



---

## REVISION DOCUMENTATION - September 2025

### New Analysis: Pathway Deviation Analysis
1. **Deviation Calculation for Filtered Degradation Pathways**
   - Calculated percent deviations from ambient baseline for +1.5°C and +3.0°C treatments
   - Focus on 5 filtered degradation pathways after excluding pathways with too many zero values
   - Excluded pathways: aromatic hydrocarbon degradation, aliphatic non-methane hydrocarbon degradation, ligninolysis
   - Deviations calculated separately for each Zone × Layer combination

2. **Visualization Framework:**
   - Horizontal bar plot layout with pathways on Y-axis and treatments as bars
   - Horizontal dashed line at 0% representing ambient baseline
   - Error bars showing standard errors of percent change
   - Consistent color scheme: #FDAE61 (+1.5°C), #D73027 (+3.0°C)
   - No plot titles or headers for clean presentation

3. **Statistical Approach:**
   - Plot-level means calculated first, then deviations from zone/layer-specific ambient means
   - Standard errors calculated from plot-level deviations for robust error estimation
   - Lowercase "ambient" used in treatment factor levels

## Step 5: Pathway Deviation Analysis
### Step 5a: Basic pathway abundance histograms
```{r}
# Define all degradation pathways for initial exploration
all_degradation_pathways <- c(
  "cellulolysis", "chitinolysis", "ligninolysis", "hydrocarbon_degradation",
  "fermentation", "aliphatic_non_methane_hydrocarbon_degradation",
  "aromatic_hydrocarbon_degradation", "aromatic_compound_degradation"
)

# Create histograms to assess data distribution
plot_faprotax_histograms <- df_merged_2_final %>%
  filter(Functional %in% all_degradation_pathways) %>%
  mutate(Pathway_clean = stringr::str_to_sentence(gsub("_", " ", Functional))) %>%
  ggplot(aes(x = abundance)) +
  geom_histogram(bins = 20, fill = "steelblue", alpha = 0.7, color = "white") +
  facet_wrap(~ Pathway_clean, scales = "free", ncol = 2) +
  theme_JM +
  labs(x = "Abundance", y = "Count")

print("=== PATHWAY ABUNDANCE HISTOGRAMS ===")
plot_faprotax_histograms
```

### Step 5b: Pathway filtering and final dataset
```{r}
# Exclude pathways with too many zero values based on histograms
# Excluded: aromatic_hydrocarbon_degradation, aliphatic_non_methane_hydrocarbon_degradation, ligninolysis
final_pathways <- c(
  "cellulolysis", 
  "chitinolysis", 
  "hydrocarbon_degradation",
  "fermentation", 
  "aromatic_compound_degradation"
)

print("=== PATHWAY FILTERING ===")
print("Excluded pathways due to too many zero values:")
print("- Aromatic hydrocarbon degradation")
print("- Aliphatic non-methane hydrocarbon degradation") 
print("- Ligninolysis")
print("Remaining pathways:")
print(final_pathways)
```

### Step 5c: Calculate pathway means and deviations
```{r}
# Calculate plot-level means for filtered pathways
df_plot_means <- df_merged_2_final %>%
  filter(Functional %in% final_pathways) %>%
  group_by(Zone, Layer, Treatment, Plot, Functional) %>%
  summarise(abundance_plot_mean = mean(abundance, na.rm = TRUE), .groups = "drop")

# Calculate ambient baselines
df_baselines <- df_plot_means %>%
  filter(Treatment == "Ambient") %>%
  group_by(Zone, Layer, Functional) %>%
  summarise(ambient_mean = mean(abundance_plot_mean, na.rm = TRUE), .groups = "drop")

# Identify valid combinations (no missing baselines and not zero baselines)
valid_combinations <- df_baselines %>%
  filter(!is.na(ambient_mean), ambient_mean > 0) %>%
  dplyr::select(Zone, Layer, Functional)

print("=== VALID COMBINATIONS (NO NAs, NON-ZERO BASELINES) ===")
print(paste("Number of valid Zone/Layer/Functional combinations:", nrow(valid_combinations)))
print(valid_combinations)

# Filter analysis to only valid combinations
df_plot_means_filtered <- df_plot_means %>%
  inner_join(valid_combinations, by = c("Zone", "Layer", "Functional"))

df_baselines_filtered <- df_baselines %>%
  inner_join(valid_combinations, by = c("Zone", "Layer", "Functional"))

# Calculate deviations for warming treatments (only valid combinations)
df_deviations <- df_plot_means_filtered %>%
  filter(Treatment != "Ambient") %>%
  left_join(df_baselines_filtered, by = c("Zone", "Layer", "Functional")) %>%
  mutate(
    # Absolute deviation (like EEA plots)
    absolute_change = abundance_plot_mean - ambient_mean,
    # Percentage deviation
    percent_change = ((abundance_plot_mean - ambient_mean) / ambient_mean) * 100
  )

# Summary statistics for both absolute and percentage deviations
df_deviation_summary <- df_deviations %>%
  group_by(Zone, Layer, Treatment, Functional) %>%
  summarise(
    # Absolute change statistics
    absolute_change_mean = mean(absolute_change, na.rm = TRUE),
    absolute_change_se = sd(absolute_change, na.rm = TRUE) / sqrt(n()),
    # Percentage change statistics
    percent_change_mean = mean(percent_change, na.rm = TRUE),
    percent_change_se = sd(percent_change, na.rm = TRUE) / sqrt(n()),
    n_plots = n(),
    .groups = "drop"
  ) %>%
  mutate(Pathway_clean = stringr::str_to_sentence(gsub("_", " ", Functional)))

print("=== DEVIATION CALCULATIONS COMPLETE ===")
print(paste("Number of deviation summary records:", nrow(df_deviation_summary)))
print("All records have valid baselines (no NAs or zeros)")
```

### Step 5d: Absolute numbers table for all pathways
```{r}
# Create comprehensive table with absolute pathway means (only valid combinations)
df_pathway_means_table <- df_merged_2_final %>%
  filter(Functional %in% final_pathways) %>%
  # Only include valid combinations
  inner_join(valid_combinations, by = c("Zone", "Layer", "Functional")) %>%
  group_by(Zone, Treatment, Layer, Functional) %>%
  summarise(
    mean_abundance = mean(abundance, na.rm = TRUE),
    se_abundance = sd(abundance, na.rm = TRUE) / sqrt(n()),
    n_samples = n(),
    .groups = "drop"
  ) %>%
  mutate(
    Pathway = stringr::str_to_sentence(gsub("_", " ", Functional)),
    mean_se = paste0(round(mean_abundance, 4), " ± ", round(se_abundance, 4))
  ) %>%
  dplyr::select(Zone, Treatment, Layer, Pathway, mean_abundance, se_abundance, mean_se, n_samples) %>%
  arrange(Zone, Layer, Treatment, Pathway)

print("=== ABSOLUTE PATHWAY MEANS TABLE (VALID COMBINATIONS ONLY) ===")
print(df_pathway_means_table)

# Export table for easy viewing
write.csv(df_pathway_means_table, "pathway_means_absolute_numbers_valid.csv", row.names = FALSE)
print("Table exported as 'pathway_means_absolute_numbers_valid.csv'")
```

### Step 5e: Deviation plots (percentage and absolute)
```{r}
# Create percentage deviation plot (like before)
treatment_colors <- c("+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027")

plot_pathway_deviations_percent <- df_deviation_summary %>%
  ggplot(aes(x = percent_change_mean, y = Pathway_clean, fill = Treatment)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, alpha = 0.8) +
  geom_errorbar(aes(xmin = percent_change_mean - percent_change_se,
                    xmax = percent_change_mean + percent_change_se),
                position = position_dodge(width = 0.8), width = 0.3, size = 0.6) +
  facet_grid(Layer ~ Zone, scales = "free_y") +
  scale_fill_manual(values = treatment_colors, name = "Treatment") +
  scale_x_continuous(labels = function(x) paste0(x, "%")) +
  theme_JM +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    strip.text = element_text(size = 10, face = "bold"),
    legend.position = "bottom"
  ) +
  labs(x = "Change from Ambient (%)", y = "Degradation Pathway")

# Create focused percentage deviation plot with only 3 selected pathways
selected_pathways <- c("hydrocarbon_degradation", "aromatic_compound_degradation", "fermentation")

plot_pathway_deviations_percent_focused <- df_deviation_summary %>%
  filter(Functional %in% selected_pathways) %>%
  ggplot(aes(x = percent_change_mean, y = Pathway_clean, fill = Treatment)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, alpha = 0.8) +
  geom_errorbar(aes(xmin = percent_change_mean - percent_change_se,
                    xmax = percent_change_mean + percent_change_se),
                position = position_dodge(width = 0.8), width = 0.3, size = 0.6) +
  facet_grid(fct_rev(Layer) ~ Zone, scales = "free_y") +
  scale_fill_manual(values = treatment_colors, name = "Treatment") +
  scale_x_continuous(labels = function(x) paste0(x, "%")) +
  theme_bw() +
  theme_JM +
  theme(
    legend.position = "bottom"
  ) +
  labs(x = "Change from Ambient (%)", y = "Degradation Pathway")

# Create absolute deviation plot (like EEA plots)
plot_pathway_deviations_absolute <- df_deviation_summary %>%
  ggplot(aes(x = absolute_change_mean, y = Pathway_clean, fill = Treatment)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, alpha = 0.8) +
  geom_errorbar(aes(xmin = absolute_change_mean - absolute_change_se,
                    xmax = absolute_change_mean + absolute_change_se),
                position = position_dodge(width = 0.8), width = 0.3, size = 0.6) +
  facet_grid(Layer ~ Zone, scales = "free_y") +
  scale_fill_manual(values = treatment_colors, name = "Treatment") +
  theme_JM +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    strip.text = element_text(size = 10, face = "bold"),
    legend.position = "bottom"
  ) +
  labs(x = "Absolute Change from Ambient", y = "Degradation Pathway")

print("=== PERCENTAGE DEVIATION PLOT (ALL PATHWAYS) ===")
plot_pathway_deviations_percent

print("=== FOCUSED PERCENTAGE DEVIATION PLOT (3 SELECTED PATHWAYS) ===")
plot_pathway_deviations_percent_focused

print("=== ABSOLUTE DEVIATION PLOT (EEA-STYLE) ===")
plot_pathway_deviations_absolute

# Create combined plot with heatmap and focused deviation plot
print("=== COMBINED PLOT: HEATMAP AND FOCUSED DEVIATION ANALYSIS ===")
combined_plot_heatmap_deviation <- ggarrange(
  plot_heatmap_degradation_layer_2_final,
  plot_pathway_deviations_percent_focused,
  ncol = 1,
  nrow = 2,
  labels = c("A", "B"),
  heights = c(1, 1)
)

print(combined_plot_heatmap_deviation)

# Create output directory if it doesn't exist
if (!dir.exists(here("output"))) {
  dir.create(here("output"), recursive = TRUE)
}

# Export high-resolution TIFF file for publication
tiff(here("output", "combined_plot_heatmap_deviation.tiff"), 
     width = 12, height = 10, units = "in", res = 600, compression = "lzw")
print(combined_plot_heatmap_deviation)
dev.off()

# Also save as EPS for vector graphics option
postscript(here("output", "combined_plot_heatmap_deviation.eps"), 
           width = 12, height = 10, horizontal = FALSE)
print(combined_plot_heatmap_deviation)
dev.off()

cat("High-resolution figures saved:\n")
cat("- combined_plot_heatmap_deviation.tiff (600 DPI)\n")
cat("- combined_plot_heatmap_deviation.eps (vector)\n")
```

*Last modified: September 16, 2025 | JM*

# Summary: Data overview
## Summary of all main dataframes
```{r}
# Metadata summary
cat("Metadata summary:\n")
summary(df_metadata_1_processed)

# Functional data summary
cat("\nFunctional data summary:\n")
cat("Total functional groups:", length(unique(df_merged_2_final$Functional)), "\n")
cat("Total samples:", length(unique(df_merged_2_final$Sample_ID)), "\n")

# Functional groups summary
cat("\nFunctional abundance summary:\n")
summary(df_merged_2_final$abundance)

# Degradation processes summary
cat("\nDegradation processes summary:\n")
summary(df_heatmap_degradation_1_processed$mean_abundance)

# All functional groups summary
cat("\nAll functional groups summary:\n")
summary(df_heatmap_all_1_processed$mean_abundance)

# Deviation analysis summary
cat("\nDeviation analysis summary:\n")
cat("Key functional groups for deviation analysis:", length(key_functional_groups), "\n")
cat("Most variable processes (>0.02 absolute change):", length(df_faprotax_variable), "\n")
cat("Functional groups in degradation analysis:", length(functional_groups_degradation), "\n")

# Key functional groups
cat("\nKey degradation functional groups analyzed:\n")
print(functional_groups_degradation)

cat("\nKey functional groups for focused deviation analysis:\n")
print(key_functional_groups)

cat("\nTotal functional groups in comprehensive analysis:\n")
print(length(functional_groups_all))
```

# References
```{r}
# dplyr: Wickham, H., François, R., Henry, L., Müller, K., Vaughan, D., & PBC, P. S. (2024). dplyr: A Grammar of Data Manipulation. R package version 1.1.4. https://CRAN.R-project.org/package=dplyr
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggh4x: van den Brand, T. (2024). ggh4x: Hacks for 'ggplot2'. R package version 0.2.7. https://CRAN.R-project.org/package=ggh4x
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
```


