---
title: "script_qpcr_2023"
author: "Julian Mittmann-Goetsch"
date: "2025-01-27"
output: html_document
---

## Version 1.1: Streamlined script - 02.06.2025 | JM


# Step 1: Prepare R session
## Step 1a: Install necessary packages
```{r}
#install.packages("car")
#install.packages("emmeans")
#install.packages("ggplot2")
#install.packages("ggpubr")
#install.packages("here")
#install.packages("lme4")
#install.packages("tidyverse")
#install.packages("lmerTest")
```

## Step 1b: Load necessary packages
```{r}
library(car)
library(emmeans)
library(ggplot2)
library(ggpubr)
library(here)
library(lme4)
library(tidyverse)
library(lmerTest)
```

## Step 1c: Load sequencing data
```{r}
# Set working directory
setwd("./")
df_eub  <- read.delim(here("data", "qpcr", "df_copies_EUB.txt"), dec=".", sep="\t")
```

## Step 1d: Define plot theme
```{r message=FALSE, warning=FALSE}
# Creates a theme for all plots in this study 
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1e: Prepare dataframe
```{r}
# Correctly format all factors
df_eub$Depth <- recode_factor(df_eub$Depth, "0-10" = "0-10 cm", "20-30" = "20-30 cm")  
df_eub$Treatment <- as.factor(df_eub$Treatment)
df_eub$Zone <- as.factor(df_eub$Zone)
df_eub$Treatment <- recode_factor(df_eub$Treatment, "ambient" = "ambient", "1.5C" = "+1.5°C", "3.0C" = "+3.0°C")
df_eub$Zone <- dplyr::recode(df_eub$Zone,
  "PZ" = "Pioneer zone",
  "LM" = "Low marsh",
  "HM" = "High marsh"
)
df_eub$Zone <- factor(df_eub$Zone, levels = c("Pioneer zone", "Low marsh", "High marsh"),
                     labels = c("Pioneer zone", "Low marsh", "High marsh"))
```

# Step 2: Plots
## Step 2a: Barplot for EUB abundances
```{r}
plot_qpcr_bar_eub <- ggplot(df_eub, aes(x = Zone, y = log10_copies, fill = Treatment)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9), alpha = 0.9, width = 0.7) +
  stat_summary(fun.data = mean_se, geom = "errorbar", position = position_dodge(width = 0.9), width = 0.25, color = "black") +
  scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
  labs(fill = "Treatment", y = "log10 abundance 16S rRNA [copies/g OM]", x = "Zone") +
  theme_JM +
  ylim(9, 9.2)
```

# Step 3: Statistics
## Step 3a: ANOVA on EUB
```{r}
# Remove the root-barrier samples from the dataframe.
df_eub <- df_eub %>% 
  mutate(core_id = paste0(Plot, Subplot)) %>%
  filter(Subplot == "ctr")

stat_model_eub <- lmer(log10_copies ~ Treatment * Zone + (1|core_id), data = df_eub)
anova(stat_model_eub)
plot(stat_model_eub)
summary(stat_model_eub)

# Pairwise comparisons
stat_model_eub_emm <- emmeans(stat_model_eub , ~ Zone)
pairs(stat_model_eub_emm)

stat_res_eub <- Anova(stat_model_eub, type = 3)
stat_emm_eub <- emmeans(stat_model_eub, ~ Treatment | Zone)
stat_pairs_eub <- pairs(stat_emm_eub)

cat("\nANOVA EUB:\n")
print(stat_res_eub)
cat("\nPairwise Comparisons:\n")
print(stat_pairs_eub)
```

# Step 4: Summarise dataframe
```{r}
df_eub_summary <- df_eub %>%
  group_by(Zone, Treatment) %>%
  summarise(
    mean_abundance = mean(log10_copies, na.rm = TRUE),
    se_abundance = sd(log10_copies, na.rm = TRUE)/sqrt(n()),
    n = n(),
    .groups = "drop"
  )
df_eub_summary <- df_eub_summary %>%
  mutate(mean_se = paste0(round(mean_abundance, 2), " ± ", round(se_abundance, 2), " (n=", n, ")"))
print(df_eub_summary)

df_qpcr_sum  <- df_eub  %>%
  mutate(plotid = as.factor(Plot)) %>%
  group_by(plotid) %>%
  summarise("Abundance" = mean(log10_copies, na.rm=TRUE)) %>%
  ungroup()
print(df_qpcr_sum)
```

# References
```{r}
# car: Fox, J. & Weisberg, S. (2024). car: Companion to Applied Regression. R package version 3.1-2. https://CRAN.R-project.org/package=car
# emmeans: Lenth, R. V. (2024). emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version 1.10.2. https://CRAN.R-project.org/package=emmeans
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggpubr: Kassambara, A. (2024). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0. https://CRAN.R-project.org/package=ggpubr
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
# lme4: Bates, D., Mächler, M., Bolker, B., & Walker, S. (2024). lme4: Linear Mixed-Effects Models using 'Eigen' and S4. R package version 1.1-35. https://CRAN.R-project.org/package=lme4
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
```

