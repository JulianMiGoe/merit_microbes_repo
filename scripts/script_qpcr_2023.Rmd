---
title: "script_qpcr_2023"
author: "Julian Mittmann-Goetsch"
date: "2025-01-27"
output: html_document
---

# Versionlog
## Version 1.0: Implementing old scripts - 27.01.2025 | JM
## Version 1.1: Streamlined script - 02.06.2025 | JM


# Step 1: Prepare R session
## Step 1a: Install necessary packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("tidyverse")       # edit data frames (long format)
#install.packages("ggplot2")         # Plot data (NDMS,)
#install.packages("ggpubr")           # arranged plots
```

## Step 1b: Load necessary packages
```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(lme4)
library(car)
library(emmeans)
library(here)
```

## Step 1c: Load sequencing data
```{r}
# Set working directoy
setwd("./")

df_eub  <- read.delim(here("data", "qpcr", "df_copies_EUB.txt"), dec=".", sep="\t")
```

## Step 1d: Define plot theme
```{r message=FALSE, warning=FALSE}
# Creates a theme for all plots in this study 
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

## Step 1e: Prepare dataframe
```{r}
# Correctly format all factors
df_eub$Depth <- recode_factor(df_eub$Depth, "0-10" = "0-10 cm", "20-30" = "20-30 cm")  
df_eub$Treatment <- as.factor(df_eub$Treatment)
df_eub$Zone <- as.factor(df_eub$Zone)
df_eub$Treatment <- recode_factor(df_eub$Treatment, "ambient" = "ambient", "1.5C" = "+1.5°C", "3.0C" = "+3.0°C")
df_eub$Zone <- factor(df_eub$Zone, levels = c("PZ", "LM", "HM"))
```

# Step 2: Plots
## Step 2a: Barplot for EUB abundances
```{r}
ggplot(df_eub, aes(x = Zone, y = log10_copies, fill = Treatment)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.9), alpha = 0.9, width = 0.7) +
  stat_summary(fun.data = mean_se, geom = "errorbar", position = position_dodge(width = 0.9), width = 0.25, color = "black") +
  scale_fill_manual(values = c("ambient" = "#4575B4", "+1.5°C" = "#FDAE61", "+3.0°C" = "#D73027"), name = "Warming treatment:") +
  labs(fill = "Treatment", y = "log10 abundance 16S rRNA [copies/g OM]", x = "Zone") +
  theme_JM
```

# Step 3: Statistics
## Step 3a: ANOVA on EUB
```{r}
# Remove the root-barrier samples from the dataframe.
df_eub <- df_eub %>% 
  mutate(core_id = paste0(Plot, Subplot)) %>%
  filter(Subplot == "ctr")

stat_model_eub <- lmer(log10_copies ~ Treatment * Zone + (1|core_id), data = df_eub)
stat_res_eub <- Anova(stat_model_eub, type = 3)
stat_emm_eub <- emmeans(stat_model_eub, ~ Treatment | Zone)
stat_pairs_eub <- pairs(stat_emm_eub)

cat("\nANOVA EUB:\n")
print(stat_res_eub)
cat("\nPairwise Comparisons:\n")
print(stat_pairs_eub)
```

# Step 4: Summarise dataframe
```{r}
df_eub_summary <- df_eub %>%
  group_by(Zone, Treatment) %>%
  summarise(
    mean_abundance = mean(log10_copies, na.rm = TRUE),
    se_abundance = sd(log10_copies, na.rm = TRUE)/sqrt(n()),
    n = n(),
    .groups = "drop"
  )
df_eub_summary <- df_eub_summary %>%
  mutate(mean_se = paste0(round(mean_abundance, 2), " ± ", round(se_abundance, 2), " (n=", n, ")"))
print(df_eub_summary)

df_qpcr_sum  <- df_eub  %>%
  mutate(plotid = as.factor(Plot)) %>%
  group_by(plotid) %>%
  summarise("Abundance" = mean(log10_copies, na.rm=TRUE)) %>%
  ungroup()
print(df_qpcr_sum)
```

# References
```{r}
#ggpubr
#Kassambara A (2023). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0, https://rpkgs.datanovia.com/ggpubr/.
```

