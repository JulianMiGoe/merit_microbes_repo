---
title: "qPCR Analysis - Bacterial Abundance (16S rRNA)"
author: "Julian Mittmann-Goetsch"
date: "2025-01-31"
output: html_document
---

## Version 2.1: Updated version log format - 17.07.2025 | JM
## Version 2.0: Unified script structure, English comments, hierarchical naming - 07.07.2025 | JM
## Version 1.1: Streamlined script - 02.06.2025 | JM


# Step 1: Prepare session and load data
## Step 1a: Load necessary packages
```{r}
library(emmeans)
library(ggplot2)
library(ggpubr)
library(here)
library(lme4)
library(performance)
library(tidyverse)
```

## Step 1b: Load qPCR data
```{r}
# Load bacterial abundance data from qPCR analysis
df_eub_0_raw <- read.delim(here("data", "qpcr", "df_copies_EUB.txt"), dec=".", sep="\t")
```

## Step 1c: Define plot theme
```{r message=FALSE, warning=FALSE}
# Global theme for all plots in this analysis
theme_JM <- theme(
  axis.title.x      = element_text(colour = "black", size = 12),
  axis.text.x       = element_text(colour = "black", size = 12), 
  axis.title.y      = element_text(colour = "black", size = 12),
  axis.text.y       = element_text(colour = "black", size = 12), 
  legend.title      = element_text(colour = "black", size = 12),
  legend.text       = element_text(colour = "black", size = 12), 
  legend.position   = "top",
  panel.background  = element_blank(), 
  panel.border      = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key        = element_blank(),
  strip.text.x      = element_text(colour = "black", size = 12),
  strip.text.y      = element_text(colour = "black", size = 12)
)
```

# Step 2: Data preprocessing
## Step 2a: Process and format data
```{r}
# Apply hierarchical naming and factor processing
df_eub_1_processed <- df_eub_0_raw %>%
  mutate(
    Depth = recode_factor(Depth, "0-10" = "0-10 cm", "20-30" = "20-30 cm"),
    Treatment = recode_factor(Treatment, "ambient" = "ambient", "1.5C" = "+1.5°C", "3.0C" = "+3.0°C"),
    Zone = dplyr::recode(Zone, "PZ" = "Pioneer zone", "LM" = "Low marsh", "HM" = "High marsh"),
    Zone = factor(Zone, levels = c("Pioneer zone", "Low marsh", "High marsh")),
    core_id = paste0(Plot, Subplot)
  ) %>%
  filter(Subplot == "ctr")  # Remove root-barrier samples
```

# Step 4: Statistical analysis
## Step 4a: Linear mixed-effects model for bacterial abundance
```{r}
# Fit linear mixed-effects model with treatment and zone interaction
stat_model_eub <- lmer(log10_copies ~ Treatment * Zone + (1|core_id), data = df_eub_1_processed)

# Model diagnostics
cat("Model diagnostics:\n")
print(performance::check_model(stat_model_eub))

# ANOVA results
cat("\nANOVA results:\n")
print(anova(stat_model_eub))

# Model summary
cat("\nModel summary:\n")
print(summary(stat_model_eub))
```

## Step 4b: Post-hoc comparisons
```{r}
# Pairwise comparisons between zones
stat_emm_zones <- emmeans(stat_model_eub, ~ Zone)
stat_pairs_zones <- pairs(stat_emm_zones)

cat("Zone comparisons:\n")
print(stat_pairs_zones)

# Pairwise comparisons between treatments within zones
stat_emm_treatment_zone <- emmeans(stat_model_eub, ~ Treatment | Zone)
stat_pairs_treatment_zone <- pairs(stat_emm_treatment_zone)

cat("\nTreatment comparisons within zones:\n")
print(stat_pairs_treatment_zone)
```

# Step 5: Data summary
## Step 5a: Create summary statistics
```{r}
# Summary by zone and treatment
df_eub_2_summary <- df_eub_1_processed %>%
  group_by(Zone, Treatment) %>%
  summarise(
    mean_abundance = mean(log10_copies, na.rm = TRUE),
    se_abundance = sd(log10_copies, na.rm = TRUE)/sqrt(n()),
    n = n(),
    .groups = "drop"
  ) %>%
  mutate(mean_se = paste0(round(mean_abundance, 2), " ± ", round(se_abundance, 2), " (n=", n, ")"))

cat("Summary statistics by zone and treatment:\n")
print(df_eub_2_summary)

# Summary by plot for export
df_eub_3_plot_summary <- df_eub_1_processed %>%
  mutate(plotid = as.factor(Plot)) %>%
  group_by(plotid) %>%
  summarise(
    Abundance = mean(log10_copies, na.rm = TRUE),
    .groups = "drop"
  )

cat("\nSummary statistics by plot:\n")
print(df_eub_3_plot_summary)

# Export summarized qPCR data for correlation matrix integration
write.csv(df_eub_3_plot_summary, here("data", "qpcr", "df_qpcr_summary.csv"), row.names = FALSE)
```

# Step 6: Visualization
## Step 6a: Bacterial abundance by treatment and zone
```{r}
# Create main qPCR abundance plot
plot_qpcr_abundance <- df_eub_1_processed %>%
  ggplot(aes(x = Treatment, y = log10_copies, fill = Treatment)) +
    geom_boxplot(alpha = 0.7, outlier.shape = NA) +
    geom_jitter(width = 0.3, alpha = 0.6, size = 1.5) +
    scale_fill_manual(values = c("ambient" = "#4575B4", 
                                "+1.5°C" = "#FDAE61", 
                                "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Bacterial abundance", " ", " [", "log"[10], " copies g"^-1, " OM", "]"))) +
    facet_wrap(~ Zone, ncol = 3) +
    theme_JM +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.spacing = unit(1, "lines")
    ) +
    labs(
      title = "Bacterial Abundance Across Warming Treatments",
      subtitle = "16S rRNA gene copies quantified by qPCR",
      x = "Treatment"
    )

print(plot_qpcr_abundance)
```

## Step 6b: Summary statistics plot
```{r}
# Create summary plot with means and standard errors
plot_qpcr_summary <- df_eub_2_summary %>%
  ggplot(aes(x = Treatment, y = mean_abundance, fill = Treatment)) +
    geom_bar(stat = "identity", alpha = 0.8, width = 0.7) +
    geom_errorbar(aes(ymin = mean_abundance - se_abundance,
                      ymax = mean_abundance + se_abundance),
                  width = 0.25, color = "black") +
    scale_fill_manual(values = c("ambient" = "#4575B4", 
                                "+1.5°C" = "#FDAE61", 
                                "+3.0°C" = "#D73027"), 
                     name = "Warming treatment:") +
    scale_y_continuous(name = expression(paste("Mean bacterial abundance", " ", " [", "log"[10], " copies g"^-1, " OM", "]")),
                      expand = c(0, 0)) +
    facet_wrap(~ Zone, ncol = 3) +
    theme_JM +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.spacing = unit(1, "lines")
    ) +
    labs(
      title = "Mean Bacterial Abundance Across Warming Treatments",
      subtitle = "Error bars represent standard error of the mean",
      x = "Treatment"
    )

print(plot_qpcr_summary)
```

## Step 6c: Combined visualization
```{r}
# Create combined plot with both raw data and means
plot_qpcr_combined <- ggarrange(
  plot_qpcr_abundance,
  plot_qpcr_summary,
  ncol = 1,
  heights = c(1.2, 1),
  labels = c("A", "B"),
  font.label = list(size = 16, face = "bold"),
  common.legend = TRUE,
  legend = "bottom"
)

print(plot_qpcr_combined)

print("=== QPCR VISUALIZATION COMPLETED ===")
print("Bacterial abundance plots created in EEA figure style")
```

---

## REVISION DOCUMENTATION - September 2025

### Changes Made During Revision:
1. **Added Step 6: Comprehensive Visualization**
   - Created bacterial abundance plots consistent with EEA figure styling
   - Implemented three visualization types:
     * Boxplots with jitter points showing raw data distribution
     * Summary bar plots with means and standard error bars
     * Combined two-panel layout with shared legend

2. **Style Consistency:**
   - Applied theme_JM for uniform appearance with other analyses
   - Used consistent color palette: #4575B4 (ambient), #FDAE61 (+1.5°C), #D73027 (+3.0°C)
   - Implemented facet_wrap by Zone layout matching EEA plots
   - Added scientific notation for axis labels (log₁₀ copies g⁻¹ OM)

3. **Visualization Features:**
   - Raw data points (jitter) overlaid on boxplots for transparency
   - Mean values with standard error bars for statistical interpretation
   - Rotated x-axis labels (45°) for readability
   - Bottom legend positioning for clean layout

4. **Plot Organization:**
   - Panel A: Distribution plots (boxplot + jitter)
   - Panel B: Summary statistics (barplot + error bars)
   - Combined using ggarrange with consistent labeling

**Rationale**: Enhanced qPCR analysis with comprehensive visualization suite matching established EEA figure standards for manuscript consistency.

*Last modified: September 15, 2025 | JM*


# References
```{r}
# emmeans: Lenth, R. V. (2024). emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version 1.10.2. https://CRAN.R-project.org/package=emmeans
# ggplot2: Wickham, H., Chang, W., Henry, L., Pedersen, T. L., Takahashi, K., Wilke, C., Woo, K., & Yutani, H. (2024). ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. R package version 3.5.1. https://CRAN.R-project.org/package=ggplot2
# ggpubr: Kassambara, A. (2024). ggpubr: 'ggplot2' Based Publication Ready Plots. R package version 0.6.0. https://CRAN.R-project.org/package=ggpubr
# here: Müller, K. & Bryan, J. (2024). here: A Simpler Way to Find Your Files. R package version 1.0.1. https://CRAN.R-project.org/package=here
# lme4: Bates, D., Mächler, M., Bolker, B., & Walker, S. (2024). lme4: Linear Mixed-Effects Models using 'Eigen' and S4. R package version 1.1-35. https://CRAN.R-project.org/package=lme4
# performance: Lüdecke, D., Ben-Shachar, M. S., Patil, I., Waggoner, P., & Makowski, D. (2024). performance: Assessment of Regression Models Performance. R package version 0.10.8. https://CRAN.R-project.org/package=performance
# tidyverse: Wickham, H., Bryan, J., François, R., Henry, L., Müller, K., Pedersen, T. L., & Takahashi, K. (2024). tidyverse: Easily Install and Load the 'Tidyverse'. R package version 2.0.0. https://CRAN.R-project.org/package=tidyverse
```

